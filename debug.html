<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•æ£€æŸ¥é¡µé¢</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .section {
            background: #252526;
            padding: 15px;
            margin: 10px 0;
            border-left: 3px solid #007acc;
        }
        .pass { color: #4ec9b0; }
        .fail { color: #f48771; }
        .info { color: #9cdcfe; }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #005a9e; }
        pre {
            background: #1e1e1e;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” æ¸…è¿ˆæŒ‡å— - è°ƒè¯•æ£€æŸ¥</h1>

    <div class="section">
        <h2>æ­¥éª¤1ï¼šæ£€æŸ¥ç‰ˆæœ¬</h2>
        <button onclick="checkVersion()">æ£€æŸ¥ç‰ˆæœ¬</button>
        <pre id="versionResult">ç­‰å¾…æ£€æŸ¥...</pre>
    </div>

    <div class="section">
        <h2>æ­¥éª¤2ï¼šæ£€æŸ¥ç­›é€‰é€»è¾‘</h2>
        <button onclick="checkFiltering()">æ£€æŸ¥ç­›é€‰</button>
        <pre id="filterResult">ç­‰å¾…æ£€æŸ¥...</pre>
    </div>

    <div class="section">
        <h2>æ­¥éª¤3ï¼šæ£€æŸ¥Tabæ•°æ®</h2>
        <button onclick="checkTabData()">æ£€æŸ¥æ‰€æœ‰Tab</button>
        <pre id="tabResult">ç­‰å¾…æ£€æŸ¥...</pre>
    </div>

    <div class="section">
        <h2>æ­¥éª¤4ï¼šæµ‹è¯•API</h2>
        <button onclick="testAPI()">æµ‹è¯•API</button>
        <pre id="apiResult">ç­‰å¾…æµ‹è¯•...</pre>
    </div>

    <div class="section">
        <h2>å®Œæ•´è¯Šæ–­æŠ¥å‘Š</h2>
        <button onclick="runFullDiagnostics()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
        <pre id="fullResult">ç‚¹å‡»æŒ‰é’®å¼€å§‹...</pre>
    </div>

    <script>
        // æ£€æŸ¥ç‰ˆæœ¬
        function checkVersion() {
            const title = document.title;
            const result = {
                'é¡µé¢æ ‡é¢˜': title,
                'æ˜¯å¦åŒ…å«v2.3': title.includes('v2.3'),
                'æ£€æŸ¥æ—¶é—´': new Date().toLocaleString()
            };
            document.getElementById('versionResult').textContent = JSON.stringify(result, null, 2);
        }

        // æ£€æŸ¥ç­›é€‰é€»è¾‘
        function checkFiltering() {
            fetch('/api/activities')
                .then(r => r.json())
                .then(data => {
                    const all = data.data;

                    // Tab 0 ç­›é€‰
                    const tab0 = all.filter(item => {
                        if (item.category === 'å¸‚é›†') return false;
                        if (item.flexibleTime === 'æ˜¯' || item.time === 'çµæ´»æ—¶é—´') return false;
                        return true;
                    });

                    // Tab 1 ç­›é€‰
                    const tab1 = all.filter(item => item.category === 'å¸‚é›†');

                    // Tab 2 ç­›é€‰
                    const tab2 = all.filter(item => item.flexibleTime === 'æ˜¯' || item.time === 'çµæ´»æ—¶é—´');

                    const result = {
                        'æ€»æ´»åŠ¨æ•°': all.length,
                        'Tab 0 å…´è¶£ç­': tab0.length + 'ä¸ª',
                        'Tab 1 å¸‚é›†': tab1.length + 'ä¸ª',
                        'Tab 2 çµæ´»æ—¶é—´': tab2.length + 'ä¸ª',
                        'æ£€æŸ¥': {
                            'å…´è¶£ç­+å¸‚é›†+çµæ´»æ—¶é—´': (tab0.length + tab1.length + tab2.length) + 'ä¸ª',
                            'æ˜¯å¦ç­‰äºæ€»æ•°': (tab0.length + tab1.length + tab2.length) === all.length
                        }
                    };

                    document.getElementById('filterResult').textContent = JSON.stringify(result, null, 2);
                });
        }

        // æ£€æŸ¥Tabæ•°æ®
        function checkTabData() {
            fetch('/api/activities')
                .then(r => r.json())
                .then(data => {
                    const all = data.data;

                    // å…´è¶£ç­ä¸­çš„å¸‚é›†
                    const tab0 = all.filter(item => {
                        if (item.category === 'å¸‚é›†') return false;
                        if (item.flexibleTime === 'æ˜¯' || item.time === 'çµæ´»æ—¶é—´') return false;
                        return true;
                    });

                    const marketsInTab0 = tab0.filter(item => item.category === 'å¸‚é›†');

                    // å¸‚é›†ä¸­çš„å…´è¶£ç­
                    const tab1 = all.filter(item => item.category === 'å¸‚é›†');

                    const interestInTab1 = tab1.filter(item =>
                        item.category !== 'å¸‚é›†' &&
                        (item.flexibleTime !== 'æ˜¯' && item.time !== 'çµæ´»æ—¶é—´')
                    );

                    const result = {
                        'â“ å…´è¶£ç­Tabä¸­åŒ…å«å¸‚é›†': marketsInTab0.length + 'ä¸ª',
                        'å¸‚é›†åç§°': marketsInTab0.map(m => m.title),
                        'â“ å¸‚é›†Tabä¸­åŒ…å«å…´è¶£ç­': interestInTab1.length + 'ä¸ª',
                        'å…´è¶£ç­åç§°': interestInTab1.map(i => i.title)
                    };

                    document.getElementById('tabResult').textContent = JSON.stringify(result, null, 2);
                });
        }

        // æµ‹è¯•API
        function testAPI() {
            fetch('/api/activities')
                .then(r => r.json())
                .then(data => {
                    const result = {
                        'APIçŠ¶æ€': 'æ­£å¸¸',
                        'è¿”å›æ´»åŠ¨æ•°': data.data.length,
                        'å“åº”æ—¶é—´': new Date().toLocaleString()
                    };
                    document.getElementById('apiResult').textContent = JSON.stringify(result, null, 2);
                })
                .catch(err => {
                    document.getElementById('apiResult').textContent = 'APIé”™è¯¯: ' + err.message;
                });
        }

        // å®Œæ•´è¯Šæ–­
        async function runFullDiagnostics() {
            const results = {
                '=== æ­¥éª¤1ï¼šç‰ˆæœ¬æ£€æŸ¥ ===': {},
                '=== æ­¥éª¤2ï¼šAPIæ£€æŸ¥ ===': {},
                '=== æ­¥éª¤3ï¼šæ•°æ®ç­›é€‰æ£€æŸ¥ ===': {},
                '=== æ­¥éª¤4ï¼šæ•°æ®éš”ç¦»æ£€æŸ¥ ===': {},
                '=== ç»“è®º ===': {}
            };

            // æ­¥éª¤1
            results['=== æ­¥éª¤1ï¼šç‰ˆæœ¬æ£€æŸ¥ ==='] = {
                'é¡µé¢æ ‡é¢˜': document.title,
                'æ˜¯å¦v2.3': document.title.includes('v2.3')
            };

            // æ­¥éª¤2
            try {
                const response = await fetch('/api/activities');
                const data = await response.json();
                results['=== æ­¥éª¤2ï¼šAPIæ£€æŸ¥ ==='] = {
                    'APIçŠ¶æ€': 'âœ… æ­£å¸¸',
                    'æ´»åŠ¨æ€»æ•°': data.data.length
                };

                const all = data.data;

                // æ­¥éª¤3
                const tab0 = all.filter(item => {
                    if (item.category === 'å¸‚é›†') return false;
                    if (item.flexibleTime === 'æ˜¯' || item.time === 'çµæ´»æ—¶é—´') return false;
                    return true;
                });
                const tab1 = all.filter(item => item.category === 'å¸‚é›†');
                const tab2 = all.filter(item => item.flexibleTime === 'æ˜¯' || item.time === 'çµæ´»æ—¶é—´');

                results['=== æ­¥éª¤3ï¼šæ•°æ®ç­›é€‰æ£€æŸ¥ ==='] = {
                    'Tab 0 å…´è¶£ç­': tab0.length + 'ä¸ª',
                    'Tab 1 å¸‚é›†': tab1.length + 'ä¸ª',
                    'Tab 2 çµæ´»æ—¶é—´': tab2.length + 'ä¸ª',
                    'é¢„æœŸ': 'Tab 0: 21, Tab 1: 17, Tab 2: 9',
                    'åŒ¹é…': tab0.length === 21 && tab1.length === 17 && tab2.length === 9
                };

                // æ­¥éª¤4
                const marketsInTab0 = tab0.filter(i => i.category === 'å¸‚é›†');
                const interestInTab1 = tab1.filter(i =>
                    i.category !== 'å¸‚é›†' &&
                    (i.flexibleTime !== 'æ˜¯' && i.time !== 'çµæ´»æ—¶é—´')
                );

                results['=== æ­¥éª¤4ï¼šæ•°æ®éš”ç¦»æ£€æŸ¥ ==='] = {
                    'å…´è¶£ç­ä¸­åŒ…å«å¸‚é›†': marketsInTab0.length > 0 ? 'âŒ æ˜¯' : 'âœ… å¦',
                    'å¸‚é›†ä¸­åŒ…å«å…´è¶£ç­': interestInTab1.length > 0 ? 'âŒ æ˜¯' : 'âœ… å¦'
                };

                // ç»“è®º
                const allPass =
                    results['=== æ­¥éª¤3ï¼šæ•°æ®ç­›é€‰æ£€æŸ¥ ==='].åŒ¹é… &&
                    results['=== æ­¥éª¤4ï¼šæ•°æ®éš”ç¦»æ£€æŸ¥ ===']['å…´è¶£ç­ä¸­åŒ…å«å¸‚é›†'] === 'âœ… å¦';

                results['=== ç»“è®º ==='] = {
                    'æ•´ä½“çŠ¶æ€': allPass ? 'âœ… å…¨éƒ¨é€šè¿‡' : 'âŒ æœ‰é—®é¢˜',
                    'å»ºè®®': allPass ? 'æ•°æ®æ­£ç¡®ï¼Œé—®é¢˜å¯èƒ½æ˜¯æµè§ˆå™¨ç¼“å­˜' : 'æ•°æ®ç­›é€‰é€»è¾‘æœ‰é—®é¢˜'
                };

            } catch (error) {
                results['=== æ­¥éª¤2ï¼šAPIæ£€æŸ¥ ==='] = {
                    'APIçŠ¶æ€': 'âŒ é”™è¯¯',
                    'é”™è¯¯ä¿¡æ¯': error.message
                };
            }

            document.getElementById('fullResult').textContent = JSON.stringify(results, null, 2);
        }
    </script>
</body>
</html>
