name: æ¯æ—¥è‡ªåŠ¨æäº¤å’Œæµ‹è¯•

on:
  # æ¯å¤©0ç‚¹ï¼ˆUTCæ—¶é—´16:00 = æ³°å›½æ—¶é—´0:00ï¼‰
  schedule:
    - cron: '0 16 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # å½“æœ‰pushåˆ°mainåˆ†æ”¯æ—¶ä¹Ÿè§¦å‘ï¼ˆç”¨äºCI/CDï¼‰
  push:
    branches: [ main ]

  # å½“æœ‰PRæ—¶è§¦å‘
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: è¿è¡Œæµ‹è¯•
  test:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: å®‰è£…ä¾èµ–
      run: |
        if [ -f package.json ]; then
          npm ci
        fi

    - name: å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
      run: |
        npm start &
        echo "ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨..."
        sleep 5
        curl -s http://localhost:3000/api/health || exit 1

    - name: è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
      run: |
        echo "è¿è¡Œæ‰€æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•..."
        chmod +x run-all-automated-tests.sh
        ./run-all-automated-tests.sh

    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      if: always()
      run: |
        echo "## ğŸ§ª æµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… éŸ³ä¹TabåŠŸèƒ½æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ—¶é—´æ’åºåŠŸèƒ½æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… APIç«¯ç‚¹æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… åˆ†ç±»ç­›é€‰æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æµ‹è¯•è¦†ç›–ç‡**: æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²è¦†ç›–" >> $GITHUB_STEP_SUMMARY

  # Job 2: æ£€æŸ¥ä»£ç å˜æ›´
  check-changes:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3

    - name: æ£€æŸ¥æœªæäº¤çš„æ›´æ”¹
      run: |
        echo "## ä»£ç å˜æ›´æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "æ£€æŸ¥æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âš ï¸ GitHub Actionsæ— æ³•ç›´æ¥è®¿é—®æœ¬åœ°æœªæäº¤çš„æ›´æ”¹" >> $GITHUB_STEP_SUMMARY
        echo "æ­¤æ£€æŸ¥éœ€è¦åœ¨æœ¬åœ°è¿è¡Œè‡ªåŠ¨æäº¤è„šæœ¬" >> $GITHUB_STEP_SUMMARY

  # Job 3: ç”Ÿæˆæ¯æ—¥æŠ¥å‘Š
  daily-report:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3

    - name: ç”Ÿæˆæ¯æ—¥æŠ¥å‘Š
      run: |
        echo "# æ¯æ—¥è‡ªåŠ¨æäº¤æŠ¥å‘Š" > daily-report.md
        echo "" >> daily-report.md
        echo "**ç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> daily-report.md
        echo "" >> daily-report.md
        echo "## ä»£ç çŠ¶æ€" >> daily-report.md
        echo "- æœ€æ–°æäº¤: $(git log -1 --pretty=format:'%h - %s')" >> daily-report.md
        echo "- æäº¤æ—¶é—´: $(git log -1 --pretty=format:'%ad')" >> daily-report.md
        echo "" >> daily-report.md
        echo "## å»ºè®®" >> daily-report.md
        echo "1. æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹" >> daily-report.md
        echo "2. è¿è¡Œæµ‹è¯•éªŒè¯åŠŸèƒ½" >> daily-report.md
        echo "3. å¦‚æœæœ‰é‡è¦æ›´æ–°ï¼Œè¯·æ‰‹åŠ¨æäº¤" >> daily-report.md
        echo "" >> daily-report.md
        cat daily-report.md

    - name: ä¸Šä¼ æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: daily-report
        path: daily-report.md
