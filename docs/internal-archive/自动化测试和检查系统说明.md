# 🎯 自动化测试和检查系统 - 使用指南

> 每次修改代码 → 自动测试 → 发现异常 → 自动修复

---

## 📁 已创建的文件

### 1. 测试脚本

| 文件 | 用途 | 何时使用 |
|------|------|---------|
| `test-all.sh` | 基础测试（数据联动） | 验证 CRUD 操作 |
| `test-enhanced-fixed.sh` | **增强版测试（推荐）** | **每次修改后运行** |
| `quick-check.sh` | 快速手动检查 | 随时手动检查 |

### 2. 定时检查系统

| 文件 | 用途 |
|------|------|
| `daily-check.sh` | 定时检查脚本（带对话框） |
| `install-daily-check.sh` | **一键安装定时系统** |
| `com.chiangmai.dailycheck.plist` | macOS 定时任务配置 |

### 3. 文档

| 文件 | 内容 |
|------|------|
| `.claude/test-protocol.md` | 测试协议 |
| `docs/定时检查系统设置.md` | 详细设置说明 |

---

## 🚀 快速开始

### 方式1：安装定时检查系统（推荐）

```bash
cd /Users/yuzhoudeshengyin/Documents/my_project/Chiengmai
./install-daily-check.sh
```

**效果**：
- ✅ 每天 10:00 自动提醒
- ✅ 询问是否要检查
- ✅ 自动运行测试
- ✅ 显示结果通知

### 方式2：手动运行测试

```bash
# 运行完整测试
python3 test-enhanced-fixed.sh

# 或使用快捷脚本
./quick-check.sh
```

---

## 🔄 工作流程

### 每次修改代码后

```
1. 修改代码
   ↓
2. 保存文件
   ↓
3. 自动运行测试
   python3 test-enhanced-fixed.sh
   ↓
4. 查看测试结果
   ↓
5a. 全部通过 ✅ → 完成
5b. 有失败 ❌ → 查看建议 → 修复 → 重新测试
```

### 每天自动检查

```
10:00 AM
   ↓
弹出对话框
   ↓
选择"立即检查"
   ↓
自动运行测试
   ↓
显示结果通知
   ↓
查看日志了解详情
```

---

## 📊 测试覆盖内容

### 主页功能
- ✅ 页面可访问
- ✅ React 根容器存在
- ✅ JavaScript 脚本加载
- ✅ 后端数据 API 可访问

### 日历页面功能
- ✅ 页面可访问
- ✅ React 根容器存在
- ✅ 活动数据 API 可访问

### 管理后台功能
- ✅ 页面可访问
- ✅ 独立 HTML 页面
- ✅ 表单元素存在

### API 端点
- ✅ 活动列表 API
- ✅ 所有数据 API
- ✅ 返回数据量统计

### 数据一致性
- ✅ 必要字段检查
- ✅ 数据格式验证
- ✅ 前 5 条活动抽查

---

## 🎨 测试结果示例

### 全部通过

```
总测试数: 5
通过: 5
失败: 0
成功率: 100.0%

🎉 所有测试通过！系统运行正常！
✅ 主页功能正常
✅ 日历页面功能正常
✅ 管理后台功能正常
✅ API端点正常
✅ 数据一致性良好
```

### 有失败时

```
总测试数: 5
通过: 3
失败: 2
成功率: 60.0%

⚠️ 有 2 个测试失败

💡 修复建议:
• 缺少React根容器
  建议: 检查 index.html 和 src/main.jsx
• API不可访问
  建议: 检查 server.js，确保后端服务运行
```

---

## 📝 日志文件

### 日志位置

```
logs/
├── daily-check-20250125.log      # 每日检查记录
├── daily-check.log                # 系统输出
└── daily-check-error.log          # 错误日志
```

### 查看日志

```bash
# 今天的检查记录
cat logs/daily-check-$(date +%Y%m%d).log

# 实时监控
tail -f logs/daily-check.log

# 最近 7 天的检查
ls -lt logs/daily-check-*.log | head -7
```

---

## 🔧 常用命令

### 测试相关

```bash
# 运行完整测试
python3 test-enhanced-fixed.sh

# 快速检查
./quick-check.sh

# 基础测试
python3 test-all.sh
```

### 定时任务相关

```bash
# 安装定时系统
./install-daily-check.sh

# 查看任务状态
launchctl list | grep chiangmai

# 停止定时任务
launchctl unload ~/Library/LaunchAgents/com.chiangmai.dailycheck.plist

# 重新启动定时任务
launchctl load ~/Library/LaunchAgents/com.chiangmai.dailycheck.plist
```

### 日志相关

```bash
# 查看今天的日志
cat logs/daily-check-$(date +%Y%m%d).log

# 清理旧日志（保留最近30天）
find logs -name "daily-check-*.log" -mtime +30 -delete
```

---

## 🎯 最佳实践

### 开发时

1. **修改代码后立即测试**
   ```bash
   # 修改代码
   vim src/pages/Schedule.jsx

   # 保存后立即测试
   python3 test-enhanced-fixed.sh
   ```

2. **修复失败后再测试**
   - 不要在失败状态下继续开发
   - 确保所有测试通过

3. **查看详细日志**
   - 测试失败时查看完整日志
   - 找到根本原因

### 日常使用

1. **每天检查**
   - 10:00 收到提醒后点击"立即检查"
   - 查看测试结果

2. **发现问题及时修复**
   - 不要累积问题
   - 小问题容易修复

3. **定期清理日志**
   - 每月清理一次旧日志
   - 只保留重要的记录

---

## 💡 提示和技巧

### 1. 快速测试单个功能

如果只关心某个功能，可以修改测试脚本只运行该测试。

### 2. 调整测试时间

编辑 `com.chiangmai.dailycheck.plist` 中的时间：
```xml
<key>Hour</key>
<integer>10</integer>  <!-- 改成您想要的时间 -->
```

### 3. 添加自定义测试

在 `test-enhanced-fixed.sh` 中添加新的测试函数。

### 4. 集成到 CI/CD

可以将测试脚本集成到 CI/CD 流程中，每次提交自动运行。

---

## 🆘 故障排除

### 问题：测试失败但系统看起来正常

**可能原因**：服务器未启动或端口冲突

**解决方案**：
```bash
# 检查端口
lsof -i :5173  # 前端
lsof -i :3000  # 后端

# 重启服务
npm run dev
```

### 问题：定时任务没有运行

**可能原因**：LaunchAgent 未正确加载

**解决方案**：
```bash
# 重新安装
./install-daily-check.sh

# 或手动加载
launchctl load ~/Library/LaunchAgents/com.chiangmai.dailycheck.plist
```

### 问题：对话框没有弹出

**可能原因**：macOS 通知权限未开启

**解决方案**：
1. 系统设置 → 通知
2. 找到"脚本编辑器"
3. 允许通知

---

## 📞 获取帮助

- 📖 查看文档：`docs/定时检查系统设置.md`
- 🔍 查看日志：`logs/daily-check-*.log`
- 🧪 运行测试：`python3 test-enhanced-fixed.sh`

---

**版本**：1.0
**最后更新**：2025-01-25
