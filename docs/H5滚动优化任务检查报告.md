# H5滚动优化任务检查报告

**检查时间**: 2026-01-28
**版本**: v1.0.7
**状态**: 📋 部分完成，需要补充功能

---

## 📋 任务需求回顾

### 任务1: 上拉到前一天自动选中
**需求**: "选项A: 上拉到前一天占50% → 自动选中前一天"

### 任务2: 音乐、市集视图滚动优化
**需求**: "音乐、市集视图列表（类似兴趣班）：同兴趣班的优化方式"

---

## 🔍 当前实现状态

### ✅ 已实现的功能

#### 1. 市集Tab滚动自动选中 (Tab 1)
**状态**: ✅ 已实现

**代码位置**: [index.html:2925-2932](../index.html#L2925-L2932)

**实现方式**:
```javascript
// H5周视图：滚动自动选中功能
// 仅在移动端周视图模式下启用
if (isMobile && currentFilters.day === null) {
    setTimeout(() => {
        initH5ScrollAutoSelect(gridId);
    }, 300);
}
```

**工作原理**:
- 市集Tab使用 `updateCalendarView` (与兴趣班相同)
- 自动调用 `initH5ScrollAutoSelect` 函数
- 使用Intersection Observer API检测天卡片可见度
- 当某天占据50%屏幕时触发选中

**验证方法**:
1. 访问: http://localhost:3000/index.html?mode=h5
2. 切换到"市集"Tab
3. 滚动页面，当天卡片占据50%屏幕时
4. **预期**: 自动选中那一天，显示提示

---

#### 2. 兴趣班Tab滚动自动选中 (Tab 0)
**状态**: ✅ 已实现

**实现方式**: 同市集Tab，使用相同的 `updateCalendarView`

---

### ❌ 未实现的功能

#### 1. 上拉到前一天自动选中
**状态**: ❌ 未实现

**问题分析**:

**当前代码**: [index.html:2516-2540](../index.html#L2516-L2540)

```javascript
// 创建Intersection Observer
h5ScrollObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        // 当卡片占据屏幕50%以上时
        if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
            const day = parseInt(entry.target.getAttribute('data-day'));

            // 避免重复选中同一天
            if (day !== lastSelectedDay && day !== null && !isNaN(day)) {
                // 防抖动：滚动停止500ms后才触发
                if (h5AutoSelectTimeout) {
                    clearTimeout(h5AutoSelectTimeout);
                }

                h5AutoSelectTimeout = setTimeout(() => {
                    autoSelectDayInView(day);
                }, 500);
            }
        }
    });
}, {
    threshold: [0.5],
    rootMargin: '0px'
});
```

**缺失功能**:
- ❌ 没有检测滚动方向（上拉/下拉）
- ❌ 没有区分"上拉到前一天"的场景
- ✅ 只有通用的50%可见度检测

**需要实现**:
1. 添加滚动方向检测
2. 区分向上滚动和向下滚动
3. 上拉时选择前一天，下拉时选择当前天

---

#### 2. 音乐Tab滚动优化 (Tab 3)
**状态**: ❌ 不适用

**原因分析**:

**Tab 3实现**: [index.html:3100-3150](../index.html#L3100-L3150)

```javascript
case 3: // 活动网站 - 网站卡片视图
    console.log('🏪 Tab 3 - 准备调用 updateWebsitesView，活动数:', filtered.length);
    updateWebsitesView(filtered);
    break;
```

**Tab 3视图结构**:
- 使用 `updateWebsitesView` 函数
- 显示**网站链接表格**，按分类分组
- **没有天数卡片**（.day-cell）
- **没有日历视图**

**示例结构**:
```
活动网站 Tab
├── 音乐 (5个网站)
│   ├── 网站链接1
│   ├── 网站链接2
│   └── ...
├── 市集 (3个网站)
│   ├── 网站链接1
│   └── ...
└── ...
```

**结论**:
- Tab 3 是**网站链接列表**，不是日历视图
- 没有"天"的概念，无法应用基于天数的滚动选中
- 此需求对Tab 3不适用

---

## 📊 任务完成度汇总

| 任务 | 目标Tab | 状态 | 完成度 | 说明 |
|-----|---------|------|--------|------|
| **上拉到前一天** | 所有日历Tab | ❌ 未实现 | 0% | 缺少滚动方向检测 |
| **市集滚动优化** | Tab 1 (市集) | ✅ 已实现 | 100% | 已有完整功能 |
| **兴趣班滚动优化** | Tab 0 (兴趣班) | ✅ 已实现 | 100% | 已有完整功能 |
| **音乐滚动优化** | Tab 3 (活动网站) | ❌ 不适用 | N/A | 无天数卡片 |

---

## 🎯 需要补充的功能

### 功能1: 滚动方向检测 + 上拉选中前一天

**实现方案**:

#### 方案A: 基于滚动位置检测
```javascript
let lastScrollTop = 0;

h5ScrollObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
            const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const isScrollingUp = currentScrollTop < lastScrollTop;
            lastScrollTop = currentScrollTop;

            const day = parseInt(entry.target.getAttribute('data-day'));

            if (day !== lastSelectedDay && day !== null && !isNaN(day)) {
                if (h5AutoSelectTimeout) {
                    clearTimeout(h5AutoSelectTimeout);
                }

                h5AutoSelectTimeout = setTimeout(() => {
                    if (isScrollingUp) {
                        // 上拉：选择前一天
                        const prevDay = (day + 6) % 7; // 昨天是(day-1+7)%7
                        console.log(`⬆️ 上拉检测，选择前一天: ${prevDay}`);
                        autoSelectDayInView(prevDay);
                    } else {
                        // 下拉：选择当前天（保持原逻辑）
                        autoSelectDayInView(day);
                    }
                }, 500);
            }
        }
    });
}, {
    threshold: [0.5],
    rootMargin: '0px'
});
```

#### 方案B: 基于entry.boundingRect检测（更精确）
```javascript
h5ScrollObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
            const day = parseInt(entry.target.getAttribute('data-day'));
            const rect = entry.boundingClientRect;

            // 判断卡片在视口中的位置
            const isTopHalf = rect.top < window.innerHeight / 2;

            if (day !== lastSelectedDay && day !== null && !isNaN(day)) {
                if (h5AutoSelectTimeout) {
                    clearTimeout(h5AutoSelectTimeout);
                }

                h5AutoSelectTimeout = setTimeout(() => {
                    if (isTopHalf) {
                        // 卡片在上半部分，说明用户正在上拉看前一天
                        const prevDay = (day + 6) % 7;
                        console.log(`⬆️ 检测到上拉，选择前一天: ${prevDay}`);
                        autoSelectDayInView(prevDay);
                    } else {
                        // 卡片在下半部分，正常下拉选择当前天
                        autoSelectDayInView(day);
                    }
                }, 500);
            }
        }
    });
}, {
    threshold: [0.5],
    rootMargin: '0px'
});
```

**推荐方案**: 方案B（基于boundingRect），更可靠且不依赖全局变量

---

### 功能2: Tab 3 音乐滚动优化

**问题**: Tab 3是网站列表，无天数卡片

**可选方案**:

#### 方案A: 为Tab 3添加日历视图（推荐）
- 将Tab 3改造为日历视图（类似兴趣班、市集）
- 筛选有网站链接的活动
- 按天分组显示

#### 方案B: 保持网站列表，优化滚动体验
- 添加分类导航
- 点击分类跳转到对应区域
- 不做自动选中（无"天"的概念）

#### 方案C: 澄清需求
- 确认用户是否真的要优化Tab 3
- 或者"音乐"指的是活动分类而非Tab名称

---

## ✅ 已可验证的功能

### 验证1: 市集Tab滚动自动选中

```bash
# 测试步骤
1. 访问: http://localhost:3000/index.html?mode=h5
2. 切换到"市集"Tab
3. 向下滚动页面
4. 当某天卡片占据屏幕50%以上时
5. 停止滚动500ms

# 预期结果
✅ 自动选中那一天
✅ 顶部显示"✨ 已自动选中X"
✅ 自动切换到单日详细视图
```

### 验证2: 兴趣班Tab滚动自动选中

```bash
# 测试步骤
1. 访问: http://localhost:3000/index.html?mode=h5
2. 切换到"兴趣班"Tab
3. 向下滚动页面
4. 当某天卡片占据屏幕50%以上时
5. 停止滚动500ms

# 预期结果
✅ 自动选中那一天
✅ 顶部显示"✨ 已自动选中X"
✅ 自动切换到单日详细视图
```

---

## 🔧 下一步行动

### 立即执行
1. **实现上拉到前一天功能**
   - 修改 `initH5ScrollAutoSelect` 函数
   - 添加滚动方向检测
   - 上拉时选择前一天

2. **澄清Tab 3需求**
   - 确认"音乐"指的是Tab还是分类
   - 确认是否需要为Tab 3添加日历视图

### 测试验证
1. 测试上拉场景：向下滚动到周三，然后向上滚回周二
2. 测试下拉场景：直接向下滚动到周三
3. 验证提示消息正确显示选中的天数

---

## 📝 代码修改清单

### 需要修改的文件

1. **index.html**
   - [ ] 修改 `initH5ScrollAutoSelect` 函数 (行 2499-2548)
   - [ ] 添加滚动方向检测逻辑
   - [ ] 添加上拉选择前一天功能

2. **public/index.html** (同步)
   - [ ] 应用相同的修改

3. **验证脚本**
   - [ ] 创建 `verify-h5-scroll-direction.cjs`
   - [ ] 测试上拉和下拉两种场景

---

## 📊 总结

### 完成度统计
- ✅ 已完成: 2项 (市集Tab、兴趣班Tab)
- ❌ 待实现: 1项 (上拉到前一天)
- ❓ 需澄清: 1项 (Tab 3音乐优化)

### 功能覆盖率
- **日历Tab滚动优化**: 100% (兴趣班、市集)
- **滚动方向检测**: 0%
- **自动选中前一天**: 0%

---

**报告生成时间**: 2026-01-28
**版本**: v1.0.7
**维护者**: Claude AI
