# Excel 导入优化功能总结

## ✅ 已实现的优化

### 1. Excel 内部重复检测 🔴 高优先级

**功能**：导入前自动检测 Excel 中同一个活动编号是否多次出现

**实现逻辑**：
```javascript
// 检测重复的活动编号
0001 出现 3 次（行: 2, 15, 28）
  - 行 2: 瑜伽课A
  - 行 15: 瑜伽课B
  - 行 28: 瑜伽课C

✅ 自动策略：保留最后一个（行 28）
```

**日志输出**：
```
⚠️ 发现 2 个活动编号在 Excel 内部重复：
   📌 活动编号 0001:
      行 2: 瑜伽课A
      行 15: 瑜伽课B
      行 28: 瑜伽课C
      ✅ 策略：保留最后一个（行 28）

✅ 已自动去重：删除了 2 条重复记录
   保留记录数：95 / 97
```

---

### 2. 字段级变更检测 🔴 高优先级

**功能**：详细显示哪些字段发生了变化

**实现示例**：
```
更新: 15 条（有字段变更）

📝 字段级变更详情:
   0001: 清迈流瑜伽早课
      - 价格: "500฿" → "600฿"
      - 时间: "09:00-10:30" → "09:00-11:00"
   0002: 语言交换
      - 地点: "Moat House" → "Moat House 2F"
```

**对比字段**：
- 标题 (title)
- 分类 (category)
- 地点 (location)
- 价格 (price)
- 时间 (time)
- 星期 (weekdays)

---

### 3. 智能合并策略 🔴 高优先级

**功能**：Excel 空值保留后台原数据

**问题示例**：
```
Excel 数据：
0001 - 标题: "瑜伽课", 价格: "", 时间: "09:00-10:30"

后台旧数据：
0001 - 标题: "流瑜伽早课", 价格: "500฿", 时间: "09:00-10:30"

❌ 旧逻辑（覆盖模式）：
  价格变为空，丢失了 500฿ 的信息

✅ 新逻辑（智能保留）：
  价格保留后台原值 "500฿"
  标题和时间更新为 Excel 的新值
```

**保留规则**：
- 如果 Excel 字段为空、null、undefined、"-"、"N/A"、"待确认"
- 则保留后台原数据
- 否则使用 Excel 的新值

**日志输出**：
```
💡 智能合并: Excel 中的 12 个空值字段已保留后台原数据
```

---

## 📊 完整的导入日志示例

```log
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
步骤4: 字段映射和数据转换
✅ 数据映射完成:
   成功: 100 条
   跳过: 0 条
   错误: 0 条

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
步骤4.5: Excel 内部重复检测
⚠️ 发现 2 个活动编号在 Excel 内部重复：
   📌 活动编号 0001:
      行 2: 瑜伽课（旧版）
      行 25: 瑜伽课（更新版）
      ✅ 策略：保留最后一个（行 25）
   📌 活动编号 0015:
      行 10: 泰拳体验
      行 50: 泰拳体验课
      ✅ 策略：保留最后一个（行 50）

✅ 已自动去重：删除了 2 条重复记录
   保留记录数：98 / 100

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
步骤5: 数据验证
✅ 验证通过: 所有数据格式正确

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
步骤6: 基于活动编号去重并生成变更报告
📊 变更统计（基于活动编号）:
   新增: 5 条
   删除: 2 条
   更新: 15 条（有字段变更）
   未变更: 76 条（内容相同）

➕ 新增活动:
   - 0096: 周末市集
   - 0097: 泰式料理课
   - 0098: 攀岩体验
   - 0099: 水上运动
   - 0100: 文化之旅

➖ 删除活动:
   - 0088: 已结束的活动A
   - 0095: 已结束的活动B

✓ 内容未变更（已保留）:
   - 0001: 清迈流瑜伽
   - 0002: 冥想课程
   ...

📝 字段级变更详情:
   0001: 清迈流瑜伽早课
      - 价格: "500฿" → "600฿"
      - 时间: "09:00-10:30" → "09:00-11:00"
   0003: 语言交换
      - 地点: "Moat House" → "Moat House 2F"
   0012: 泰拳训练
      - 价格: "400฿" → "450฿"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
步骤7: 智能合并数据并保存
💡 智能合并: Excel 中的 8 个空值字段已保留后台原数据
✅ 数据已保存到: data/items.json

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✨ 导入完成！

📊 导入摘要（基于活动编号去重）:
   总记录: 98 条
   新增: 5 条
   删除: 2 条
   更新: 15 条（有字段变更）
   未变更: 76 条（内容相同）
   备份: backup-2025-01-26T10-30-45.xlsx

⚠️ 注意: 2 个活动编号有内部重复，已自动保留最后一次出现

💡 提示:
   - 相同活动编号的记录已自动更新为Excel中的最新数据
   - Excel 空值会自动保留后台原数据（智能合并）
   - 详细变更日志已保存，可查看具体哪些字段发生了变化
```

---

## 🎯 如何使用

### 方式 1：通过后台管理界面
1. 访问 http://localhost:5173/admin.html
2. 点击 "📥 导入Excel" 按钮
3. 确认导入

### 方式 2：通过命令行
```bash
node scripts/import-excel-enhanced.mjs
```

### 方式 3：通过 npm 脚本
```bash
npm run import-excel
```

---

## 📝 注意事项

### Excel 文件要求
1. **必填列**：活动编号、活动标题、分类
2. **活动编号**：必须唯一，不可重复
3. **文件名**：必须是 `清迈活动数据.xlsx`

### 导入前检查
1. ✅ 确保 Excel 文件已保存
2. ✅ 检查活动编号是否唯一
3. ✅ 检查必填字段是否完整
4. ✅ 确认空值字段是否需要保留后台原数据

### 导入后验证
1. 查看日志确认变更内容
2. 在后台管理界面检查数据
3. 访问前端页面验证显示

---

## 🔄 备份与恢复

### 自动备份
- 每次导入前自动备份 Excel 文件
- 备份位置：`backups/backup-{timestamp}.xlsx`

### 日志文件
- 位置：`logs/import-{timestamp}.log`
- 包含完整的变更记录和错误信息

### 回滚方法
如果导入后发现错误：
1. 从 `backups/` 目录找到最新的备份文件
2. 重命名为 `清迈活动数据.xlsx`
3. 重新导入

---

## 🚀 未来可扩展的优化

### 优先级：中
- [ ] 预览确认机制（导入前显示变更预览）
- [ ] 冲突解决配置文件（自定义保留策略）

### 优先级：低
- [ ] 数据版本历史追踪
- [ ] 增量导入（只导入变更的记录）
- [ ] 交互式冲突解决（导入时询问用户）
