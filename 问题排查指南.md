# 草稿功能问题排查指南

## ✅ 已修复的问题

### 问题描述
"保存为草稿"按钮点击后没有反应或功能异常

### 根本原因
原 `submitFormAsDraft()` 函数使用 `dispatchEvent` 触发表单提交时，事件处理不可靠。

### 修复方案
使用全局变量 `isSavingDraft` 标记草稿保存状态：

```javascript
// 新增全局标记
let isSavingDraft = false;

// 修复后的函数
function submitFormAsDraft() {
    isSavingDraft = true; // 设置标记
    document.getElementById('status').value = 'draft'; // 设置状态
    document.getElementById('dataForm').dispatchEvent(new Event('submit'));
}

// 表单提交处理
document.getElementById('dataForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    // 检查草稿标记
    if (isSavingDraft) {
        document.getElementById('status').value = 'draft';
    }

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    // 重置标记
    isSavingDraft = false;

    // ... 继续处理
});
```

## 🧪 功能验证清单

### ✅ 已通过的验证
- ✅ API 服务正常 (http://localhost:3000/api/health)
- ✅ submitFormAsDraft 函数存在
- ✅ isSavingDraft 变量存在
- ✅ getStatusText 函数存在
- ✅ 保存为草稿按钮存在
- ✅ 所有状态选项存在 (draft, pending, ongoing, expired)
- ✅ 状态样式定义完整

## 🔍 如果功能仍然不工作

### 步骤 1: 清除浏览器缓存
```
1. 打开浏览器开发者工具 (F12)
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"
```

### 步骤 2: 检查 JavaScript 控制台
```
1. 打开 http://localhost:3000/admin.html
2. 打开浏览器开发者工具 (F12)
3. 切换到 Console 标签
4. 点击"保存为草稿"按钮
5. 查看是否有红色错误信息
```

### 步骤 3: 验证服务器运行
```bash
# 检查服务器是否运行
curl http://localhost:3000/api/health

# 预期输出:
# {"success":true,"message":"API is running",...}
```

### 步骤 4: 手动测试功能流程

#### 测试 A: 创建草稿活动
1. 访问 http://localhost:3000/admin.html
2. 点击"新增活动"按钮
3. 填写：
   - 标题: `测试草稿活动`
   - 描述: `这是一个测试`
   - 状态: 保持默认的"草稿"
4. 点击"📝 保存为草稿"按钮
5. ✅ 应该弹出提示: "✅ 草稿创建成功"

#### 测试 B: 验证状态筛选
1. 在页面顶部找到状态下拉框
2. 选择"草稿"
3. ✅ 表格应该显示刚创建的草稿活动
4. 选择"待开始"
5. ✅ 表格应该不显示草稿活动

#### 测试 C: 编辑并发布
1. 找到刚创建的草稿活动
2. 点击"编辑"按钮
3. 修改状态为"待开始"
4. 点击"💾 保存"按钮
5. ✅ 应该弹出提示: "✅ 活动更新成功"
6. 使用状态筛选验证状态已更新

## 🐛 常见错误与解决方案

### 错误 1: 点击按钮无反应
**症状**: 点击"保存为草稿"按钮没有任何反应

**可能原因**:
- JavaScript 加载失败
- 函数未正确绑定

**解决方案**:
```bash
# 1. 重启服务器
lsof -ti:3000 | xargs kill -9
npm start

# 2. 清除浏览器缓存并刷新
```

### 错误 2: 提示"保存失败"
**症状**: 点击保存后弹出"保存失败"提示

**可能原因**:
- 服务器未运行
- API 端点错误

**解决方案**:
```bash
# 检查服务器状态
curl http://localhost:3000/api/health

# 如果失败，重启服务器
npm start
```

### 错误 3: 状态未更新
**症状**: 保存后状态没有改变

**可能原因**:
- isSavingDraft 标记未正确设置
- 表单未正确读取状态值

**解决方案**:
1. 打开浏览器控制台
2. 在 `submitFormAsDraft` 函数中添加日志：
```javascript
function submitFormAsDraft() {
    console.log('保存为草稿被调用');
    isSavingDraft = true;
    console.log('isSavingDraft 设置为:', isSavingDraft);
    document.getElementById('status').value = 'draft';
    console.log('状态设置为:', document.getElementById('status').value);
    document.getElementById('dataForm').dispatchEvent(new Event('submit'));
}
```

### 错误 4: 状态显示不正确
**症状**: 表格中显示的状态不是中文

**可能原因**:
- `getStatusText()` 函数未正确调用

**检查**:
```javascript
// 在表格渲染函数中检查
<td><span class="status-badge status-${item.status}">${getStatusText(item.status)}</span></td>
```

## 📞 获取帮助

如果以上方法都无法解决问题，请提供以下信息：

1. **浏览器控制台截图**
   - 打开 F12 开发者工具
   - 切换到 Console 标签
   - 截图所有错误信息

2. **网络请求截图**
   - 打开 F12 开发者工具
   - 切换到 Network 标签
   - 点击"保存为草稿"
   - 截图请求详情

3. **服务器日志**
   ```bash
   # 查看服务器输出
   # 如果有错误信息，请提供
   ```

## 🔗 相关链接

- 后台管理: http://localhost:3000/admin.html
- API 文档: http://localhost:3000/api
- 功能说明: `状态字段功能说明.md`

---

**最后更新**: 2025-01-24
**修复版本**: v2.1.1
