<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è¯Šæ–­é¡µé¢</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: white; padding: 10px; border: 1px solid #ddd; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” ç³»ç»Ÿè¯Šæ–­</h1>
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');
        const logs = [];

        function log(msg, type = 'info') {
            logs.push({ msg, type, time: new Date().toLocaleTimeString() });
        }

        function render() {
            let html = '';
            logs.forEach(l => {
                html += `<p class="${l.type}">[${l.time}] ${l.msg}</p>`;
            });
            output.innerHTML = html;
        }

        // æ•è·æ‰€æœ‰é”™è¯¯
        window.addEventListener('error', (e) => {
            log(`âŒ JavaScript é”™è¯¯: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
            log(`   é”™è¯¯å †æ ˆ: ${e.error?.stack || 'N/A'}`, 'error');
            render();
        });

        window.addEventListener('unhandledrejection', (e) => {
            log(`âŒ Promise é”™è¯¯: ${e.reason}`, 'error');
            render();
        });

        // å¼€å§‹è¯Šæ–­
        log('ğŸš€ å¼€å§‹è¯Šæ–­...', 'info');
        log(`ğŸ“„ document.readyState: ${document.readyState}`, 'info');

        // 1. æµ‹è¯• HTML ç»“æ„
        log('ğŸ” æ£€æŸ¥ HTML ç»“æ„...', 'info');

        // 2. æµ‹è¯• API
        log('ğŸŒ æµ‹è¯• API ç«¯ç‚¹...', 'info');
        fetch('/data/items.json')
            .then(r => {
                log(`   API å“åº”çŠ¶æ€: ${r.status}`, 'info');
                return r.json();
            })
            .then(data => {
                log(`   âœ… æˆåŠŸè·å– ${data.length} ä¸ªæ´»åŠ¨`, 'success');
                log(`   ç¬¬ä¸€ä¸ªæ´»åŠ¨: ${data[0]?.title}`, 'info');
            })
            .catch(err => {
                log(`   âŒ API è°ƒç”¨å¤±è´¥: ${err.message}`, 'error');
            })
            .finally(render);

        // 3. åŠ è½½ app.js
        log('ğŸ“¦ åŠ è½½ app.js...', 'info');
        const script = document.createElement('script');
        script.src = '/js/app.js';
        script.onload = () => {
            log('   âœ… app.js åŠ è½½æˆåŠŸ', 'success');
            render();

            setTimeout(() => {
                // 4. æ£€æŸ¥å…³é”®å‡½æ•°
                log('ğŸ” æ£€æŸ¥å…³é”®å‡½æ•°...', 'info');

                const funcs = ['fetchActivities', 'updateViews', 'filterActivities', 'initApp'];
                funcs.forEach(f => {
                    const exists = typeof window[f] === 'function';
                    log(`   ${f}: ${exists ? 'âœ…' : 'âŒ'}`, exists ? 'success' : 'error');
                });

                // 5. æ£€æŸ¥å…¨å±€å˜é‡
                log('ğŸ” æ£€æŸ¥å…¨å±€å˜é‡...', 'info');
                log(`   allActivities: ${typeof window.allActivities !== 'undefined' ? 'âœ…' : 'âŒ'}`, 'info');
                log(`   currentTab: ${typeof window.currentTab !== 'undefined' ? 'âœ…' : 'âŒ'}`, 'info');
                log(`   currentFilters: ${typeof window.currentFilters !== 'undefined' ? 'âœ…' : 'âŒ'}`, 'info');

                render();

                // 6. å°è¯•åˆå§‹åŒ–
                log('ğŸ¯ å°è¯•æ‰‹åŠ¨åˆå§‹åŒ–...', 'info');
                if (typeof window.initApp === 'function') {
                    window.initApp().then(() => {
                        log('   âœ… initApp æ‰§è¡ŒæˆåŠŸ', 'success');
                        render();

                        setTimeout(() => {
                            // 7. æ£€æŸ¥ç»“æœ
                            log('ğŸ“Š æ£€æŸ¥åˆå§‹åŒ–ç»“æœ...', 'info');
                            if (window.allActivities && window.allActivities.length > 0) {
                                log(`   âœ… æˆåŠŸåŠ è½½ ${window.allActivities.length} ä¸ªæ´»åŠ¨`, 'success');
                            } else {
                                log('   âŒ æ²¡æœ‰åŠ è½½åˆ°æ´»åŠ¨æ•°æ®', 'error');
                            }
                            render();
                        }, 2000);
                    }).catch(err => {
                        log(`   âŒ initApp æ‰§è¡Œå¤±è´¥: ${err.message}`, 'error');
                        log(`   é”™è¯¯å †æ ˆ: ${err.stack}`, 'error');
                        render();
                    });
                } else {
                    log('   âŒ initApp å‡½æ•°ä¸å­˜åœ¨', 'error');
                    render();
                }
            }, 500);
        };

        script.onerror = () => {
            log('   âŒ app.js åŠ è½½å¤±è´¥', 'error');
            render();
        };

        document.head.appendChild(script);
        render();
    </script>
</body>
</html>
