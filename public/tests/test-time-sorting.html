<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶é—´æ’åºæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; margin-bottom: 30px; }
        .test-section {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #667eea;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 18px;
        }
        .test-result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .test-result.pass {
            background: #d1e7dd;
            color: #0f5132;
            border-left: 4px solid #198754;
        }
        .test-result.fail {
            background: #f8d7da;
            color: #842029;
            border-left: 4px solid #dc3545;
        }
        .activity-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        .activity-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
        }
        .activity-time {
            font-weight: 600;
            color: #667eea;
        }
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
        }
        .summary {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <h1>â° æ—¶é—´æ’åºæµ‹è¯•</h1>

    <div class="summary">
        <strong>æµ‹è¯•ç›®çš„ï¼š</strong>éªŒè¯æ—¶é—´æ’åºä¿®å¤æ˜¯å¦æ­£ç¡®<br>
        <strong>æœŸæœ›è§„åˆ™ï¼š</strong>æŒ‰å¼€å§‹æ—¶é—´æ•°å­—å€¼æ’åºï¼Œå•ä¸€æ—¶é—´ç‚¹æ’åœ¨æ—¶é—´æ®µå‰é¢
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•1: åŸºæœ¬æ’åºï¼ˆ16:00-19:00åœºæ™¯ï¼‰</h2>
        <button onclick="testBasicSorting()">è¿è¡Œæµ‹è¯•</button>
        <div id="test1Result"></div>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•2: 9:00 vs 10:00ï¼ˆå­—ç¬¦ä¸²æ¯”è¾ƒé—®é¢˜ï¼‰</h2>
        <button onclick="testStringComparison()">è¿è¡Œæµ‹è¯•</button>
        <div id="test2Result"></div>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•3: ç›¸åŒå¼€å§‹æ—¶é—´ï¼ˆç‚¹ vs èŒƒå›´ï¼‰</h2>
        <button onclick="testSameStartTime()">è¿è¡Œæµ‹è¯•</button>
        <div id="test3Result"></div>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•3.5: ç›¸åŒå¼€å§‹æ—¶é—´ï¼ˆæŒ‰ç»“æŸæ—¶é—´æ’åºï¼‰</h2>
        <button onclick="testSameStartTimeEndTime()">è¿è¡Œæµ‹è¯•</button>
        <div id="test35Result"></div>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•4: çµæ´»æ—¶é—´æ’åº</h2>
        <button onclick="testFlexibleTime()">è¿è¡Œæµ‹è¯•</button>
        <div id="test4Result"></div>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•5: çœŸå®æ•°æ®æµ‹è¯•</h2>
        <button onclick="testRealData()">è¿è¡Œæµ‹è¯•</button>
        <div id="test5Result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¯ å…¨éƒ¨æµ‹è¯•</h2>
        <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <div id="allTestsResult"></div>
    </div>

    <script>
        // =====================================================
        // æ—¶é—´æ’åºå‡½æ•°ï¼ˆä»ä¸»é¡µé¢å¤åˆ¶ï¼‰
        // =====================================================

        function extractStartTime(timeStr) {
            if (!timeStr || timeStr === 'çµæ´»æ—¶é—´') {
                return { hour: 99, minute: 99, original: timeStr || 'çµæ´»æ—¶é—´' };
            }

            const match = timeStr.match(/^(\d{1,2}):(\d{2})/);
            if (match) {
                return {
                    hour: parseInt(match[1], 10),
                    minute: parseInt(match[2], 10),
                    original: timeStr
                };
            }

            return { hour: 99, minute: 99, original: timeStr };
        }

        function extractEndTime(timeStr) {
            if (!timeStr || timeStr === 'çµæ´»æ—¶é—´') {
                return { hour: 99, minute: 99, isOvernight: false, original: timeStr || 'çµæ´»æ—¶é—´' };
            }

            const parts = timeStr.split('-');
            if (parts.length >= 2) {
                const endTimeStr = parts[1].trim();
                const match = endTimeStr.match(/^(\d{1,2}):(\d{2})/);
                if (match) {
                    let hour = parseInt(match[1], 10);
                    let minute = parseInt(match[2], 10);
                    let isOvernight = false;

                    // ç‰¹æ®Šå¤„ç†ï¼š00:00 è¡¨ç¤ºå½“å¤©çš„24:00ï¼ˆæœ€æ™šï¼‰
                    if (hour === 0 && minute === 0) {
                        hour = 24;
                        minute = 0;
                        isOvernight = true;
                    }

                    return { hour, minute, isOvernight, original: endTimeStr };
                }
            }

            // å¦‚æœæ²¡æœ‰ç»“æŸæ—¶é—´ï¼ˆå•ä¸€æ—¶é—´ç‚¹ï¼‰ï¼Œè¿”å›å¼€å§‹æ—¶é—´
            const start = extractStartTime(timeStr);
            return { hour: start.hour, minute: start.minute, isOvernight: false, original: timeStr };
        }

        function compareTimes(timeA, timeB) {
            const extractedA = extractStartTime(timeA);
            const extractedB = extractStartTime(timeB);

            // ä¼˜å…ˆçº§1: æŒ‰å¼€å§‹æ—¶é—´çš„æ•°å­—å€¼æ¯”è¾ƒ
            if (extractedA.hour !== extractedB.hour) {
                return extractedA.hour - extractedB.hour;
            }

            if (extractedA.minute !== extractedB.minute) {
                return extractedA.minute - extractedB.minute;
            }

            // å¼€å§‹æ—¶é—´ç›¸åŒï¼Œç»§ç»­æ¯”è¾ƒ
            // ä¼˜å…ˆçº§2: å•ä¸€æ—¶é—´ç‚¹æ’åœ¨æ—¶é—´æ®µå‰é¢
            const isRangeA = extractedA.original.includes('-');
            const isRangeB = extractedB.original.includes('-');

            if (isRangeA && !isRangeB) return 1;   // Aæ˜¯èŒƒå›´ï¼ŒBæ˜¯ç‚¹ â†’ Båœ¨å‰
            if (!isRangeA && isRangeB) return -1;  // Aæ˜¯ç‚¹ï¼ŒBæ˜¯èŒƒå›´ â†’ Aåœ¨å‰

            // ä¼˜å…ˆçº§3: å¦‚æœéƒ½æ˜¯æ—¶é—´æ®µï¼ŒæŒ‰ç»“æŸæ—¶é—´æ’åº
            if (isRangeA && isRangeB) {
                const endA = extractEndTime(extractedA.original);
                const endB = extractEndTime(extractedB.original);

                // æŒ‰ç»“æŸæ—¶é—´æ’åºï¼ˆæ—©ç»“æŸçš„åœ¨å‰ï¼‰
                if (endA.hour !== endB.hour) {
                    return endA.hour - endB.hour;
                }

                if (endA.minute !== endB.minute) {
                    return endA.minute - endB.minute;
                }

                // ç»“æŸæ—¶é—´ä¹Ÿç›¸åŒï¼Œä¿æŒåŸé¡ºåº
                return 0;
            }

            // éƒ½æ˜¯å•ä¸€æ—¶é—´ç‚¹ï¼Œä¿æŒåŸé¡ºåº
            return 0;
        }

        // =====================================================
        // æµ‹è¯•ç”¨ä¾‹
        // =====================================================

        function testBasicSorting() {
            const activities = [
                { title: "æ´»åŠ¨A", time: "19:00" },
                { title: "æ´»åŠ¨B", time: "16:00" },
                { title: "æ´»åŠ¨C", time: "16:00-19:00" }
            ];

            const sorted = [...activities].sort((a, b) => compareTimes(a.time, b.time));

            const expected = ["16:00", "16:00-19:00", "19:00"];
            const actual = sorted.map(a => a.time);
            const passed = JSON.stringify(actual) === JSON.stringify(expected);

            const resultDiv = document.getElementById('test1Result');
            resultDiv.innerHTML = `
                <div class="test-result ${passed ? 'pass' : 'fail'}">
                    <strong>${passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}</strong><br><br>
                    <strong>è¾“å…¥:</strong><br>
                    ${activities.map(a => `${a.time} (${a.title})`).join('<br>')}<br><br>
                    <strong>æœŸæœ›æ’åº:</strong><br>
                    ${expected.join('<br>')}<br><br>
                    <strong>å®é™…æ’åº:</strong><br>
                    ${actual.join('<br>')}
                </div>
            `;
        }

        function testStringComparison() {
            const activities = [
                { title: "10:00æ´»åŠ¨", time: "10:00" },
                { title: "9:00æ´»åŠ¨", time: "9:00" },
                { title: "16:00æ´»åŠ¨", time: "16:00" }
            ];

            const sorted = [...activities].sort((a, b) => compareTimes(a.time, b.time));

            const expected = ["9:00", "10:00", "16:00"];
            const actual = sorted.map(a => a.time);
            const passed = JSON.stringify(actual) === JSON.stringify(expected);

            const resultDiv = document.getElementById('test2Result');
            resultDiv.innerHTML = `
                <div class="test-result ${passed ? 'pass' : 'fail'}">
                    <strong>${passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}</strong><br><br>
                    <strong>æµ‹è¯•ç›®çš„:</strong> éªŒè¯æ•°å­—æ¯”è¾ƒï¼ˆè€Œéå­—ç¬¦ä¸²æ¯”è¾ƒï¼‰<br><br>
                    <strong>è¾“å…¥:</strong><br>
                    ${activities.map(a => `${a.time} (${a.title})`).join('<br>')}<br><br>
                    <strong>æœŸæœ›æ’åº:</strong><br>
                    ${expected.join('<br>')}<br><br>
                    <strong>å®é™…æ’åº:</strong><br>
                    ${actual.join('<br>')}
                </div>
            `;
        }

        function testSameStartTime() {
            const activities = [
                { title: "å•ä¸€æ—¶é—´ç‚¹", time: "16:00" },
                { title: "æ—¶é—´æ®µæ´»åŠ¨", time: "16:00-19:00" },
                { title: "å¦ä¸€æ—¶é—´ç‚¹", time: "16:00" }
            ];

            const sorted = [...activities].sort((a, b) => compareTimes(a.time, b.time));

            // æœŸæœ›ï¼š16:00ï¼ˆç‚¹ï¼‰åœ¨ 16:00-19:00ï¼ˆèŒƒå›´ï¼‰å‰é¢
            const expectedPattern = /^16:00(?!-)/.test(sorted[0].time);
            const passed = expectedPattern;

            const resultDiv = document.getElementById('test3Result');
            resultDiv.innerHTML = `
                <div class="test-result ${passed ? 'pass' : 'fail'}">
                    <strong>${passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}</strong><br><br>
                    <strong>æµ‹è¯•ç›®çš„:</strong> éªŒè¯ç›¸åŒå¼€å§‹æ—¶é—´æ—¶ï¼Œå•ä¸€æ—¶é—´ç‚¹æ’åœ¨å‰é¢<br><br>
                    <strong>è¾“å…¥:</strong><br>
                    ${activities.map(a => `${a.time} (${a.title})`).join('<br>')}<br><br>
                    <strong>å®é™…æ’åº:</strong><br>
                    ${sorted.map(a => `${a.time} (${a.title})`).join('<br>')}<br><br>
                    <strong>éªŒè¯:</strong> ${sorted[0].time === '16:00' && !sorted[0].time.includes('-') ? 'âœ… ç¬¬ä¸€ä¸ªæ˜¯å•ä¸€æ—¶é—´ç‚¹16:00' : 'âŒ ç¬¬ä¸€ä¸ªä¸æ˜¯å•ä¸€æ—¶é—´ç‚¹'}
                </div>
            `;
        }

        function testFlexibleTime() {
            const activities = [
                { title: "çµæ´»æ—¶é—´æ´»åŠ¨A", time: "çµæ´»æ—¶é—´" },
                { title: "16:00æ´»åŠ¨", time: "16:00" },
                { title: "çµæ´»æ—¶é—´æ´»åŠ¨B", time: "çµæ´»æ—¶é—´" }
            ];

            const sorted = [...activities].sort((a, b) => compareTimes(a.time, b.time));

            const passed = sorted[sorted.length - 1].time === 'çµæ´»æ—¶é—´';

            const resultDiv = document.getElementById('test4Result');
            resultDiv.innerHTML = `
                <div class="test-result ${passed ? 'pass' : 'fail'}">
                    <strong>${passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}</strong><br><br>
                    <strong>æµ‹è¯•ç›®çš„:</strong> éªŒè¯çµæ´»æ—¶é—´æ’åœ¨æœ€å<br><br>
                    <strong>è¾“å…¥:</strong><br>
                    ${activities.map(a => `${a.time} (${a.title})`).join('<br>')}<br><br>
                    <strong>å®é™…æ’åº:</strong><br>
                    ${sorted.map(a => `${a.time} (${a.title})`).join('<br>')}<br><br>
                    <strong>éªŒè¯:</strong> ${passed ? 'âœ… çµæ´»æ—¶é—´åœ¨æœ€å' : 'âŒ çµæ´»æ—¶é—´ä¸åœ¨æœ€å'}
                </div>
            `;
        }

        function testSameStartTimeEndTime() {
            const activities = [
                { title: "å‘¨å…­å¤œå¸‚", time: "17:00-23:00" },
                { title: "å‘¨æ—¥å¤œå¸‚", time: "17:00-22:00" },
                { title: "é•¿åº·è·¯å¤œå¸‚", time: "17:00-00:00" },
                { title: "æ¸…è¿ˆå¤§å­¦å‰é—¨å¤œå¸‚", time: "17:00-23:00" }
            ];

            const sorted = [...activities].sort((a, b) => compareTimes(a.time, b.time));

            const expectedOrder = [
                "17:00-22:00",  // 22:00ç»“æŸ
                "17:00-23:00",  // 23:00ç»“æŸï¼ˆç¬¬1ä¸ªï¼‰
                "17:00-23:00",  // 23:00ç»“æŸï¼ˆç¬¬2ä¸ªï¼‰
                "17:00-00:00"   // 24:00ç»“æŸï¼ˆ00:00è½¬ä¸º24:00ï¼‰
            ];

            const actualOrder = sorted.map(a => a.time);
            const passed = JSON.stringify(actualOrder) === JSON.stringify(expectedOrder);

            const resultDiv = document.getElementById('test35Result');
            resultDiv.innerHTML = `
                <div class="test-result ${passed ? 'pass' : 'fail'}">
                    <strong>${passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}</strong><br><br>
                    <strong>æµ‹è¯•ç›®çš„:</strong> éªŒè¯ç›¸åŒå¼€å§‹æ—¶é—´æ—¶ï¼ŒæŒ‰ç»“æŸæ—¶é—´æ’åºï¼ˆ00:00ç‰¹æ®Šå¤„ç†ä¸º24:00ï¼‰<br><br>
                    <strong>è¾“å…¥:</strong><br>
                    ${activities.map(a => `${a.time} (${a.title})`).join('<br>')}<br><br>
                    <strong>æœŸæœ›æ’åº:</strong><br>
                    1. 17:00-22:00 (22:00ç»“æŸ)<br>
                    2. 17:00-23:00 (23:00ç»“æŸ)<br>
                    3. 17:00-23:00 (23:00ç»“æŸ)<br>
                    4. 17:00-00:00 (24:00ç»“æŸï¼Œ00:00è½¬ä¸º24:00)<br><br>
                    <strong>å®é™…æ’åº:</strong><br>
                    ${sorted.map((a, i) => `${i + 1}. ${a.time} (${a.title})`).join('<br>')}<br><br>
                    <strong>éªŒè¯:</strong> ${passed ? 'âœ… æ’åºæ­£ç¡®' : 'âŒ æ’åºé”™è¯¯'}
                </div>
            `;
        }

        async function testRealData() {
            const resultDiv = document.getElementById('test5Result');
            resultDiv.innerHTML = '<p>æ­£åœ¨è·å–çœŸå®æ•°æ®...</p>';

            try {
                const response = await fetch('/api/activities?limit=100');
                const data = await response.json();

                if (data.success && data.data) {
                    // ç­›é€‰16:00-19:00æ—¶é—´æ®µçš„æ´»åŠ¨
                    const timeRangeActivities = data.data.filter(a => {
                        const time = a.time || '';
                        return time.includes('16:') || time.includes('17:') || time.includes('18:') || time.includes('19:');
                    }).slice(0, 10);

                    const sorted = [...timeRangeActivities].sort((a, b) => compareTimes(a.time, b.time));

                    resultDiv.innerHTML = `
                        <div class="test-result pass">
                            <strong>âœ… æ•°æ®è·å–æˆåŠŸ</strong><br><br>
                            <strong>16:00-19:00æ—¶é—´æ®µæ´»åŠ¨æ’åº:</strong><br>
                            <ul class="activity-list">
                                ${sorted.map((a, i) => `
                                    <li class="activity-item">
                                        <span class="activity-time">${i + 1}. ${a.time}</span>
                                        <span>${a.title} (${a.category})</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="test-result fail">
                        <strong>âŒ é”™è¯¯:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function runAllTests() {
            testBasicSorting();
            testStringComparison();
            testSameStartTime();
            testSameStartTimeEndTime();  // æ–°å¢æµ‹è¯•
            testFlexibleTime();
            testRealData();

            setTimeout(() => {
                const allResults = [
                    document.getElementById('test1Result').textContent.includes('âœ… é€šè¿‡'),
                    document.getElementById('test2Result').textContent.includes('âœ… é€šè¿‡'),
                    document.getElementById('test3Result').textContent.includes('âœ… é€šè¿‡'),
                    document.getElementById('test35Result').textContent.includes('âœ… é€šè¿‡'),  // æ–°å¢
                    document.getElementById('test4Result').textContent.includes('âœ… é€šè¿‡'),
                    document.getElementById('test5Result').textContent.includes('âœ…')
                ];

                const passCount = allResults.filter(r => r).length;
                const totalCount = allResults.length;

                const allTestsDiv = document.getElementById('allTestsResult');
                allTestsDiv.innerHTML = `
                    <div class="test-result ${passCount === totalCount ? 'pass' : 'fail'}">
                        <strong>æµ‹è¯•æ€»ç»“:</strong><br>
                        é€šè¿‡: ${passCount}/${totalCount}<br>
                        ${passCount === totalCount ? 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼' : 'âš ï¸ æœ‰æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥'}
                    </div>
                `;
            }, 1000);
        }

        // è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>
