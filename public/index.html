<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- å¼ºåˆ¶ä¸ç¼“å­˜ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>æ¸…è¿ˆæ´»åŠ¨å¹³å° v1.0.7 - Chiengmai Activities Platform</title>

    <!-- H5æ¨¡å¼æ£€æµ‹ -->
    <script>
    (function() {
        // æ£€æµ‹URLå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');

        // æ£€æµ‹User-Agentï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // H5æ¨¡å¼ï¼šURLå‚æ•°æŒ‡å®šæˆ–è‡ªåŠ¨æ£€æµ‹ä¸ºç§»åŠ¨è®¾å¤‡
        const isH5Mode = mode === 'h5' || (mode === null && isMobile);

        // ä¿å­˜æ¨¡å¼åˆ°å…¨å±€å˜é‡
        window.CHIENGMAI_MODE = isH5Mode ? 'h5' : 'pc';
        window.CHIENGMAI_IS_MOBILE = isMobile;

        // æ·»åŠ æ¨¡å¼æ ‡è¯†åˆ°body
        document.addEventListener('DOMContentLoaded', function() {
            document.body.classList.add('mode-' + window.CHIENGMAI_MODE);
            if (isMobile) {
                document.body.classList.add('is-mobile');
            }
            console.log('ğŸ” æ£€æµ‹åˆ°æ˜¾ç¤ºæ¨¡å¼:', window.CHIENGMAI_MODE.toUpperCase(), '| ç§»åŠ¨è®¾å¤‡:', isMobile);
        });
    })();
    </script>
    <style>
        /* ========== CSSå˜é‡ç³»ç»Ÿ ========== */
        :root {
            /* Spacing Scale */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 20px;
            --space-2xl: 24px;

            /* ç§»åŠ¨ç«¯è¦†ç›–å€¼ */
            --space-mobile-xs: 2px;
            --space-mobile-sm: 4px;
            --space-mobile-md: 6px;
            --space-mobile-lg: 8px;
            --space-mobile-xl: 12px;
            --space-mobile-2xl: 16px;

            /* å¸ƒå±€å°ºå¯¸ */
            --space-header-height: 65px;
            --space-tab-height: 50px;
            --space-tab-padding-std: calc(var(--space-header-height) + var(--space-tab-height) + var(--space-md));
            --space-tab-padding-tab4: calc(var(--space-header-height) + var(--space-tab-height));

            /* Z-Index Layers */
            --z-header: 1001;
            --z-modal: 2000;
            --z-toast: 3000;
        }

        /* ç§»åŠ¨ç«¯å˜é‡è¦†ç›– */
        @media (max-width: 768px) {
            :root {
                --space-xs: var(--space-mobile-xs);
                --space-sm: var(--space-mobile-sm);
                --space-md: var(--space-mobile-md);
                --space-lg: var(--space-mobile-lg);
                --space-xl: var(--space-mobile-xl);
                --space-2xl: var(--space-mobile-2xl);
            }
        }

        /* ========== åŸæœ‰æ ·å¼ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* å¤´éƒ¨ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 30px;
        }

        .header h1 {
            font-size: 24px;
            margin: 0;
            white-space: nowrap;
        }


        .search-section {
            flex: 1;
            max-width: 600px;
            margin: 0;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            position: relative;
        }

        .search-icon {
            margin-right: 8px;
            font-size: 16px;
            flex-shrink: 0;
        }

        /* æœç´¢æŒ‰é’® - æ¡Œé¢ç«¯æ˜¾ç¤º */
        .search-btn {
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .search-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* ç§»åŠ¨ç«¯æœç´¢å›¾æ ‡æŒ‰é’® */
        .search-icon-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .search-icon-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .search-icon-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        /* ç­›é€‰åŒºåŸŸ - å›ºå®šåœ¨é¡¶éƒ¨ */
        .filter-section {
            background: #fff;
            padding: 12px 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .filter-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
            white-space: nowrap;
        }

        .filter-chips {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 16px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            white-space: nowrap;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .filter-chip:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .filter-chip:active {
            transform: scale(0.96);
            background: #e8e8e8;
        }

        .filter-chip:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .filter-chip.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Tabå¯¼èˆª */
        .tabs-nav {
            display: flex;
            background: #fff;
            border-bottom: 2px solid #e0e0e0;
            padding: 0 20px;
        }

        .tab-item {
            padding: 14px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 15px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0; /* é˜²æ­¢tabè¢«å‹ç¼© */
            min-width: fit-content; /* ç¡®ä¿tabæœ‰æœ€å°å®½åº¦ */
        }

        .tab-item:hover {
            color: #667eea;
        }

        .tab-item.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-icon {
            font-size: 18px;
        }

        /* Tabå†…å®¹ */
        .tab-content {
            padding: 20px;
            min-height: 400px;
        }

        /* æ”»ç•¥ä¿¡æ¯å†…å®¹æ ·å¼ï¼ˆä¸åå°ç¼–è¾‘å™¨ä¿æŒä¸€è‡´ï¼‰ */
        .guide-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 13px;
            line-height: 1.6;
            color: #333;
            padding: 12px 20px;
        }

        /* æ”»ç•¥Tabçš„guide-contentç‰¹æ®Šæ ·å¼ */
        #tab-4 .guide-content {
            padding: 12px 20px;
        }

        /* æ—¥æœŸè¯¦æƒ…æ ‡é¢˜æ  - ç§»åŠ¨ç«¯å›ºå®šé¡¶éƒ¨ */
        .day-detail-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .day-back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: white;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            flex-shrink: 0;
        }

        .day-back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .day-back-btn:active {
            transform: scale(0.95);
        }

        .day-detail-title {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }

        .day-detail-content {
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .guide-content h1 {
            font-size: 15px !important;
            font-weight: 600 !important;
            margin: 12px 0 6px 0 !important;
            line-height: 1.4 !important;
            color: #333 !important;
        }

        .guide-content h2 {
            font-size: 14px !important;
            font-weight: 600 !important;
            margin: 10px 0 6px 0 !important;
            line-height: 1.4 !important;
            color: #333 !important;
        }

        .guide-content h3 {
            font-size: 14px !important;
            font-weight: 600 !important;
            margin: 10px 0 6px 0 !important;
            line-height: 1.4 !important;
            color: #333 !important;
        }

        .guide-content p {
            margin: 6px 0 !important;
            line-height: 1.6 !important;
            font-size: 13px !important;
            color: #333 !important;
        }

        .guide-content ul, .guide-content ol {
            margin: 6px 0 !important;
            padding-left: 20px !important;
        }

        .guide-content li {
            margin: 3px 0 !important;
            line-height: 1.5 !important;
            font-size: 13px !important;
            color: #333 !important;
        }

        .guide-content strong {
            font-weight: 600 !important;
        }

        .guide-content table {
            border-collapse: collapse !important;
            width: 100% !important;
            margin: 10px 0 !important;
            font-size: 13px !important;
        }

        .guide-content th, .guide-content td {
            border: 1px solid #ddd !important;
            padding: 6px 10px !important;
            text-align: left !important;
            line-height: 1.5 !important;
            font-size: 13px !important;
        }

        .guide-content th {
            background: #f5f5f5 !important;
            font-weight: 600 !important;
        }

        /* æ¸…é™¤æ‰€æœ‰å†…è”æ ·å¼çš„å­—ä½“å¤§å°å’Œé¢œè‰² */
        .guide-content * {
            font-family: inherit !important;
        }

        .guide-content h1, .guide-content h2, .guide-content h3 {
            font-size: inherit !important;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* æ—¥å†Tab */
        .calendar-header {
            margin-bottom: 20px;
        }

        .nav-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .month-label {
            font-size: 14px;
            color: #666;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
        }

        .nav-btn {
            padding: 6px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            color: #333;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: #f5f5f5;
        }

        .date-grid-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .date-cell-header {
            padding: 8px 4px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            position: relative;
            font-size: 13px;
            font-weight: 500;
            line-height: 1.2;
            min-width: 44px; /* ç§»åŠ¨ç«¯æœ€å°ç‚¹å‡»å®½åº¦ */
            min-height: 44px; /* ç§»åŠ¨ç«¯æœ€å°ç‚¹å‡»é«˜åº¦ */
            border: 2px solid transparent;
        }

        .date-cell-header:active {
            transform: translateY(-1px) scale(0.98);
        }

        .date-cell-header:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* ç»Ÿä¸€çš„é€‰ä¸­æ ·å¼ - è“è‰²æ¸å˜ + åŠ ç²—è¾¹æ¡† */
        .date-cell-header.selected-day {
            background: linear-gradient(135deg, #667eea 0%, #5568d3 100%);
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
            transform: scale(1.08);
            animation: selectPulse 0.3s ease;
            border: 2px solid #667eea;
        }

        /* ä»Šå¤©çš„é«˜äº®æ ·å¼ - é»„è‰²è¾¹æ¡†æŒ‡ç¤º */
        .date-cell-header.today-header {
            border: 2px solid #ffc107;
        }

        /* ä»Šå¤©ä¸”è¢«é€‰ä¸­ - ä¿æŒè“è‰²é€‰ä¸­ï¼ŒåŠ ç²—é»„è‰²è¾¹æ¡† */
        .date-cell-header.today-header.selected-day {
            background: linear-gradient(135deg, #667eea 0%, #5568d3 100%);
            border: 3px solid #ffc107;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.8), 0 0 0 2px rgba(255, 193, 7, 0.3);
        }

        @keyframes selectPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.12); }
            100% { transform: scale(1.08); }
        }

        /* Tooltip æç¤º */
        .date-cell-header:hover::before {
            content: 'ç‚¹å‡»æŸ¥çœ‹å½“å¤©æ´»åŠ¨';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            margin-bottom: 8px;
            opacity: 0;
            animation: tooltipFade 0.3s ease forwards;
            pointer-events: none;
            z-index: 100;
        }

        .date-cell-header:hover::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
            margin-bottom: -4px;
            opacity: 0;
            animation: tooltipFade 0.3s ease forwards;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes tooltipFade {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-4px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .day-cell.dimmed {
            opacity: 0.25;
            pointer-events: none;
            filter: grayscale(100%);
            transform: scale(0.98);
            transition: all 0.4s ease;
        }

        .day-cell {
            transition: all 0.3s ease;
        }

        .day-cell:not(.dimmed):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-cell {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            min-height: 100px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }

        .day-cell:not(.dimmed):hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        /* é€‰ä¸­çš„æ—¥æœŸæ ·å¼ - ç»Ÿä¸€æ ·å¼ */
        .day-cell.selected-day {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
            border-width: 2px;
        }

        /* ä»Šå¤©çš„æ—¥æœŸå•å…ƒæ ¼ - é»„è‰²è¾¹æ¡†æŒ‡ç¤º */
        .day-cell.today {
            border-color: #ffc107;
            border-width: 2px;
        }

        /* ä»Šå¤©ä¸”è¢«é€‰ä¸­ - è“è‰²é€‰ä¸­ + é»„è‰²å¤–å‘å…‰ */
        .day-cell.today.selected-day {
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            border: 2px solid #667eea;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4), 0 0 0 2px rgba(255, 193, 7, 0.3);
        }

        /* ç‚¹å‡»æç¤º */
        .day-cell:not(.dimmed):hover::after {
            content: 'ç‚¹å‡»ç­›é€‰';
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 10px;
            color: #667eea;
            opacity: 0.6;
        }

        .day-name {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin: 6px 0;
            text-align: center;
            position: relative;
            padding-right: 0;
        }

        .day-cell.today .day-name {
            color: #d4a017;
            font-weight: 700;
        }

        .day-cell.selected-day .day-name {
            color: #667eea;
            font-weight: 700;
        }

        .day-cell.today.selected-day .day-name {
            color: #667eea;
        }

        .activity-chip {
            background: white;
            border-left: 3px solid #667eea;
            padding: 6px 8px;
            margin-bottom: 8px; /* ç»Ÿä¸€é—´éš” */
            border-radius: 4px;
            font-size: 11px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            /* ç¡®ä¿å†…éƒ¨å…ƒç´ ç´§å‡‘æ’åˆ— */
            display: flex;
            flex-direction: column;
            gap: 2px; /* æ—¶é—´å’Œæ ‡é¢˜ä¹‹é—´çš„å°é—´éš” */
        }

        /* æœ€åä¸€ä¸ªæ´»åŠ¨å¡ç‰‡ä¸éœ€è¦åº•éƒ¨é—´éš” */
        .activity-chip:last-child {
            margin-bottom: 0;
        }

        /* æ´»åŠ¨å¡ç‰‡å†…éƒ¨å…ƒç´ æ ·å¼ */
        .activity-chip > div {
            line-height: 1.4;
        }

        .chip-title {
            line-height: 1.3;
        }

        .day-cell.today .activity-chip {
            background: #ffffff;
            border-left-width: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .day-cell.today .activity-chip:hover {
            transform: translateX(2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        /* åˆ—è¡¨Tab */
        .schedule-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 12px; /* å‡å°‘é—´è·ä½¿åˆ—è¡¨æ›´ç´§å‡‘ */
        }

        .schedule-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px; /* å‡å°‘paddingä½¿åˆ—è¡¨æ›´ç´§å‡‘ */
        }

        .schedule-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        /* åˆ—è¡¨è§†å›¾ä¸­çš„æ˜ŸæœŸç­›é€‰æ ‡ç­¾ */
        .day-filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 11px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            position: relative;
        }

        /* æ·»åŠ ç‚¹å‡»æç¤ºå›¾æ ‡ */
        .day-filter-chip::before {
            content: 'ğŸ”';
            font-size: 9px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .day-filter-chip:hover::before {
            opacity: 0.5;
        }

        .day-filter-chip:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .day-filter-chip:active {
            transform: translateY(0) scale(0.95);
        }

        /* å¦‚æœå½“å‰ç­›é€‰çš„æ˜ŸæœŸåŒ¹é…ï¼Œæ˜¾ç¤ºé«˜äº® */
        .day-filter-chip.highlight {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .day-filter-chip.highlight::after {
            content: 'âœ“';
            margin-left: 2px;
            font-size: 10px;
        }

        .category-tag {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .schedule-item-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px; /* å‡å°‘é—´è· */
        }

        .schedule-item-meta {
            font-size: 13px;
            color: #666;
        }

        /* ç­›é€‰æ¡ä»¶æ ‡ç­¾ */
        .active-filters {
            display: none;
            padding: 8px 20px;
            background: #fff3cd;
            border-bottom: 1px solid #ffc107;
        }

        .active-filters.show {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .filter-tag {
            background: white;
            border: 1px solid #ffc107;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-tag button {
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-tag button:hover {
            color: #c92a2a;
        }

        .clear-all-btn {
            background: #ffc107;
            border: none;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            color: #333;
        }

        .clear-all-btn:hover {
            background: #e0a800;
        }

        /* ç­›é€‰ç»“æœæ•°é‡ */
        .results-count {
            text-align: center;
            padding: 12px 20px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            font-size: 14px;
            color: #666;
        }

        .results-count .count-number {
            color: #667eea;
            font-weight: 600;
            font-size: 16px;
        }

        /* ç©ºçŠ¶æ€æç¤º */
        .empty-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        .empty-state.show {
            display: flex;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.6;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .empty-description {
            font-size: 15px;
            color: #666;
            margin-bottom: 24px;
            max-width: 400px;
            line-height: 1.6;
        }

        .empty-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .empty-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            color: #667eea;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .empty-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .empty-btn.primary {
            background: #667eea;
            color: white;
        }

        .empty-btn.primary:hover {
            background: #5568d3;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* å…³é”®ä¿¡æ¯å¡ç‰‡ */
        .modal-key-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin: 12px 20px 20px 20px; /* é€‚ä¸­çš„ä¸Šè¾¹è·ï¼Œä¸æ ‡é¢˜åˆ†éš” */
            padding: 16px;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            border-radius: 8px;
            border: 1px solid #e0e7ff;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .info-icon {
            font-size: 20px;
            line-height: 1;
            flex-shrink: 0;
        }

        .info-text {
            flex: 1;
            min-width: 0;
        }

        .info-text strong {
            display: block;
            font-size: 11px;
            color: #764ba2;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-text > div {
            font-size: 13px;
            color: #333;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word; /* æ”¹è¿›ä¸­æ–‡æ¢è¡Œ */
            line-height: 1.5;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* æ¨¡æ€æ¡†åˆ†èŠ‚ */
        .modal-section {
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-content {
            font-size: 14px;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word; /* æ”¹è¿›ä¸­æ–‡æ¢è¡Œ */
        }

        .modal-body {
            padding: 20px;
        }

        .modal-info-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #666;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .modal-info-row strong {
            color: #333;
            min-width: 60px;
            flex-shrink: 0;
        }

        .modal-info-row span {
            flex: 1;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word; /* æ”¹è¿›ä¸­æ–‡æ¢è¡Œ */
            white-space: pre-wrap;
        }

        .modal-description {
            margin-top: 16px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: #666;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word; /* æ”¹è¿›ä¸­æ–‡æ¢è¡Œ */
            white-space: pre-wrap;
        }

        /* å¼¹çª—åº•éƒ¨æŒ‰é’®åŒºåŸŸ */
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 32px;
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            background: #fafafa;
        }

        /* ä¸»æŒ‰é’® */
        .btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* æ¬¡è¦æŒ‰é’® */
        .btn-secondary {
            padding: 10px 20px;
            background: white;
            color: #666;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .modal-link-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .modal-link-btn:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8a 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .modal-link-btn:active {
            transform: translateY(0);
        }

        .btn-icon {
            font-size: 18px;
        }

        .btn-text {
            flex: 1;
            text-align: center;
        }

        .btn-arrow {
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .modal-link-btn:hover .btn-arrow {
            transform: translateX(4px);
        }

        .modal-category-badge {
            display: inline-block;
            padding: 6px 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);

            /* æ–‡æ¡ˆå±•ç¤ºä¼˜åŒ– */
            letter-spacing: 0.5px;           /* å­—é—´è·ï¼Œæå‡å¯è¯»æ€§ */
            line-height: 1.4;                 /* è¡Œé«˜ï¼Œç¡®ä¿æ–‡å­—å‚ç›´å±…ä¸­ */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);  /* æ–‡å­—é˜´å½±ï¼Œå¢åŠ æ·±åº¦æ„Ÿ */
            -webkit-font-smoothing: antialiased;         /* å­—ä½“å¹³æ»‘æ¸²æŸ“ï¼Œæ›´æ¸…æ™° */
            -moz-osx-font-smoothing: grayscale;          /* macOSå­—ä½“å¹³æ»‘ */
            transition: all 0.2s ease;                    /* å¹³æ»‘è¿‡æ¸¡åŠ¨ç”» */
        }

        .modal-category-badge:hover {
            transform: translateY(-1px);     /* æ‚¬åœå¾®æŠ¬æ•ˆæœ */
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);  /* æ‚¬åœæ—¶åŠ æ·±é˜´å½± */
        }

        .note {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px 16px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        .note strong {
            display: block;
            margin-bottom: 8px;
            color: #1976d2;
        }

        /* å“åº”å¼è®¾è®¡ - ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
                box-shadow: none;
                /* ç§»åŠ¨ç«¯ä¸éœ€è¦padding-topï¼Œå› ä¸ºheaderæ˜¯fixedçš„ */
                padding-top: 0 !important;
            }

            /* ========== æ–¹æ¡ˆA: æœç´¢æ¡†å›ºå®šåœ¨æœ€é¡¶éƒ¨ ========== */
            .header {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 1001 !important;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                padding: 8px 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }

            .header h1 {
                font-size: 16px;
                text-align: center;
                margin: 0;
                padding: 0;
                line-height: 1.2;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                /* ç§»åŠ¨ç«¯éšè—æ ‡é¢˜ï¼ŒèŠ‚çœç©ºé—´ */
                display: none;
            }

            /* ç­›é€‰åŒºåŸŸå–æ¶ˆmargin-topï¼Œæ”¹ç”¨containerçš„padding-top */
            .filter-section {
                margin-top: 0 !important;
            }

            /* ç§»åŠ¨ç«¯æœç´¢ä¼˜åŒ– - å•è¡Œå¸ƒå±€ */
            .search-section {
                max-width: 100%;
                width: 100%;
                flex-direction: row;
                align-items: center; /* æ”¹ä¸ºcenterç¡®ä¿å‚ç›´å±…ä¸­ */
                gap: 8px;
            }

            .search-input-wrapper {
                flex: 1;
                position: relative; /* ç¡®ä¿relativeå®šä½ */
                display: flex;
                align-items: center;
                background: rgba(255, 255, 255, 0.98); /* å¢åŠ ä¸é€æ˜åº¦ */
                border-radius: 8px;
                padding: 8px 12px; /* å‡å°padding */
                min-height: 44px; /* iOSæ¨èæœ€å°è§¦æ‘¸å°ºå¯¸ */
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* æ·»åŠ è½»å¾®é˜´å½± */
            }

            .search-input {
                font-size: 15px; /* ç§»åŠ¨ç«¯å¢å¤§å­—ä½“ */
                flex: 1;
                border: none;
                background: transparent;
                padding: 0;
                margin: 0;
                min-width: 0; /* é˜²æ­¢å†…å®¹æº¢å‡º */
            }

            /* ç§»åŠ¨ç«¯æ˜¾ç¤ºå›¾æ ‡æŒ‰é’®ï¼Œéšè—æ–‡å­—æŒ‰é’® */
            .search-btn {
                display: none;
            }

            .search-icon-btn {
                display: flex;
                width: 44px; /* iOSæ¨èæœ€å°è§¦æ‘¸å°ºå¯¸ */
                height: 44px;
                min-width: 44px;
                min-height: 44px;
                font-size: 20px;
            }

            /* æœç´¢æ¸…é™¤æŒ‰é’®ä¼˜åŒ– */
            .search-clear-btn {
                width: 44px;
                height: 44px;
                font-size: 24px;
                line-height: 44px;
            }

            /* ç­›é€‰åŒºåŸŸä¼˜åŒ– */
            .filter-section {
                padding: 12px 16px;
            }

            .filter-chips {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }

            .filter-chip {
                padding: 6px 12px;
                font-size: 13px;
                min-height: 32px;
                display: inline-flex;
                align-items: center;
                border-radius: 16px;
            }

            .filter-chip {
                padding: 6px 12px;
                font-size: 13px;
                min-height: 32px;
                display: inline-flex;
                align-items: center;
                border-radius: 16px;
            }

            /* æ—¥å†ä¼˜åŒ– - ç§»åŠ¨ç«¯æ°´å¹³æ»šåŠ¨ */
            .date-grid-header {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 8px;
            }

            .date-cell-header {
                min-width: 60px;
                padding: 10px 6px;
                font-size: 11px;
                flex-direction: column;
                gap: 2px;
            }

            /* å‘¨æ ‡é¢˜å’Œå¯¼èˆªæŒ‰é’® - ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .nav-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .month-label {
                font-size: 15px;
                font-weight: 600;
                color: #333;
                text-align: center;
                padding: 8px;
                background: #f5f5f5;
                border-radius: 8px;
            }

            .nav-buttons {
                display: flex;
                gap: 6px;
                justify-content: space-between;
            }

            .nav-btn {
                flex: 1;
                padding: 8px 4px;
                font-size: 12px;
                min-height: 36px;
                white-space: nowrap;
            }

            /* æ—¥å†ç½‘æ ¼ - æ°´å¹³æ»šåŠ¨ä¿ç•™7åˆ—ï¼ˆå‘¨è§†å›¾ï¼‰ */
            .calendar-wrapper {
                overflow-x: auto;
                overflow-y: visible;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                padding: 0 16px;
                margin: 0 -16px; /* æŠµæ¶ˆçˆ¶å…ƒç´ çš„padding */
            }

            .calendar-grid {
                display: flex;
                gap: 12px;
                width: max-content;
                padding: 8px 16px;
            }

            .day-cell {
                min-width: 80vw; /* æ¯å¤©å æ®80%å±å¹•å®½åº¦ */
                max-width: 320px;
                scroll-snap-align: center;
                flex-shrink: 0;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 12px;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
                background: white;
            }

            .day-cell:active {
                transform: scale(0.98);
            }

            .day-cell::after {
                font-size: 9px;
                bottom: 2px;
                right: 2px;
            }

            .activity-chip {
                padding: 8px 10px;
                font-size: 12px;
                /* ç§»åŠ¨ç«¯ä½¿ç”¨ç»Ÿä¸€çš„é—´éš” */
            }

            /* ç§»åŠ¨ç«¯å¼¹çª—ä¼˜åŒ– */
            .modal {
                width: 95vw;
                max-width: 420px;
                max-height: 85vh;
                overflow-y: auto;
                /* ç§»é™¤å†²çªçš„å®šä½å±æ€§ï¼Œä½¿ç”¨flexboxå±…ä¸­ */
            }

            .modal-close {
                width: 44px;
                height: 44px;
                font-size: 24px;
                line-height: 44px;
            }

            .modal-key-info {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .modal-body {
                padding: 16px;
                font-size: 14px;
            }

            .info-text > div,
            .section-content {
                word-break: break-all; /* ç§»åŠ¨ç«¯å¼ºåˆ¶æ¢è¡Œ */
                overflow-wrap: break-word;
                line-height: 1.6;
            }

            .modal-title {
                font-size: 18px;
                word-break: break-word;
                overflow-wrap: break-word;
            }

            .modal-description,
            .modal-info-row {
                font-size: 14px;
                word-break: break-all; /* ç§»åŠ¨ç«¯å¼ºåˆ¶é•¿å•è¯æ¢è¡Œ */
                line-height: 1.6;
            }

            /* è§¦æ‘¸æ»šåŠ¨ä¼˜åŒ– */
            .modal {
                -webkit-overflow-scrolling: touch;
            }

            .modal-overlay {
                -webkit-overflow-scrolling: touch;
            }

            .modal-footer {
                flex-direction: column;
                gap: 16px; /* H5ç«¯å¢åŠ æŒ‰é’®é—´è· */
                padding: 20px; /* å¢åŠ å†…è¾¹è· */
            }

            .btn-primary,
            .btn-secondary {
                width: 100%;
                text-align: center;
                justify-content: center;
            }

            /* åˆ—è¡¨è§†å›¾ä¼˜åŒ– */
            .schedule-list {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .schedule-item {
                padding: 12px;
            }

            .schedule-item-title {
                font-size: 15px;
            }

            .schedule-item-meta {
                font-size: 12px;
            }

            /* ç§»åŠ¨ç«¯æ˜ŸæœŸç­›é€‰æ ‡ç­¾ä¼˜åŒ– */
            .day-filter-chip {
                padding: 5px 10px;
                font-size: 11px;
                min-height: 28px;
            }

            /* å¼¹çª—å¤´éƒ¨å’Œä¸»ä½“ä¼˜åŒ– */
            .modal-header {
                padding: 16px;
            }

            .modal-body {
                padding: 16px;
            }

            /* ç§»åŠ¨ç«¯é“¾æ¥æŒ‰é’®ä¼˜åŒ– */
            .modal-link-btn {
                padding: 14px 20px;
                font-size: 16px;
                min-height: 48px; /* æ»¡è¶³æœ€å°è§¦æ§åŒºåŸŸ */
            }

            .btn-icon {
                font-size: 20px;
            }

            /* Tabå¯¼èˆªä¼˜åŒ– */
            .tabs-nav {
                padding: 0 16px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-item {
                padding: 10px 12px;
                font-size: 13px;
                white-space: normal; /* å…è®¸æ–‡æœ¬æ¢è¡Œ */
                text-align: center;
                line-height: 1.3;
                min-width: 60px;
                flex-direction: column; /* å›¾æ ‡å’Œæ–‡æœ¬å‚ç›´æ’åˆ— */
                gap: 4px;
            }

            .tab-item .tab-icon {
                font-size: 16px;
            }

            /* ç»“æœç»Ÿè®¡ä¼˜åŒ– */
            .results-count {
                padding: 10px 16px;
                font-size: 13px;
            }

            /* ========== Tabå¯¼èˆªå›ºå®šåœ¨æœç´¢æ¡†ä¸‹æ–¹ ========== */
            .tabs-nav {
                position: fixed !important;
                top: 65px !important; /* æœç´¢æ¡†é«˜åº¦ï¼ˆçº¦65pxï¼‰ */
                left: 0 !important;
                right: 0 !important;
                z-index: 1000 !important;
                background: white;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }

            .tab-item {
                flex-shrink: 0;
            }

            /* ========== æ—¥å†å¤´éƒ¨å›ºå®šåœ¨Tabå¯¼èˆªä¸‹æ–¹ ========== */
            .calendar-header {
                position: fixed !important;
                top: 115px !important; /* æœç´¢æ¡†65px + Tabå¯¼èˆª50px */
                left: 0 !important;
                right: 0 !important;
                z-index: 999 !important;
                background: white;
                padding: 12px 16px 8px 16px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            /* ========== å†…å®¹åŒºé€‚é…æ‰€æœ‰å›ºå®šå…ƒç´  ========== */
            .tab-pane {
                padding-top: var(--space-tab-padding-std) !important; /* æœç´¢æ¡†65px + Tabå¯¼èˆªçº¦50px + é€‚å½“é—´è· */
            }

            /* æ”»ç•¥ä¿¡æ¯Tabæ²¡æœ‰æ—¥å†å¤´éƒ¨ï¼Œä½¿ç”¨æ›´å°çš„padding */
            #tab-5.tab-pane {
                padding-top: var(--space-tab-padding-tab4) !important; /* æœç´¢æ¡†65px + Tabå¯¼èˆªçº¦50px */
            }

            /* ========== ç§»åŠ¨ç«¯é—´è·ä¼˜åŒ–ï¼ˆä½¿ç”¨CSSå˜é‡ï¼‰ ========== */
            /* å‡å°‘å…¨å±€å®¹å™¨é—´è· */
            .container {
                padding-left: var(--space-sm) !important;
                padding-right: var(--space-sm) !important;
            }

            /* ä¼˜åŒ–ç­›é€‰æ å’Œç»“æœæ é—´è· */
            .filter-section {
                padding: var(--space-md) var(--space-lg) !important;
                margin-bottom: var(--space-xs) !important;
            }

            .results-count {
                padding: var(--space-mobile-md) var(--space-sm) !important;
                margin-top: var(--space-xs) !important;
                margin-bottom: var(--space-xs) !important;
                font-size: 12px !important;
            }

            /* ä¼˜åŒ–æ—¥æœŸå•å…ƒæ ¼é—´è· */
            .day-cell {
                padding: var(--space-sm) !important;
                margin-bottom: var(--space-sm) !important;
            }

            /* ä¼˜åŒ–æ´»åŠ¨å¡ç‰‡é—´è· */
            .activity-card {
                margin-bottom: var(--space-sm) !important;
            }

            .activity-chip {
                padding: var(--space-mobile-sm) var(--space-xs) !important;
                margin-bottom: var(--space-xs) !important;
                font-size: 11px !important;
            }

            /* ä¼˜åŒ–æ—¥å†å¤´éƒ¨é—´è· */
            .calendar-header {
                padding: var(--space-sm) var(--space-lg) var(--space-xs) var(--space-lg) !important;
                margin-bottom: var(--space-sm) !important;
            }

            .nav-row {
                margin-bottom: var(--space-sm) !important;
            }

            .nav-btn {
                padding: var(--space-mobile-xs) var(--space-sm) !important;
                font-size: 12px !important;
                margin: 0 2px !important;
            }

            /* ä¼˜åŒ–æ—¥æœŸè¡¨å¤´é—´è· */
            .date-grid-header {
                padding: var(--space-xs) var(--space-sm) !important;
                gap: var(--space-mobile-md) !important;
            }

            .date-cell-header {
                padding: var(--space-mobile-xs) var(--space-sm) !important;
                min-width: 40px !important;
                font-size: 11px !important;
            }

            /* ä¼˜åŒ–åˆ—è¡¨è§†å›¾é—´è· */
            .schedule-list {
                padding: var(--space-xs) !important;
            }

            .schedule-item {
                padding: var(--space-sm) var(--space-mobile-xs) !important;
                margin-bottom: var(--space-sm) !important;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ–ï¼ˆ< 375pxï¼‰ */
        @media (max-width: 374px) {
            .header h1 {
                font-size: 18px;
            }

            .date-cell-header {
                min-width: 50px;
                font-size: 10px;
            }

            .filter-chip {
                padding: 4px 8px;
                font-size: 11px;
            }
        }

        /* ========== PCç«¯å“åº”å¼ä¼˜åŒ– ========== */

        /* å°å±å¹•ç¬”è®°æœ¬ä¼˜åŒ– (13-14å¯¸) */
        @media (max-height: 800px) and (min-width: 1024px) {
            .day-cell {
                min-height: 80px !important;
                padding: 8px !important;
            }

            .activity-card {
                padding: 4px 6px !important;
                margin-bottom: 3px !important;
                font-size: 12px;
            }

            .activity-title {
                font-size: 12px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .day-name {
                font-size: 13px;
            }

            .day-date {
                font-size: 11px;
            }
        }

        /* å¤§å±å¹•ä¼˜åŒ– (1400px+) */
        @media (min-width: 1400px) {
            .container {
                max-width: 1400px;
                margin: 0 auto;
            }

            .day-cell {
                min-height: 120px !important;
                padding: 14px;
            }

            .activity-card {
                padding: 8px 10px;
            }
        }

        /* è¶…å®½å±ä¼˜åŒ– (1920px+) */
        @media (min-width: 1920px) {
            .container {
                max-width: 1600px;
            }

            .day-cell {
                min-height: 140px !important;
                padding: 16px;
            }

            .activity-card {
                padding: 10px 12px;
                font-size: 14px;
            }
        }

        /* æ´»åŠ¨å¡ç‰‡hoverä¼˜åŒ– */
        .activity-card {
            transition: all 0.2s ease;
        }

        .activity-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>âœ¨ æ¸…è¿ˆæ´»åŠ¨æ¢ç´¢</h1>
            <div class="search-section">
                <div class="search-input-wrapper">
                    <span class="search-icon">ğŸ”</span>
                    <input
                        type="text"
                        class="search-input"
                        id="searchInput"
                        placeholder="æœç´¢æ´»åŠ¨ã€åœ°ç‚¹ã€å…³é”®è¯..."
                    >
                    <!-- ç§»åŠ¨ç«¯æœç´¢æŒ‰é’® -->
                    <button class="search-icon-btn" onclick="performSearch()" aria-label="æœç´¢">
                        ğŸ”
                    </button>
                </div>
                <button class="search-btn" onclick="performSearch()">æœç´¢</button>
            </div>
        </div>

        <!-- ç­›é€‰åŒºåŸŸï¼ˆå›ºå®šåœ¨é¡¶éƒ¨ï¼‰ -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <span class="filter-label">åˆ†ç±»:</span>
                    <div class="filter-chips" id="categoryChips">
                        <div class="filter-chip active" onclick="setFilter('category', 'å…¨éƒ¨')">å…¨éƒ¨</div>
                    </div>
                </div>

                <div class="filter-group">
                    <span class="filter-label">ä»·æ ¼:</span>
                    <div class="filter-chips">
                        <div class="filter-chip active" onclick="setFilter('price', 'å…¨éƒ¨')">å…¨éƒ¨</div>
                        <div class="filter-chip" onclick="setFilter('price', 'å…è´¹')">å…è´¹</div>
                        <div class="filter-chip" onclick="setFilter('price', '<500à¸¿')">&lt;500à¸¿</div>
                        <div class="filter-chip" onclick="setFilter('price', '<1000à¸¿')">&lt;1000à¸¿</div>
                        <div class="filter-chip" onclick="setFilter('price', '<1500à¸¿')">&lt;1500à¸¿</div>
                        <div class="filter-chip" onclick="setFilter('price', '>1500à¸¿')">&gt;1500à¸¿</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç­›é€‰æ¡ä»¶æ ‡ç­¾ï¼ˆæ˜¾ç¤ºå·²é€‰æ‹©çš„ç­›é€‰ï¼‰ -->
        <div class="active-filters" id="activeFilters">
            <!-- åŠ¨æ€ç”Ÿæˆç­›é€‰æ ‡ç­¾ -->
        </div>

        <!-- ç§»åŠ¨ç«¯å½“å‰ç­›é€‰çŠ¶æ€æ¡ -->
        <div class="mobile-filter-status" id="mobileFilterStatus" style="display: none;">
            <div class="status-item">
                <span class="status-label">åˆ†ç±»</span>
                <span class="status-value" id="mobileCategoryStatus">å…¨éƒ¨</span>
            </div>
            <div class="status-divider"></div>
            <div class="status-item">
                <span class="status-label">ä»·æ ¼</span>
                <span class="status-value" id="mobilePriceStatus">å…¨éƒ¨</span>
            </div>
        </div>

        <!-- Tabå¯¼èˆªï¼ˆ6ä¸ªTabï¼‰ -->
        <div class="tabs-nav">
            <div class="tab-item active" onclick="switchTab(0)">
                <span class="tab-icon">ğŸ“…</span>
                <span>å…´è¶£ç­</span>
            </div>
            <div class="tab-item" onclick="switchTab(1)">
                <span class="tab-icon">ğŸ“‹</span>
                <span>å¸‚é›†</span>
            </div>
            <div class="tab-item" onclick="switchTab(2)">
                <span class="tab-icon">ğŸµ</span>
                <span>éŸ³ä¹</span>
            </div>
            <div class="tab-item" onclick="switchTab(3)">
                <span class="tab-icon">â°</span>
                <span>çµæ´»æ—¶é—´æ´»åŠ¨</span>
            </div>
            <div class="tab-item" onclick="switchTab(4)">
                <span class="tab-icon">ğŸª</span>
                <span>æ´»åŠ¨ç½‘ç«™</span>
            </div>
            <div class="tab-item" onclick="switchTab(5)">
                <span class="tab-icon">ğŸ“–</span>
                <span>æ”»ç•¥ä¿¡æ¯</span>
            </div>
        </div>

        <!-- Tabå†…å®¹ -->
        <div class="tab-content">
            <!-- å…´è¶£ç­Tab -->
            <div id="tab-0" class="tab-pane active">
                <div class="calendar-header">
                    <div class="nav-row">
                        <div class="month-label" id="monthLabel">æœ¬å‘¨æ´»åŠ¨</div>
                        <div class="nav-buttons">
                            <button class="nav-btn" onclick="navigateWeek(-1)">â† ä¸Šä¸€å‘¨</button>
                            <button class="nav-btn" onclick="goToThisWeek()">å›åˆ°æœ¬å‘¨</button>
                            <button class="nav-btn" onclick="navigateWeek(1)">ä¸‹ä¸€å‘¨ â†’</button>
                        </div>
                    </div>
                    <div class="date-grid-header" id="dateGridHeader">
                        <!-- æ—¥æœŸè¡¨å¤´å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="calendar-grid" id="calendarGrid">
                    <!-- åŠ¨æ€ç”Ÿæˆæ—¥å†å†…å®¹ -->
                </div>
            </div>

            <!-- å¸‚é›†Tab -->
            <div id="tab-1" class="tab-pane">
                <div class="calendar-header">
                    <div class="nav-row">
                        <div class="month-label">æœ¬å‘¨å¸‚é›†</div>
                        <div class="nav-buttons">
                            <button class="nav-btn" onclick="navigateWeek(-1)">â† ä¸Šä¸€å‘¨</button>
                            <button class="nav-btn" onclick="goToThisWeek()">å›åˆ°æœ¬å‘¨</button>
                            <button class="nav-btn" onclick="navigateWeek(1)">ä¸‹ä¸€å‘¨ â†’</button>
                        </div>
                    </div>
                    <div class="date-grid-header" id="dateGridHeaderMarket">
                        <!-- æ—¥æœŸè¡¨å¤´å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="calendar-grid" id="calendarGridMarket">
                    <!-- åŠ¨æ€ç”Ÿæˆæ—¥å†å†…å®¹ -->
                </div>
            </div>

            <!-- éŸ³ä¹Tab -->
            <div id="tab-2" class="tab-pane">
                <div class="calendar-header">
                    <div class="nav-row">
                        <div class="month-label">æœ¬å‘¨éŸ³ä¹æ´»åŠ¨</div>
                        <div class="nav-buttons">
                            <button class="nav-btn" onclick="navigateWeek(-1)">â† ä¸Šä¸€å‘¨</button>
                            <button class="nav-btn" onclick="goToThisWeek()">å›åˆ°æœ¬å‘¨</button>
                            <button class="nav-btn" onclick="navigateWeek(1)">ä¸‹ä¸€å‘¨ â†’</button>
                        </div>
                    </div>
                    <div class="date-grid-header" id="dateGridHeaderMusic">
                        <!-- æ—¥æœŸè¡¨å¤´å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="calendar-grid" id="calendarGridMusic">
                    <!-- åŠ¨æ€ç”Ÿæˆæ—¥å†å†…å®¹ -->
                </div>
            </div>

            <!-- çµæ´»æ—¶é—´æ´»åŠ¨Tab -->
            <div id="tab-3" class="tab-pane">
                <div class="calendar-header">
                    <div class="nav-row">
                        <div class="month-label">çµæ´»æ—¶é—´æ´»åŠ¨</div>
                    </div>
                </div>
                <div class="schedule-list" id="flexibleList">
                    <!-- åŠ¨æ€ç”Ÿæˆåˆ—è¡¨å†…å®¹ -->
                </div>
            </div>

            <!-- æ´»åŠ¨ç½‘ç«™Tab -->
            <div id="tab-4" class="tab-pane">
                <div class="calendar-header">
                    <div class="nav-row">
                        <div class="month-label">æ´»åŠ¨ç½‘ç«™</div>
                    </div>
                </div>
                <div class="websites-container" id="websitesContainer">
                    <!-- åŠ¨æ€ç”Ÿæˆç½‘ç«™é“¾æ¥ -->
                </div>
            </div>

            <!-- æ”»ç•¥ä¿¡æ¯Tab -->
            <div id="tab-5" class="tab-pane">
                <div class="guide-content" id="guideContent" style="padding-top: 12px;">
                    <!-- åŠ¨æ€åŠ è½½æ”»ç•¥å†…å®¹ -->
                </div>
            </div>
                </div>
            </div>
        </div>

        <!-- ç­›é€‰ç»“æœæ•°é‡ -->
        <div class="results-count" id="resultsCount">
            <span>å…± </span>
            <span class="count-number" id="totalCount">0</span>
            <span> ä¸ªæ´»åŠ¨</span>
        </div>

        <!-- ç©ºçŠ¶æ€æç¤º -->
        <div class="empty-state" id="emptyState">
            <div class="empty-icon">ğŸ”</div>
            <div class="empty-title">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ´»åŠ¨</div>
            <div class="empty-description" id="emptyDescription">
                è¯•è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶ï¼Œæˆ–è€…æœç´¢å…¶ä»–å…³é”®è¯ï¼Ÿ
            </div>
            <div class="empty-actions">
                <button class="empty-btn primary" onclick="clearAllFilters()">æ¸…é™¤æ‰€æœ‰ç­›é€‰</button>
                <button class="empty-btn" onclick="clearSearch()">æ¸…ç©ºæœç´¢</button>
            </div>
        </div>

        <!-- æ´»åŠ¨è¯¦æƒ…å¼¹çª— - ä¼˜åŒ–åçš„å±‚çº§ç»“æ„ -->
        <div class="modal-overlay" id="activityModal">
            <div class="modal">
                <!-- å¤´éƒ¨ï¼šæ´»åŠ¨æ ‡é¢˜ -->
                <div class="modal-header">
                    <h2 class="modal-title" id="modalTitle">æ´»åŠ¨æ ‡é¢˜</h2>
                    <button class="modal-close" onclick="closeModal()">Ã—</button>
                </div>

                <!-- å…³é”®ä¿¡æ¯å¡ç‰‡ -->
                <div class="modal-key-info">
                    <div class="info-item">
                        <span class="info-icon">â°</span>
                        <div class="info-text">
                            <strong>æ—¶é—´</strong>
                            <div id="modalTime">08:30-09:45</div>
                        </div>
                    </div>

                    <div class="info-item">
                        <span class="info-icon">ğŸ“</span>
                        <div class="info-text">
                            <strong>åœ°ç‚¹</strong>
                            <div id="modalLocation">åœ°ç‚¹åç§°</div>
                        </div>
                    </div>

                    <div class="info-item">
                        <span class="info-icon">ğŸ’°</span>
                        <div class="info-text">
                            <strong>ä»·æ ¼</strong>
                            <div id="modalPrice">å…è´¹</div>
                        </div>
                    </div>

                    <div class="info-item" id="modalDurationItem" style="display: none;">
                        <span class="info-icon">â±ï¸</span>
                        <div class="info-text">
                            <strong>æ—¶é•¿</strong>
                            <div id="modalDuration">1å°æ—¶</div>
                        </div>
                    </div>
                </div>

                <!-- å†…å®¹åŒºåŸŸ -->
                <div class="modal-body">
                    <!-- åˆ†ç±»æ ‡ç­¾ -->
                    <span class="modal-category-badge" id="modalCategory">åˆ†ç±»</span>

                    <!-- æ´»åŠ¨è¯¦æƒ… -->
                    <div class="modal-section">
                        <h3 class="section-title">ğŸ“ æ´»åŠ¨è¯¦æƒ…</h3>
                        <div class="section-content" id="modalDescription">
                            æ´»åŠ¨æè¿°å†…å®¹...
                        </div>
                    </div>

                    <!-- é¢‘ç‡ä¿¡æ¯ -->
                    <div class="modal-info-row" id="modalFrequencyRow" style="display: none;">
                        <strong>ğŸ“… é¢‘ç‡:</strong>
                        <span id="modalFrequency">æ¯å‘¨</span>
                    </div>
                </div>

                <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
                <div class="modal-footer" id="modalFooter" style="display: none;">
                    <button class="btn-secondary" onclick="closeModal()">å…³é—­</button>
                    <a id="modalLinkButton" href="#" target="_blank" class="btn-primary">
                        æŸ¥çœ‹å®˜ç½‘ â†’
                    </a>
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // åº”ç”¨ç‰ˆæœ¬ç®¡ç†
        // =====================================================

        /**
         * ä»APIè·å–åº”ç”¨ç‰ˆæœ¬å·
         */
        async function getAppVersion() {
            try {
                const response = await fetch('/app/version');
                const result = await response.json();
                if (result.success) {
                    return result.version;
                }
                return 'v1.0.0'; // é»˜è®¤ç‰ˆæœ¬
            } catch (error) {
                console.warn('æ— æ³•è·å–åº”ç”¨ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬');
                return 'v1.0.0';
            }
        }

        /**
         * æ£€æŸ¥åº”ç”¨ç‰ˆæœ¬å¹¶æç¤ºç”¨æˆ·åˆ·æ–°
         */
        async function checkAppVersion() {
            const APP_VERSION = await getAppVersion();
            const storedVersion = localStorage.getItem('chiengmai_app_version');

            // å¦‚æœç‰ˆæœ¬ä¸åŒï¼Œæç¤ºç”¨æˆ·åˆ·æ–°
            if (storedVersion && storedVersion !== APP_VERSION) {
                console.log('ğŸ”„ åº”ç”¨ç‰ˆæœ¬å·²æ›´æ–°:', storedVersion, 'â†’', APP_VERSION);

                // æ˜¾ç¤ºç‰ˆæœ¬æ›´æ–°æç¤º
                const versionNotice = document.createElement('div');
                versionNotice.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 12px 20px;
                    text-align: center;
                    font-size: 14px;
                    font-weight: 600;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    z-index: 99999;
                    animation: slideDown 0.3s ease-out;
                `;
                versionNotice.innerHTML = `
                    ğŸ‰ åº”ç”¨å·²æ›´æ–°åˆ° ${APP_VERSION}
                    <span style="margin-left: 20px; cursor: pointer; opacity: 0.9;" onclick="this.parentElement.remove()">âœ• å…³é—­</span>
                `;
                document.body.appendChild(versionNotice);

                // æ»‘å…¥åŠ¨ç”»
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideDown {
                        from { transform: translateY(-100%); }
                        to { transform: translateY(0); }
                    }
                `;
                document.head.appendChild(style);

                // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                setTimeout(() => {
                    if (versionNotice.parentElement) {
                        versionNotice.remove();
                    }
                }, 10000); // 10ç§’åæ¶ˆå¤±
            }

            // ä¿å­˜å½“å‰ç‰ˆæœ¬
            localStorage.setItem('chiengmai_app_version', APP_VERSION);

            console.log('ğŸ“¦ å½“å‰åº”ç”¨ç‰ˆæœ¬:', APP_VERSION);
            console.log('ğŸ’¡ æç¤º: å¦‚é‡åˆ°æ˜¾ç¤ºé—®é¢˜ï¼Œè¯·å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼ˆCtrl+Shift+R æˆ– Cmd+Shift+Rï¼‰');
        }

        // =====================================================
        // =====================================================
        // æ•°æ®è·å–
        // =====================================================

        let allActivities = [];
        let currentFilters = {
            category: 'å…¨éƒ¨',
            price: 'å…¨éƒ¨',
            day: null, // é€‰ä¸­çš„æ—¥æœŸï¼ˆ0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­ï¼‰
            search: ''
        };

        // è·å–ä»Šå¤©çš„æ˜ŸæœŸå‡ ï¼ˆ0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­ï¼‰
        const todayDay = new Date().getDay();

        // ä¿å­˜å½“å‰å‘¨çš„æ—¥æœŸæ•°æ®ï¼ˆå…¨å±€ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨ï¼‰
        let weekDates = [];

        // å½“å‰å‘¨çš„åç§»é‡ï¼ˆ0=æœ¬å‘¨, -1=ä¸Šå‘¨, 1=ä¸‹å‘¨ï¼‰
        let currentWeekOffset = 0;

        const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

        // å…´è¶£ç­TabåŒ…å«çš„åˆ†ç±»ï¼ˆç™½åå•ï¼‰
        const interestCategories = ['ç‘œä¼½', 'å†¥æƒ³', 'èˆè¹ˆ', 'æ³°æ‹³', 'éŸ³ä¹', 'æ–‡åŒ–è‰ºæœ¯', 'å¥èº«'];

        const categoryColors = {
            'ç‘œä¼½': '#FF6B6B',
            'å†¥æƒ³': '#4ECDC4',
            'æˆ·å¤–æ¢é™©': '#FFE66D',
            'æ–‡åŒ–è‰ºæœ¯': '#95E1D3',
            'ç¾é£Ÿä½“éªŒ': '#F38181',
            'èŠ‚åº†æ´»åŠ¨': '#AA96DA',
            'å…¶ä»–': '#667eea'
        };

        // é¢„è®¾çš„æ´»åŠ¨é¢œè‰²ç»„ï¼ˆæ´»æ³¼æ˜äº®çš„é¢œè‰²ï¼‰
        const activityColorPalette = [
            '#FF6B6B', // é²œçº¢
            '#4ECDC4', // é’è‰²
            '#45B7D1', // å¤©è“
            '#FFA07A', // æ©™ç²‰
            '#98D8C8', // è–„è·ç»¿
            '#F7DC6F', // æ˜é»„
            '#BB8FCE', // æ·¡ç´«
            '#85C1E9', // æµ…è“
            '#F1948A', // çŠç‘šçº¢
            '#82E0AA', // ç»¿è‰²
            '#E59866', // æ©™è‰²
            '#D7BDE2', // æ·¡ç´«å…°
            '#A3E4D7', // è“ç»¿
            '#FAD7A0', // æé»„
            '#F5B7B1', // ç²‰çº¢
            '#AED6F1', // æ·¡å¤©è“
            '#ABEBC6', // è‰ç»¿
            '#F9E79F', // æ·¡é»„
            '#D2B4DE', // å…°ç´«
            '#E8DAEF', // æµ…ç´«
            '#73C6B6', // é’ç»¿
            '#F0B27A', // é‡‘æ©™
            '#C39BD3', // ç´«ç½—å…°
            '#7FB3D5', // ä¸­è“
            '#76D7C4', // é’è‰²
            '#FADBD8', // æµ…ç²‰
            '#D5F5E3', // æ·¡ç»¿
            '#FCF3CF', // æµ…é»„
            '#EBDEF0', // æ·¡ç´«
            '#D6EAF8', // æµ…è“
            '#D1F2EB', // æ·¡é’
            '#FF9FF3', // äº®ç²‰
            '#54A0FF', // äº®è“
            '#5FFF67', // äº®ç»¿
            '#FFD93D', // é‡‘é»„
            '#6BCB77', // é²œç»¿
            '#4D96FF', // é²œè“
            '#FF6B9D', // ç«çº¢
            '#C44DFF', // äº®ç´«
            '#FFB84D', // æ´»åŠ›æ©™
            '#00D9FF', // é’è“
            '#FF5E78'  // æ´»åŠ›çº¢
        ];

        // æ ¹æ®æ´»åŠ¨IDè·å–é¢œè‰²ï¼ˆä½¿ç”¨é¢„è®¾è‰²æ¿ï¼‰
        const activityColorsCache = {};
        function getActivityColor(id) {
            if (activityColorsCache[id]) {
                return activityColorsCache[id];
            }

            // ä½¿ç”¨IDç”Ÿæˆç´¢å¼•ï¼Œç¡®ä¿åŒä¸€æ´»åŠ¨æ€»æ˜¯è·å¾—ç›¸åŒé¢œè‰²
            const hash = id.toString().split('').reduce((acc, char) => {
                return acc + char.charCodeAt(0);
            }, 0);

            const colorIndex = hash % activityColorPalette.length;
            const color = activityColorPalette[colorIndex];

            activityColorsCache[id] = color;
            return color;
        }

        // ä» API è·å–æ´»åŠ¨æ•°æ®
        async function fetchActivities() {
            try {
                const response = await fetch('http://localhost:3000/api/activities?limit=1000');
                const result = await response.json();

                if (result.success && result.data) {
                    // å¤„ç†æ´»åŠ¨æ•°æ®ï¼šä¸ºæ¯ä¸ªæ˜ŸæœŸåˆ›å»ºå•ç‹¬çš„æ´»åŠ¨å‰¯æœ¬
                    // åŒæ—¶è¿‡æ»¤æ‰æš‚åœå’Œè‰ç¨¿çŠ¶æ€çš„æ´»åŠ¨
                allActivities = [];
                result.data.forEach(item => {
                    // è¿‡æ»¤æ‰é"è¿›è¡Œä¸­"çŠ¶æ€çš„æ´»åŠ¨
                    if (item.status !== 'è¿›è¡Œä¸­') {
                        console.log('ğŸš« è¿‡æ»¤æ´»åŠ¨:', item.title, 'çŠ¶æ€:', item.status);
                        return; // è·³è¿‡suspendedå’ŒdraftçŠ¶æ€çš„æ´»åŠ¨
                    }
                    const days = parseDaysFromWeekdays(item.weekdays);

                    // å¦‚æœæœ‰å¤šä¸ªæ˜ŸæœŸï¼Œä¸ºæ¯ä¸ªæ˜ŸæœŸåˆ›å»ºä¸€ä¸ªå‰¯æœ¬
                    if (days && days.length > 0) {
                        days.forEach(day => {
                          allActivities.push({
                            id: item.id || item._id,
                            originalId: item.id || item._id, // ä¿å­˜åŸå§‹IDç”¨äºè¯¦æƒ…æŸ¥çœ‹
                            name: item.title,
                            title: item.title,
                            category: item.category,
                            price: item.price,
                            location: item.location,
                            time: item.time,
                            description: item.description,
                            day: day,
                            frequency: item.frequency || 'weekly',
                            source: item.source || null, // ä¿å­˜å®Œæ•´çš„sourceå¯¹è±¡
                            flexibleTime: item.flexibleTime || 'å¦'
                          });
                        });
                      } else {
                        // æ²¡æœ‰æ˜ŸæœŸä¿¡æ¯æˆ–ä¸´æ—¶æ´»åŠ¨ï¼Œä¿æŒåŸæ ·
                        allActivities.push({
                          id: item.id || item._id,
                          name: item.title,
                          title: item.title,
                          category: item.category,
                          price: item.price,
                          location: item.location,
                          time: item.time,
                          description: item.description,
                          day: null,
                          frequency: 'once',
                          source: item.source || null, // ä¿å­˜å®Œæ•´çš„sourceå¯¹è±¡
                          flexibleTime: item.flexibleTime || 'å¦'
                        });
                      }
                });

                console.log('ğŸ“¦ æ´»åŠ¨æ•°æ®å¤„ç†å®Œæˆ:');
                console.log('  - APIè¿”å›:', result.data.length, 'ä¸ªæ´»åŠ¨');
                console.log('  - åˆ›å»ºå‰¯æœ¬:', allActivities.length, 'ä¸ªæ´»åŠ¨è®°å½•');
                console.log('  - æŒ‰æ—¥æœŸåˆ†å¸ƒ:');
                for (let i = 0; i < 7; i++) {
                  const count = allActivities.filter(a => a.day === i).length;
                  const dayName = i === 0 ? 'å‘¨æ—¥' : ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][i-1];
                  console.log(`    ${dayName}: ${count} ä¸ªæ´»åŠ¨`);
                }

                // æ›´æ–°Tabæ•°é‡
                updateTabCounts();

                    // åˆå§‹åŒ–åˆ†ç±»ç­›é€‰å™¨
                    initCategoryFilters();

                    // é»˜è®¤é€‰ä¸­Tab 0ï¼ˆå…´è¶£ç­ï¼‰
                    currentTab = 0;

                    // åˆ·æ–° = é‡ç½®ä¸º"å…¨éƒ¨"çŠ¶æ€ï¼Œæ˜¾ç¤ºå½“å‰Tabçš„æ´»åŠ¨
                    // ä¸é»˜è®¤é€‰ä¸­ä»»ä½•æ—¥æœŸï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®Œæ•´çš„å‘¨è§†å›¾
                    currentFilters.day = null;
                    currentFilters.category = 'å…¨éƒ¨';
                    currentFilters.price = 'å…¨éƒ¨';
                    currentFilters.search = '';

                    console.log('ğŸ“ é»˜è®¤é€‰ä¸­Tab 0ï¼ˆå…´è¶£ç­ï¼‰');

                    // æ¸²æŸ“è§†å›¾ï¼ˆä¼šæ ¹æ®currentTabè‡ªåŠ¨ç­›é€‰ï¼‰
                    updateViews();

                    console.log('âœ… å·²åŠ è½½', allActivities.length, 'ä¸ªæ´»åŠ¨');
                    console.log('ğŸ“… ä»Šå¤©æ˜¯:', dayNames[todayDay]);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½å¤±è´¥:', error);
                document.getElementById('calendarGrid').innerHTML =
                    '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
            }
        }

        // è§£æ weekdays æ•°ç»„è·å–æ‰€æœ‰ day æ•°å­—
        function parseDaysFromWeekdays(weekdays) {
            if (!weekdays || !Array.isArray(weekdays)) return [];

            const dayMap = { 'å‘¨æ—¥': 0, 'å‘¨ä¸€': 1, 'å‘¨äºŒ': 2, 'å‘¨ä¸‰': 3, 'å‘¨å››': 4, 'å‘¨äº”': 5, 'å‘¨å…­': 6 };
            const days = [];

            // è¿”å›æ‰€æœ‰åŒ¹é…çš„ day
            for (let day of weekdays) {
                if (dayMap[day] !== undefined) {
                  days.push(dayMap[day]);
                }
            }
            return days;
        }

        // è§£æ weekdays æ•°ç»„è·å– day æ•°å­—ï¼ˆä¿ç•™åŸå‡½æ•°ç”¨äºè¯¦æƒ…æ˜¾ç¤ºï¼‰
        function parseDayFromWeekdays(weekdays) {
            const days = parseDaysFromWeekdays(weekdays);
            return days && days.length > 0 ? days[0] : null;
        }

        // =====================================================
        // æ—¶é—´æ’åºå·¥å…·å‡½æ•°
        // =====================================================

        /**
         * æå–æ—¶é—´çš„å¼€å§‹éƒ¨åˆ†
         * @param {string} timeStr - æ—¶é—´å­—ç¬¦ä¸²ï¼Œå¦‚ "16:00-19:00"
         * @returns {object} - { hour, minute, original }
         */
        function extractStartTime(timeStr) {
            if (!timeStr || timeStr === 'çµæ´»æ—¶é—´') {
                return { hour: 99, minute: 99, original: timeStr || 'çµæ´»æ—¶é—´' };
            }

            // æå–ç¬¬ä¸€ä¸ªæ—¶é—´ HH:MM
            const match = timeStr.match(/^(\d{1,2}):(\d{2})/);
            if (match) {
                return {
                    hour: parseInt(match[1], 10),
                    minute: parseInt(match[2], 10),
                    original: timeStr
                };
            }

            return { hour: 99, minute: 99, original: timeStr };
        }

        /**
         * æå–æ—¶é—´çš„ç»“æŸéƒ¨åˆ†
         * @param {string} timeStr - æ—¶é—´å­—ç¬¦ä¸²ï¼Œå¦‚ "16:00-19:00"
         * @returns {object} - { hour, minute, isOvernight }
         */
        function extractEndTime(timeStr) {
            if (!timeStr || timeStr === 'çµæ´»æ—¶é—´') {
                return { hour: 99, minute: 99, isOvernight: false, original: timeStr || 'çµæ´»æ—¶é—´' };
            }

            // æŸ¥æ‰¾ç»“æŸæ—¶é—´éƒ¨åˆ†ï¼ˆç¬¬äºŒä¸ªæ—¶é—´ï¼‰
            const parts = timeStr.split('-');
            if (parts.length >= 2) {
                const endTimeStr = parts[1].trim();
                const match = endTimeStr.match(/^(\d{1,2}):(\d{2})/);
                if (match) {
                    let hour = parseInt(match[1], 10);
                    let minute = parseInt(match[2], 10);
                    let isOvernight = false;

                    // ç‰¹æ®Šå¤„ç†ï¼š00:00 è¡¨ç¤ºå½“å¤©çš„24:00ï¼ˆæœ€æ™šï¼‰
                    if (hour === 0 && minute === 0) {
                        hour = 24;
                        minute = 0;
                        isOvernight = true;
                    }

                    return { hour, minute, isOvernight, original: endTimeStr };
                }
            }

            // å¦‚æœæ²¡æœ‰ç»“æŸæ—¶é—´ï¼ˆå•ä¸€æ—¶é—´ç‚¹ï¼‰ï¼Œè¿”å›å¼€å§‹æ—¶é—´
            const start = extractStartTime(timeStr);
            return { hour: start.hour, minute: start.minute, isOvernight: false, original: timeStr };
        }

        /**
         * æ¯”è¾ƒä¸¤ä¸ªæ—¶é—´å­—ç¬¦ä¸²
         * @param {string} timeA - æ—¶é—´A
         * @param {string} timeB - æ—¶é—´B
         * @returns {number} - -1 (Aåœ¨å‰), 0 (ç›¸åŒ), 1 (Båœ¨å‰)
         */
        function compareTimes(timeA, timeB) {
            const extractedA = extractStartTime(timeA);
            const extractedB = extractStartTime(timeB);

            // ä¼˜å…ˆçº§1: æŒ‰å¼€å§‹æ—¶é—´çš„æ•°å­—å€¼æ¯”è¾ƒ
            if (extractedA.hour !== extractedB.hour) {
                return extractedA.hour - extractedB.hour;
            }

            if (extractedA.minute !== extractedB.minute) {
                return extractedA.minute - extractedB.minute;
            }

            // å¼€å§‹æ—¶é—´ç›¸åŒï¼Œç»§ç»­æ¯”è¾ƒ
            // ä¼˜å…ˆçº§2: å•ä¸€æ—¶é—´ç‚¹æ’åœ¨æ—¶é—´æ®µå‰é¢
            const isRangeA = extractedA.original.includes('-');
            const isRangeB = extractedB.original.includes('-');

            if (isRangeA && !isRangeB) return 1;   // Aæ˜¯èŒƒå›´ï¼ŒBæ˜¯ç‚¹ â†’ Båœ¨å‰
            if (!isRangeA && isRangeB) return -1;  // Aæ˜¯ç‚¹ï¼ŒBæ˜¯èŒƒå›´ â†’ Aåœ¨å‰

            // ä¼˜å…ˆçº§3: å¦‚æœéƒ½æ˜¯æ—¶é—´æ®µï¼ˆæˆ–éƒ½æ˜¯å•ä¸€æ—¶é—´ç‚¹ï¼‰ï¼ŒæŒ‰ç»“æŸæ—¶é—´æ’åº
            if (isRangeA && isRangeB) {
                const endA = extractEndTime(extractedA.original);
                const endB = extractEndTime(extractedB.original);

                // æŒ‰ç»“æŸæ—¶é—´æ’åºï¼ˆæ—©ç»“æŸçš„åœ¨å‰ï¼‰
                if (endA.hour !== endB.hour) {
                    return endA.hour - endB.hour;
                }

                if (endA.minute !== endB.minute) {
                    return endA.minute - endB.minute;
                }

                // ç»“æŸæ—¶é—´ä¹Ÿç›¸åŒï¼Œä¿æŒåŸé¡ºåº
                return 0;
            }

            // éƒ½æ˜¯å•ä¸€æ—¶é—´ç‚¹ï¼Œä¿æŒåŸé¡ºåº
            return 0;
        }

        // æ›´æ–°Tabæ•°é‡æ˜¾ç¤ºï¼ˆä»…ç”¨äºæ§åˆ¶å°è°ƒè¯•ï¼‰
        function updateTabCounts() {
            // å…´è¶£ç­ï¼šç‘œä¼½ã€å†¥æƒ³ã€èˆè¹ˆã€æ³°æ‹³ã€æ–‡åŒ–è‰ºæœ¯ã€å¥èº«ï¼ˆæ’é™¤éŸ³ä¹ï¼‰
            const interestCategories = ['ç‘œä¼½', 'å†¥æƒ³', 'èˆè¹ˆ', 'æ³°æ‹³', 'æ–‡åŒ–è‰ºæœ¯', 'å¥èº«'];
            const interestActivities = allActivities.filter(a =>
                interestCategories.includes(a.category)
            );

            // å¸‚é›†
            const marketActivities = allActivities.filter(a =>
                a.category === 'å¸‚é›†'
            );

            // éŸ³ä¹
            const musicActivities = allActivities.filter(a =>
                a.category === 'éŸ³ä¹'
            );

            // çµæ´»æ—¶é—´æ´»åŠ¨
            const flexibleActivities = allActivities.filter(a =>
                a.flexibleTime === 'æ˜¯' || a.time === 'çµæ´»æ—¶é—´'
            );

            // æ´»åŠ¨ç½‘ç«™ï¼šæœ‰sourceå­—æ®µä¸”åŒ…å«urlçš„æ´»åŠ¨
            const websiteActivities = allActivities.filter(a =>
                a.source && a.source.url && a.source.url.length > 0
            );

            console.log('ğŸ“Š Tabæ•°é‡ç»Ÿè®¡ï¼ˆæ§åˆ¶å°ï¼‰:');
            console.log('  - å…´è¶£ç­:', interestActivities.length);
            console.log('  - å¸‚é›†:', marketActivities.length);
            console.log('  - éŸ³ä¹:', musicActivities.length);
            console.log('  - çµæ´»æ—¶é—´æ´»åŠ¨:', flexibleActivities.length);
            console.log('  - æ´»åŠ¨ç½‘ç«™:', websiteActivities.length);
            console.log('  - æ”»ç•¥ä¿¡æ¯: 1 (é¡µé¢)');
        }

        // åˆå§‹åŒ–åˆ†ç±»ç­›é€‰å™¨
        function initCategoryFilters() {
            // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿allActivitieså·²åŠ è½½
            if (!allActivities || allActivities.length === 0) {
                console.warn("âš ï¸ allActivitiesä¸ºç©ºï¼Œ100msåé‡è¯•åˆå§‹åŒ–åˆ†ç±»ç­›é€‰å™¨");
                setTimeout(initCategoryFilters, 100);
                return;
            }

            const categories = [...new Set(allActivities.map(a => a.category))];
            const container = document.getElementById('categoryChips');

            let html = '<div class="filter-chip active" onclick="setFilter(\'category\', \'å…¨éƒ¨\')">å…¨éƒ¨</div>';
            categories.forEach(cat => {
                html += `<div class="filter-chip" onclick="setFilter('category', '${cat}')">${cat}</div>`;
            });

            container.innerHTML = html;
            console.log("âœ… åˆ†ç±»ç­›é€‰å™¨å·²åˆå§‹åŒ–ï¼Œå…±", categories.length, "ä¸ªåˆ†ç±»:", categories.join(', '));
        }

        // =====================================================
        // ç­›é€‰åŠŸèƒ½
        // =====================================================

        function filterActivities() {
            let filtered = allActivities;

            console.log('ğŸ” å¼€å§‹ç­›é€‰, å½“å‰ç­›é€‰æ¡ä»¶:', currentFilters);
            console.log('ğŸ“Š æ€»æ´»åŠ¨æ•°:', allActivities.length);

            // è¿‡æ»¤æ‰æš‚åœçš„æ´»åŠ¨
            const beforeSuspendFilter = filtered.length;
            filtered = filtered.filter(a => a.status !== 'suspended');
            console.log(`â¸ï¸ æš‚åœæ´»åŠ¨è¿‡æ»¤: ${beforeSuspendFilter} â†’ ${filtered.length} (æ’é™¤ ${beforeSuspendFilter - filtered.length} ä¸ª)`);

            // æ ¹æ®å½“å‰Tabç­›é€‰æ•°æ®
            switch(currentTab) {
                case 0: // å…´è¶£ç­ - æ’é™¤æ³•ï¼šæ’é™¤å¸‚é›†ã€éŸ³ä¹å’Œçµæ´»æ—¶é—´æ´»åŠ¨
                    filtered = filtered.filter(a => {
                        // æ’é™¤å¸‚é›†
                        if (a.category === 'å¸‚é›†') return false;
                        // æ’é™¤éŸ³ä¹
                        if (a.category === 'éŸ³ä¹') return false;
                        // æ’é™¤çµæ´»æ—¶é—´æ´»åŠ¨
                        if (a.flexibleTime === 'æ˜¯' || a.time === 'çµæ´»æ—¶é—´') return false;
                        return true;
                    });
                    console.log('ğŸ“… Tabç­›é€‰ - å…´è¶£ç­ (å›ºå®šæ—¶é—´ï¼Œæ’é™¤å¸‚é›†ã€éŸ³ä¹):', filtered.length);
                    break;

                case 1: // å¸‚é›†
                    filtered = filtered.filter(a => a.category === 'å¸‚é›†');
                    console.log('ğŸ“‹ Tabç­›é€‰ - å¸‚é›†:', filtered.length);
                    break;

                case 2: // éŸ³ä¹
                    filtered = filtered.filter(a => a.category === 'éŸ³ä¹');
                    console.log('ğŸµ Tabç­›é€‰ - éŸ³ä¹:', filtered.length);
                    break;

                case 3: // çµæ´»æ—¶é—´æ´»åŠ¨
                    filtered = filtered.filter(a => a.flexibleTime === 'æ˜¯' || a.time === 'çµæ´»æ—¶é—´');
                    console.log('â° Tabç­›é€‰ - çµæ´»æ—¶é—´æ´»åŠ¨:', filtered.length);
                    break;

                case 4: // æ´»åŠ¨ç½‘ç«™
                    console.log('ğŸª Tab 4 ç­›é€‰å¼€å§‹ï¼Œæ€»æ•°:', filtered.length);
                    const beforeFilter = filtered.length;
                    filtered = filtered.filter(a => {
                        const hasSource = a.source && a.source.url && a.source.url.length > 0;
                        if (!hasSource && a.source) {
                            console.log('  âš ï¸', a.title, 'æœ‰ source ä½†æ—  url:', a.source);
                        }
                        return hasSource;
                    });
                    console.log('ğŸª Tabç­›é€‰ - æ´»åŠ¨ç½‘ç«™:', beforeFilter, 'â†’', filtered.length);
                    if (filtered.length > 0) {
                        console.log('  å‰3ä¸ªæ´»åŠ¨:', filtered.slice(0, 3).map(a => a.title));
                    }
                    break;

                case 5: // æ”»ç•¥ä¿¡æ¯ - ä¸éœ€è¦ç­›é€‰
                    console.log('ğŸ“– Tabç­›é€‰ - æ”»ç•¥ä¿¡æ¯: æ— éœ€ç­›é€‰');
                    return [];
            }

            // æ—¥æœŸç­›é€‰
            if (currentFilters.day !== null) {
                const beforeDayFilter = filtered.length;
                filtered = filtered.filter(act => act.day === currentFilters.day);
                console.log(`ğŸ“… æ—¥æœŸç­›é€‰ (day=${currentFilters.day}): ${beforeDayFilter} â†’ ${filtered.length}`);
            }

            // åˆ†ç±»ç­›é€‰
            if (currentFilters.category !== 'å…¨éƒ¨') {
                const beforeCategoryFilter = filtered.length;
                filtered = filtered.filter(act => act.category === currentFilters.category);
                console.log(`ğŸ·ï¸ åˆ†ç±»ç­›é€‰ (${currentFilters.category}): ${beforeCategoryFilter} â†’ ${filtered.length}`);
            }

            // ä»·æ ¼ç­›é€‰
            // è¾…åŠ©å‡½æ•°ï¼šæå–ä»·æ ¼æ•°å€¼
            const extractPrice = (priceStr) => {
                if (priceStr === 'å…è´¹' || priceStr.includes('å…è´¹')) return 0;
                return parseInt(priceStr.replace(/[^\d]/g, '')) || 0;
            };

            if (currentFilters.price === 'å…è´¹') {
                filtered = filtered.filter(act => act.price === 'å…è´¹' || act.price.includes('å…è´¹'));
            } else if (currentFilters.price === '<500à¸¿') {
                filtered = filtered.filter(act => extractPrice(act.price) < 500);
            } else if (currentFilters.price === '<1000à¸¿') {
                filtered = filtered.filter(act => extractPrice(act.price) < 1000);
            } else if (currentFilters.price === '<1500à¸¿') {
                filtered = filtered.filter(act => extractPrice(act.price) < 1500);
            } else if (currentFilters.price === '>1500à¸¿') {
                filtered = filtered.filter(act => extractPrice(act.price) >= 1500);
            }

            // æœç´¢ç­›é€‰
            if (currentFilters.search) {
                const searchLower = currentFilters.search.toLowerCase();
                filtered = filtered.filter(act =>
                    act.title.toLowerCase().includes(searchLower) ||
                    act.location.toLowerCase().includes(searchLower) ||
                    act.description.toLowerCase().includes(searchLower)
                );
            }

            return filtered;
        }

        function setFilter(type, value) {
            if (type === 'category') {
                currentFilters.category = value;
                // æ›´æ–° UI
                document.querySelectorAll('#categoryChips .filter-chip').forEach(chip => {
                    chip.classList.remove('active');
                    if (chip.textContent.trim() === value) chip.classList.add('active');
                });
            } else if (type === 'price') {
                currentFilters.price = value;
                // æ›´æ–° UI
                const priceGroup = document.querySelectorAll('.filter-group')[1];
                priceGroup.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.classList.remove('active');
                    if (chip.textContent.trim() === value) chip.classList.add('active');
                });
            }

            updateViews();
        }

        // ========== H5å‘¨è§†å›¾æ»šåŠ¨è‡ªåŠ¨é€‰ä¸­åŠŸèƒ½ ==========

        // å­˜å‚¨Intersection Observerå®ä¾‹ï¼Œç”¨äºæ¸…ç†
        let h5ScrollObserver = null;
        let h5AutoSelectTimeout = null;
        let lastSelectedDay = null;

        // å­˜å‚¨æ»šåŠ¨ç›‘å¬å™¨ï¼Œç”¨äºæ¸…ç†
        let h5ScrollListener = null;
        let h5ScrollHighlightTimeout = null;

        /**
         * åˆå§‹åŒ–H5å‘¨è§†å›¾çš„æ»šåŠ¨è‡ªåŠ¨é€‰ä¸­åŠŸèƒ½
         * @param {string} gridId - ç½‘æ ¼å®¹å™¨ID
         */
        function initH5ScrollAutoSelect(gridId) {
            // æ¸…ç†æ—§çš„observer
            if (h5ScrollObserver) {
                h5ScrollObserver.disconnect();
                h5ScrollObserver = null;
            }

            // è·å–æ‰€æœ‰å¤©æ•°å¡ç‰‡
            const dayCells = document.querySelectorAll(`#${gridId} .day-cell`);
            if (dayCells.length === 0) {
                console.log('â„¹ï¸ æœªæ‰¾åˆ°å¤©æ•°å¡ç‰‡ï¼Œè·³è¿‡æ»šåŠ¨æ£€æµ‹åˆå§‹åŒ–');
                return;
            }

            console.log('ğŸ“± åˆå§‹åŒ–H5å‘¨è§†å›¾æ»šåŠ¨è‡ªåŠ¨é€‰ä¸­åŠŸèƒ½');

            // åˆ›å»ºIntersection Observer
            h5ScrollObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    // å½“å¡ç‰‡å æ®å±å¹•50%ä»¥ä¸Šæ—¶
                    if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
                        const day = parseInt(entry.target.getAttribute('data-day'));

                        // é¿å…é‡å¤é€‰ä¸­åŒä¸€å¤©
                        if (day !== lastSelectedDay && day !== null && !isNaN(day)) {
                            // é˜²æŠ–åŠ¨ï¼šæ»šåŠ¨åœæ­¢500msåæ‰è§¦å‘
                            if (h5AutoSelectTimeout) {
                                clearTimeout(h5AutoSelectTimeout);
                            }

                            h5AutoSelectTimeout = setTimeout(() => {
                                autoSelectDayInView(day);
                            }, 500);
                        }
                    }
                });
            }, {
                // å½“å¡ç‰‡å æ®50%æ—¶è§¦å‘
                threshold: [0.5],
                // è®¾ç½®æ ¹å…ƒç´ ä¸ºè§†å£
                rootMargin: '0px'
            });

            // è§‚å¯Ÿæ‰€æœ‰å¤©æ•°å¡ç‰‡
            dayCells.forEach(cell => {
                h5ScrollObserver.observe(cell);
            });

            console.log(`âœ… å·²ä¸º ${dayCells.length} ä¸ªå¤©æ•°å¡ç‰‡æ·»åŠ æ»šåŠ¨æ£€æµ‹`);
        }

        /**
         * è‡ªåŠ¨é€‰ä¸­è§†é‡ä¸­çš„æŸä¸€å¤©
         * @param {number} day - å¤©æ•°ï¼ˆ0-6ï¼Œ0=å‘¨æ—¥ï¼‰
         */
        function autoSelectDayInView(day) {
            // é¿å…é‡å¤é€‰ä¸­
            if (currentFilters.day === day) {
                return;
            }

            console.log(`ğŸ¯ è‡ªåŠ¨é€‰ä¸­: ${day} (${dayNames[day]})`);

            // æ›´æ–°ç­›é€‰çŠ¶æ€
            currentFilters.day = day;
            lastSelectedDay = day;

            // æ˜¾ç¤ºè‡ªåŠ¨é€‰ä¸­æç¤º
            showAutoSelectToast(day);

            // æ›´æ–°è§†å›¾ï¼ˆä¼šåˆ‡æ¢åˆ°å•æ—¥è¯¦ç»†è§†å›¾ï¼‰
            updateViews();

            // é‡æ–°åˆå§‹åŒ–æ»šåŠ¨æ£€æµ‹ï¼ˆå•æ—¥è§†å›¾ä¸éœ€è¦ï¼‰
            if (h5ScrollObserver) {
                h5ScrollObserver.disconnect();
                h5ScrollObserver = null;
            }
        }

        /**
         * æ˜¾ç¤ºè‡ªåŠ¨é€‰ä¸­æç¤º
         * @param {number} day - é€‰ä¸­çš„å¤©æ•°
         */
        function showAutoSelectToast(day) {
            // ç§»é™¤æ—§çš„æç¤º
            const oldToast = document.querySelector('.h5-auto-select-toast');
            if (oldToast) {
                oldToast.remove();
            }

            // åˆ›å»ºæ–°çš„æç¤º
            const toast = document.createElement('div');
            toast.className = 'h5-auto-select-toast';
            toast.innerHTML = `âœ¨ å·²è‡ªåŠ¨é€‰ä¸­ ${dayNames[day]}`;

            // æ·»åŠ æ ·å¼
            Object.assign(toast.style, {
                position: 'fixed',
                top: '60px',
                left: '50%',
                transform: 'translateX(-50%)',
                backgroundColor: 'rgba(102, 126, 234, 0.95)',
                color: 'white',
                padding: '10px 20px',
                borderRadius: '20px',
                fontSize: '14px',
                fontWeight: '500',
                boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
                zIndex: '9999',
                opacity: '0',
                transition: 'opacity 0.3s ease, transform 0.3s ease',
                pointerEvents: 'none'
            });

            document.body.appendChild(toast);

            // è§¦å‘æ·¡å…¥åŠ¨ç”»
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(0)';
            });

            // 2ç§’åæ·¡å‡ºå¹¶ç§»é™¤
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(-10px)';

                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 2000);

            console.log(`ğŸ’¡ æ˜¾ç¤ºæç¤º: å·²è‡ªåŠ¨é€‰ä¸­ ${dayNames[day]}`);
        }

        /**
         * æ¸…ç†H5æ»šåŠ¨æ£€æµ‹
         */
        function cleanupH5ScrollObserver() {
            if (h5ScrollObserver) {
                h5ScrollObserver.disconnect();
                h5ScrollObserver = null;
                console.log('ğŸ§¹ å·²æ¸…ç†H5æ»šåŠ¨æ£€æµ‹');
            }

            if (h5AutoSelectTimeout) {
                clearTimeout(h5AutoSelectTimeout);
                h5AutoSelectTimeout = null;
            }

            // æ¸…ç†æ»šåŠ¨ç›‘å¬å™¨
            if (h5ScrollListener) {
                const gridElement = document.getElementById('calendarGrid');
                if (gridElement) {
                    gridElement.removeEventListener('scroll', h5ScrollListener);
                }
                h5ScrollListener = null;
                console.log('ğŸ§¹ å·²æ¸…ç†æ»šåŠ¨ç›‘å¬å™¨');
            }

            if (h5ScrollHighlightTimeout) {
                clearTimeout(h5ScrollHighlightTimeout);
                h5ScrollHighlightTimeout = null;
            }

            // ç§»é™¤æç¤º
            const toast = document.querySelector('.h5-auto-select-toast');
            if (toast) {
                toast.remove();
            }
        }

        /**
         * åˆå§‹åŒ–H5å‘¨è§†å›¾æ»šåŠ¨æ—¥æœŸé«˜äº®åŠŸèƒ½
         * æ ¹æ®å¯è§†åŒºåŸŸå†…çš„æ´»åŠ¨è‡ªåŠ¨é«˜äº®å¯¹åº”çš„æ—¥æœŸæŒ‰é’®
         * @param {string} gridId - ç½‘æ ¼å®¹å™¨ID
         */
        function initH5ScrollDateHighlight(gridId) {
            // æ¸…ç†æ—§çš„ç›‘å¬å™¨
            if (h5ScrollListener) {
                const gridElement = document.getElementById(gridId);
                if (gridElement) {
                    gridElement.removeEventListener('scroll', h5ScrollListener);
                }
                h5ScrollListener = null;
            }

            // è·å–ç½‘æ ¼å®¹å™¨
            const gridElement = document.getElementById(gridId);
            if (!gridElement) {
                console.log('â„¹ï¸ æœªæ‰¾åˆ°ç½‘æ ¼å®¹å™¨ï¼Œè·³è¿‡æ»šåŠ¨æ—¥æœŸé«˜äº®åˆå§‹åŒ–');
                return;
            }

            // è·å–æ‰€æœ‰å¤©æ•°å¡ç‰‡
            const dayCells = document.querySelectorAll(`#${gridId} .day-cell`);
            if (dayCells.length === 0) {
                console.log('â„¹ï¸ æœªæ‰¾åˆ°å¤©æ•°å¡ç‰‡ï¼Œè·³è¿‡æ»šåŠ¨æ—¥æœŸé«˜äº®åˆå§‹åŒ–');
                return;
            }

            console.log('ğŸ“± åˆå§‹åŒ–H5å‘¨è§†å›¾æ»šåŠ¨æ—¥æœŸé«˜äº®åŠŸèƒ½');

            // åˆ›å»ºæ»šåŠ¨ç›‘å¬å‡½æ•°
            h5ScrollListener = () => {
                // é˜²æŠ–åŠ¨ï¼šæ»šåŠ¨åœæ­¢100msåæ‰è§¦å‘
                if (h5ScrollHighlightTimeout) {
                    clearTimeout(h5ScrollHighlightTimeout);
                }

                h5ScrollHighlightTimeout = setTimeout(() => {
                    highlightDateInView(gridId, dayCells);
                }, 100);
            };

            // æ·»åŠ æ»šåŠ¨ç›‘å¬
            gridElement.addEventListener('scroll', h5ScrollListener, { passive: true });

            console.log(`âœ… å·²ä¸º ${dayCells.length} ä¸ªå¤©æ•°å¡ç‰‡æ·»åŠ æ»šåŠ¨æ—¥æœŸé«˜äº®`);
        }

        /**
         * é«˜äº®è§†é‡ä¸­çš„æ—¥æœŸæŒ‰é’®
         * @param {string} gridId - ç½‘æ ¼å®¹å™¨ID
         * @param {NodeList} dayCells - æ‰€æœ‰å¤©æ•°å¡ç‰‡å…ƒç´ 
         */
        function highlightDateInView(gridId, dayCells) {
            let activeDay = null;
            let maxIntersectionRatio = 0;

            // éå†æ‰€æœ‰å¤©æ•°å¡ç‰‡ï¼Œæ‰¾å‡ºåœ¨å¯è§†åŒºåŸŸå†…å æ¯”æœ€å¤§çš„
            dayCells.forEach(cell => {
                const rect = cell.getBoundingClientRect();
                const windowHeight = window.innerHeight;
                const windowWidth = window.innerWidth;

                // è®¡ç®—å¡ç‰‡åœ¨å¯è§†åŒºåŸŸå†…çš„å æ¯”
                const visibleTop = Math.max(0, rect.top);
                const visibleBottom = Math.min(windowHeight, rect.bottom);
                const visibleHeight = Math.max(0, visibleBottom - visibleTop);

                // è®¡ç®—å¯è§†å æ¯”
                const intersectionRatio = rect.height > 0 ? visibleHeight / rect.height : 0;

                // å½“å¡ç‰‡å æ®å±å¹•30%ä»¥ä¸Šæ—¶ï¼Œæ‰è€ƒè™‘ä¸ºå€™é€‰
                if (intersectionRatio >= 0.3 && intersectionRatio > maxIntersectionRatio) {
                    maxIntersectionRatio = intersectionRatio;
                    activeDay = parseInt(cell.getAttribute('data-day'));
                }
            });

            // å¦‚æœæ‰¾åˆ°äº†æœ‰æ•ˆçš„æ´»è·ƒæ—¥æœŸï¼Œæ›´æ–°é«˜äº®çŠ¶æ€
            if (activeDay !== null && !isNaN(activeDay)) {
                updateDateHighlight(activeDay, gridId);
            }
        }

        /**
         * æ›´æ–°æ—¥æœŸé«˜äº®çŠ¶æ€
         * @param {number} day - å¤©æ•°ï¼ˆ0-6ï¼Œ0=å‘¨æ—¥ï¼‰
         * @param {string} gridId - ç½‘æ ¼å®¹å™¨ID
         */
        function updateDateHighlight(day, gridId) {
            // è·å–æ‰€æœ‰æ—¥æœŸè¡¨å¤´æŒ‰é’®
            const headerId = gridId === 'calendarGridMarket' ? 'dateGridHeaderMarket' : 'dateGridHeader';
            const dateButtons = document.querySelectorAll(`#${headerId} .date-cell-header`);

            // æ›´æ–°æ—¥æœŸæŒ‰é’®é«˜äº®çŠ¶æ€
            dateButtons.forEach(btn => {
                const btnDay = parseInt(btn.getAttribute('data-day'));
                if (btnDay === day) {
                    btn.classList.add('selected-day');
                } else {
                    btn.classList.remove('selected-day');
                }
            });

            // æ›´æ–°æ´»åŠ¨å¡ç‰‡é«˜äº®çŠ¶æ€
            const activityCards = document.querySelectorAll(`#${gridId} .activity-card`);
            activityCards.forEach(card => {
                const cardDay = parseInt(card.getAttribute('data-day'));
                if (cardDay === day) {
                    card.style.borderColor = '#667eea';
                    card.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                } else {
                    card.style.borderColor = '';
                    card.style.boxShadow = '';
                }
            });

            console.log(`ğŸ¯ é«˜äº®æ—¥æœŸ: ${day} (${dayNames[day]})`);
        }

        function toggleDayFilter(day) {
            console.log('ğŸ—“ï¸ ç‚¹å‡»æ—¥æœŸç­›é€‰:', day, `(${dayNames[day]})`);
            console.log('ğŸ“ å½“å‰ç­›é€‰çŠ¶æ€:', currentFilters);

            // æ¸…ç†è‡ªåŠ¨æ»šåŠ¨æ£€æµ‹ï¼ˆé¿å…å†²çªï¼‰
            cleanupH5ScrollObserver();

            if (currentFilters.day === day) {
                // å†æ¬¡ç‚¹å‡»å–æ¶ˆç­›é€‰ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ´»åŠ¨
                console.log('âœ‹ å–æ¶ˆæ—¥æœŸç­›é€‰');
                currentFilters.day = null;
                lastSelectedDay = null;

                // H5ç«¯ï¼šé‡æ–°å¯ç”¨æ»šåŠ¨è‡ªåŠ¨é€‰ä¸­
                if (window.innerWidth <= 768) {
                    console.log('ğŸ”„ é‡æ–°å¯ç”¨H5æ»šåŠ¨è‡ªåŠ¨é€‰ä¸­');
                    const gridId = currentTab === 1 ? 'dateGridMarket' : 'dateGrid';
                    setTimeout(() => {
                        initH5ScrollAutoSelect(gridId);
                    }, 300);
                }
            } else {
                // ç‚¹å‡»å…¶ä»–æ—¥æœŸï¼Œé€‰ä¸­è¯¥æ—¥æœŸ
                console.log('âœ… è®¾ç½®æ—¥æœŸç­›é€‰:', day);
                currentFilters.day = day;
                lastSelectedDay = day;
            }

            console.log('ğŸ†• æ–°çš„ç­›é€‰çŠ¶æ€:', currentFilters);
            updateViews();

            // ç§»åŠ¨ç«¯ï¼šå°†é€‰ä¸­çš„æ—¥æœŸæ»šåŠ¨åˆ°è§†å›¾ä¸­å¿ƒ
            if (window.innerWidth <= 768) {
                const selectedHeader = document.querySelector(`.date-cell-header[data-day="${day}"]`);
                if (selectedHeader) {
                    selectedHeader.scrollIntoView({
                        behavior: 'smooth',
                        block: 'nearest',
                        inline: 'center'
                    });
                }
            }

            // ç§»åŠ¨ç«¯è§¦è§‰åé¦ˆ
            if (window.innerWidth <= 768 && navigator.vibrate) {
                navigator.vibrate(10);
            }
        }

        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            currentFilters.search = searchTerm;
            updateViews();

            // ç§»åŠ¨ç«¯æœç´¢åé¦ˆ
            if (window.innerWidth <= 768 && searchTerm) {
                // å¯ä»¥æ·»åŠ æŒ¯åŠ¨åé¦ˆ
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
            }
        }

        // å®æ—¶æœç´¢ï¼ˆå¸¦é˜²æŠ–ï¼‰
        let searchTimeout;
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');

            // ç›‘å¬è¾“å…¥äº‹ä»¶ï¼ˆå®æ—¶æœç´¢ï¼Œ300msé˜²æŠ–ï¼‰
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch();
                }, 300);
            });

            // ç›‘å¬å›è½¦é”®ï¼ˆç«‹å³æœç´¢ï¼‰
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    performSearch();
                }
            });

            // ç§»åŠ¨ç«¯é”®ç›˜å¼¹å‡ºå¤„ç†ï¼ˆä»…åœ¨ç§»åŠ¨ç«¯ï¼‰
            if (window.innerWidth <= 768) {
                const header = document.querySelector('.header');

                searchInput.addEventListener('focus', () => {
                    // é”®ç›˜å¼¹å‡ºæ—¶ï¼Œå–æ¶ˆå›ºå®šå®šä½æ•ˆæœ
                    if (header) {
                        header.style.position = 'relative';
                    }
                    window.scrollTo(0, 0);
                });

                searchInput.addEventListener('blur', () => {
                    // æ¢å¤æ­£å¸¸
                    if (header) {
                        setTimeout(() => {
                            header.style.position = 'relative';
                        }, 300);
                    }
                });

                // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ˆé”®ç›˜å¼¹å‡º/æ”¶èµ·ï¼‰
                let initialHeight = window.innerHeight;
                window.addEventListener('resize', () => {
                    const currentHeight = window.innerHeight;
                    const isKeyboardOpen = currentHeight < initialHeight - 150;

                    if (isKeyboardOpen && document.activeElement === searchInput) {
                        if (header) header.style.position = 'relative';
                    } else if (!isKeyboardOpen && header) {
                        header.style.position = 'relative';
                    }
                });
            }
        });

        // =====================================================
        // è§†å›¾æ›´æ–°
        // =====================================================

        function updateViews() {
            const filtered = filterActivities();

            // æ ¹æ®å½“å‰Tabæ›´æ–°å¯¹åº”è§†å›¾
            // æ³¨æ„ï¼šfiltered å·²ç»åœ¨ filterActivities() ä¸­æ ¹æ® currentTab ç­›é€‰è¿‡äº†
            switch(currentTab) {
                case 0: // å…´è¶£ç­ - æ—¥å†è§†å›¾
                    updateCalendarView(filtered);
                    break;

                case 1: // å¸‚é›† - æ—¥å†è§†å›¾
                    updateCalendarView(filtered);
                    break;

                case 2: // éŸ³ä¹ - æ—¥å†è§†å›¾
                    updateCalendarView(filtered);
                    break;

                case 3: // çµæ´»æ—¶é—´æ´»åŠ¨ - åˆ—è¡¨è§†å›¾
                    updateListView(filtered, 'flexibleList');
                    break;

                case 4: // æ´»åŠ¨ç½‘ç«™ - ç½‘ç«™å¡ç‰‡è§†å›¾
                    console.log('ğŸª Tab 4 - å‡†å¤‡è°ƒç”¨ updateWebsitesViewï¼Œæ´»åŠ¨æ•°:', filtered.length);
                    updateWebsitesView(filtered);
                    break;

                case 5: // æ”»ç•¥ä¿¡æ¯ - å¯Œæ–‡æœ¬å†…å®¹
                    loadGuideContent();
                    break;
            }

            // æ›´æ–°ç»“æœæ•°é‡
            updateResultCount(filtered);

            // æ›´æ–°ç­›é€‰æ ‡ç­¾
            updateFilterTags();

            // æ›´æ–°ç§»åŠ¨ç«¯ç­›é€‰çŠ¶æ€
            updateMobileFilterStatus();

            // æ›´æ–°æ—¥æœŸé«˜äº®çŠ¶æ€
            updateDateHighlight();

            // æ›´æ–°æ ‡é¢˜æ ‡ç­¾
            updateMonthLabel();
        }

        // æ›´æ–°æ ‡é¢˜æ ‡ç­¾
        function updateMonthLabel() {
            const label = document.getElementById('monthLabel');
            if (currentFilters.day !== null) {
                // æŸ¥æ‰¾å¯¹åº”æ—¥æœŸçš„è¯¦ç»†ä¿¡æ¯
                const dateInfo = weekDates.find(d => d.day === currentFilters.day);
                if (dateInfo) {
                    // æ ¼å¼åŒ–æœˆä»½å’Œæ—¥æœŸä¸ºä¸¤ä½æ•°ï¼ˆå¦‚ 01-21ï¼‰
                    const monthStr = String(dateInfo.month).padStart(2, '0');
                    const dateStr = String(dateInfo.date).padStart(2, '0');
                    label.textContent = `ğŸ“… ${monthStr}-${dateStr}çš„æ´»åŠ¨`;
                } else {
                    label.textContent = `ğŸ“… ${dayNames[currentFilters.day]}çš„æ´»åŠ¨`;
                }
            } else {
                label.textContent = 'ğŸ“… æœ¬å‘¨æ´»åŠ¨';
            }
        }

        function updateCalendarView(filtered) {
            // æ ¹æ®å½“å‰Tabé€‰æ‹©ä¸åŒçš„å®¹å™¨
            let gridId, headerId;
            if (currentTab === 1) {
                gridId = 'calendarGridMarket';
                headerId = 'dateGridHeaderMarket';
            } else if (currentTab === 2) {
                gridId = 'calendarGridMusic';
                headerId = 'dateGridHeaderMusic';
            } else {
                gridId = 'calendarGrid';
                headerId = 'dateGridHeader';
            }

            const grid = document.getElementById(gridId);
            const header = document.getElementById(headerId);

            // æ·»åŠ æ·¡å…¥åŠ¨ç”»ç±»
            grid.style.opacity = '0';
            grid.style.transition = 'opacity 0.2s ease';

            let html = '';

            // åˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
            const isMobile = window.innerWidth <= 768;

            // ç§»åŠ¨ç«¯ï¼šé€‰æ‹©æ—¥æœŸåæ˜¾ç¤ºå•æ—¥è¯¦ç»†è§†å›¾
            // PCç«¯ï¼šå§‹ç»ˆæ˜¾ç¤ºå‘¨è§†å›¾ï¼Œé€šè¿‡é«˜äº®æ˜¾ç¤ºé€‰ä¸­æ—¥æœŸ
            if (isMobile && currentFilters.day !== null) {
                // H5ç«¯ï¼šä½¿ç”¨åˆ—è¡¨è§†å›¾æ˜¾ç¤ºé€‰ä¸­æ—¥æœŸçš„æ´»åŠ¨
                grid.style.display = 'block';
                grid.style.gridTemplateColumns = '1fr';

                // æ·»åŠ æ—¥æœŸæ ‡é¢˜æ 
                const weekDate = weekDates.find(d => d.day === currentFilters.day);
                const dateTitle = weekDate ? `${weekDate.date}æ—¥ ${weekDate.dayName}` : 'æ´»åŠ¨è¯¦æƒ…';

                html = `
                    <div class="day-detail-header">
                        <button class="day-back-btn" onclick="toggleDayFilter(null)">
                            <span>â†</span>
                        </button>
                        <div class="day-detail-title">${dateTitle}</div>
                    </div>
                    <div class="day-detail-content">
                        ${createDayDetailView(filtered, currentFilters.day)}
                    </div>
                `;
            } else {
                // PCç«¯æˆ–æœªé€‰æ‹©æ—¥æœŸï¼šæ˜¾ç¤ºå‘¨è§†å›¾ï¼ˆ7å¤©ï¼‰
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = '';

                // ç”Ÿæˆ7å¤©çš„æ—¥å†å•å…ƒæ ¼ï¼Œä½¿ç”¨æœªæŒ‰æ—¥æœŸç­›é€‰çš„æ•°æ®
                const unfiltered = filterActivitiesWithoutDay();
                for (let day = 1; day <= 6; day++) {
                    html += createDayCell(day, unfiltered);
                }
                html += createDayCell(0, unfiltered); // å‘¨æ—¥
            }

            grid.innerHTML = html;

            // è§¦å‘æ·¡å…¥åŠ¨ç”»
            setTimeout(() => {
                grid.style.opacity = '1';
            }, 50);

            // æ›´æ–°æ—¥æœŸè¡¨å¤´
            updateDateHeaders(headerId);

            // ä¸ºæ¯ä¸€å¤©æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆä»…åœ¨å‘¨è§†å›¾æ—¶ï¼‰
            if (!isMobile || currentFilters.day === null) {
                document.querySelectorAll(`#${gridId} .day-cell`).forEach(cell => {
                    cell.addEventListener('click', function() {
                        const day = parseInt(this.getAttribute('data-day'));
                        toggleDayFilter(day);
                    });

                    // æ·»åŠ hoveræ•ˆæœæç¤º
                    cell.style.cursor = 'pointer';
                });
            } else {
                // H5ç«¯å•æ—¥è§†å›¾ï¼šæ·»åŠ è¿”å›æŒ‰é’®
                const backBtn = grid.querySelector('.day-back-btn');
                if (backBtn) {
                    backBtn.addEventListener('click', () => {
                        toggleDayFilter(currentFilters.day);
                    });
                }
            }

            // ========== H5å‘¨è§†å›¾ï¼šæ»šåŠ¨è‡ªåŠ¨é€‰ä¸­åŠŸèƒ½ ==========
            // ä»…åœ¨ç§»åŠ¨ç«¯å‘¨è§†å›¾æ¨¡å¼ä¸‹å¯ç”¨
            if (isMobile && currentFilters.day === null) {
                // ç­‰å¾…DOMæ›´æ–°å®Œæˆååˆå§‹åŒ–æ»šåŠ¨æ£€æµ‹
                setTimeout(() => {
                    initH5ScrollAutoSelect(gridId);
                    // åŒæ—¶åˆå§‹åŒ–æ»šåŠ¨æ—¥æœŸé«˜äº®åŠŸèƒ½
                    initH5ScrollDateHighlight(gridId);
                }, 300);
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–æœªæŒ‰æ—¥æœŸç­›é€‰çš„æ´»åŠ¨
        function filterActivitiesWithoutDay() {
            const savedDay = currentFilters.day;
            currentFilters.day = null;
            const result = filterActivities();
            currentFilters.day = savedDay;
            return result;
        }

        // åˆ›å»ºå•æ—¥è¯¦ç»†è§†å›¾
        function createDayDetailView(activities, day) {
            if (activities.length === 0) {
                return `
                    <div class="day-detail-empty" style="text-align:center;padding:30px 20px;color:#999;">
                        <div style="font-size:48px;margin-bottom:12px;">ğŸ“…</div>
                        <div style="font-size:16px;margin-bottom:8px;">${dayNames[day]}æ²¡æœ‰æ´»åŠ¨</div>
                        <button class="day-back-btn" style="margin-top:12px;padding:8px 16px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;">
                            â† è¿”å›å‘¨è§†å›¾
                        </button>
                    </div>
                `;
            }

            const weekDate = weekDates.find(d => d.day === day);
            const dateStr = weekDate ? `${weekDate.month}/${weekDate.date}` : '';

            let html = `
                <div class="day-detail-container">
                    <div class="day-detail-header" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:16px;border-radius:12px;margin-bottom:12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-size:20px;font-weight:600;">${dayNames[day]}</div>
                                <div style="font-size:13px;opacity:0.9;">${dateStr}</div>
                            </div>
                            <button class="day-back-btn" style="padding:8px 16px;background:rgba(255,255,255,0.2);color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">
                                â† è¿”å›
                            </button>
                        </div>
                    </div>
                    <div class="day-detail-activities">
            `;

            html += activities.map(act => `
                <div class="activity-detail-card"
                     style="background:white;border-radius:12px;padding:12px;margin-bottom:8px;border-left:4px solid ${getActivityColor(act.id)};cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.1);"
                     onclick='showActivityDetail("${act.id}")'>
                    <div style="font-weight:600;font-size:16px;margin-bottom:6px;">${cleanTitle(act.title)}</div>
                    <div style="display:flex;gap:12px;font-size:13px;color:#666;">
                        <div>â° ${act.time || 'çµæ´»æ—¶é—´'}</div>
                        <div>ğŸ“ ${act.location}</div>
                        <div>ğŸ’° ${act.price}</div>
                    </div>
                    ${act.description ? `<div style="margin-top:6px;font-size:13px;color:#666;line-height:1.5;">${act.description.substring(0, 100)}${act.description.length > 100 ? '...' : ''}</div>` : ''}
                </div>
            `).join('');

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        function createDayCell(day, filtered) {
            // ä»ç­›é€‰åçš„æ´»åŠ¨ä¸­è·å–è¯¥æ—¥æœŸçš„æ´»åŠ¨ï¼ˆç¡®ä¿Tabéš”ç¦»ï¼‰
            const dayActivities = filtered.filter(act => act.day === day);
            const isSelectedDay = currentFilters.day === day;
            const isToday = isDayToday(day);
            const isDimmed = currentFilters.day !== null && currentFilters.day !== day;

            // è·å–æ—¥æœŸæ•°å­—
            const weekDate = weekDates.find(d => d.day === day);
            const dateNumber = weekDate ? weekDate.date : '';

            // å§‹ç»ˆä½¿ç”¨ç­›é€‰åçš„æ´»åŠ¨
            let activitiesToShow = dayActivities;

            // æŒ‰æ—¶é—´æ’åºï¼ˆè¾ƒæ—©çš„æ´»åŠ¨æ’åœ¨å‰é¢ï¼‰- ä½¿ç”¨æ•°å­—æ¯”è¾ƒ
            activitiesToShow = activitiesToShow.sort((a, b) => {
                const timeA = a.time || a.startTime || 'çµæ´»æ—¶é—´';
                const timeB = b.time || b.startTime || 'çµæ´»æ—¶é—´';
                return compareTimes(timeA, timeB);
            });

            let chipsHtml = '';

            if (activitiesToShow.length === 0) {
                // æ²¡æœ‰æ´»åŠ¨æ—¶æ˜¾ç¤ºæç¤º
                chipsHtml = `
                    <div style="text-align:center;color:#999;font-size:12px;padding:20px 0;">
                        <div>ä»Šæ—¥æ— æ´»åŠ¨</div>
                    </div>
                `;
            } else {
                chipsHtml = activitiesToShow.map(act => `
                    <div class="activity-chip"
                         style="border-left-color: ${getActivityColor(act.id)}"
                         onclick='showActivityDetail("${act.id}")'>
                        <div style="font-weight: 500;" class="chip-title">${cleanTitle(act.title)}</div>
                        <div style="font-size: 10px; color: #666; font-weight: 600;">${act.time || 'çµæ´»æ—¶é—´'}</div>
                    </div>
                `).join('');
            }

            return `
                <div class="day-cell ${isToday ? 'today' : ''} ${isSelectedDay ? 'selected-day' : ''} ${isDimmed ? 'dimmed' : ''}" data-day="${day}">
                    ${chipsHtml}
                </div>
            `;
        }

        function updateListView(filtered, containerId = 'scheduleList') {
            const container = document.getElementById(containerId);

            if (!container) return;

            if (filtered.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999;">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ´»åŠ¨</div>';
                return;
            }

            // æŒ‰æ—¶é—´æ’åºï¼šæ—©çš„æ—¶é—´æ’åœ¨å‰é¢ - ä½¿ç”¨æ•°å­—æ¯”è¾ƒ
            const sortedFiltered = [...filtered].sort((a, b) => {
                return compareTimes(a.time, b.time);
            });

            let html = sortedFiltered.map(act => {
                const dayName = act.day !== null ? dayNames[act.day] : 'çµæ´»æ—¶é—´';
                const isDaySelected = act.day === currentFilters.day;
                const dayFilterHtml = act.day !== null
                    ? `<span class="day-filter-chip ${isDaySelected ? 'highlight' : ''}" onclick="event.stopPropagation(); toggleDayFilter(${act.day});" title="ç‚¹å‡»ç­›é€‰${dayName}">${dayName}</span>`
                    : `<span style="color: #666;">${dayName}</span>`;

                return `
                    <div class="schedule-item activity-card"
                         data-day="${act.day !== null ? act.day : ''}"
                         onclick='showActivityDetail("${act.id}")'
                         style="cursor: pointer; transition: all 0.2s ease;">
                        <div class="schedule-item-header">
                            <span class="category-tag" style="background: ${categoryColors[act.category] || '#667eea'}">${act.category}</span>
                            ${dayFilterHtml}
                        </div>
                        <div class="schedule-item-title">${cleanTitle(act.title)}</div>
                        <div class="schedule-item-meta">
                            <div>ğŸ“ ${act.location}</div>
                            <div>â° ${act.time || 'çµæ´»æ—¶é—´'}</div>
                            <div>ğŸ’° ${act.price}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // æ›´æ–°æ´»åŠ¨ç½‘ç«™è§†å›¾ - è¡¨æ ¼å½¢å¼
        function updateWebsitesView(activities) {
            console.log('ğŸª updateWebsitesView è¢«è°ƒç”¨ï¼Œæ´»åŠ¨æ•°é‡:', activities.length);
            const container = document.getElementById('websitesContainer');

            if (!container) {
                console.error('âŒ æ‰¾ä¸åˆ° websitesContainer å…ƒç´ !');
                return;
            }

            if (activities.length === 0) {
                console.log('âš ï¸ æ²¡æœ‰æ´»åŠ¨ç½‘ç«™é“¾æ¥');
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">æš‚æ— æ´»åŠ¨ç½‘ç«™é“¾æ¥</div>';
                return;
            }

            // å»é‡ï¼šä½¿ç”¨ originalId æˆ– id å»é‡ï¼ŒåŒä¸€æ´»åŠ¨åªæ˜¾ç¤ºä¸€æ¬¡
            const uniqueActivities = [];
            const seenIds = new Set();
            activities.forEach(act => {
                const id = act.originalId || act.id;
                if (!seenIds.has(id)) {
                    seenIds.add(id);
                    uniqueActivities.push(act);
                }
            });

            console.log('âœ… å»é‡åæ´»åŠ¨æ•°é‡:', uniqueActivities.length);

            // æŒ‰åˆ†ç±»åˆ†ç»„
            const grouped = {};
            uniqueActivities.forEach(act => {
                if (!grouped[act.category]) {
                    grouped[act.category] = [];
                }
                grouped[act.category].push(act);
            });

            let html = '<div style="padding: 20px;">';

            // éå†æ¯ä¸ªåˆ†ç±»
            Object.keys(grouped).sort().forEach(category => {
                html += `
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid ${categoryColors[category] || '#667eea'};">
                            ${category} (${grouped[category].length})
                        </h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 10px; text-align: left; font-weight: 600; color: #666; width: 50%;">åç§°</th>
                                    <th style="padding: 10px; text-align: left; font-weight: 600; color: #666; width: 50%;">é“¾æ¥</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                grouped[category].forEach(act => {
                    const url = act.source.url;
                    html += `
                        <tr style="border-bottom: 1px solid #f0f0f0;">
                            <td style="padding: 12px 10px; color: #333;">${act.title}</td>
                            <td style="padding: 12px 10px;">
                                <a href="${url}" target="_blank" style="color: #667eea; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; word-break: break-all;">
                                    ğŸ”— ${url}
                                </a>
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
            console.log('âœ… ç½‘ç«™é“¾æ¥è¡¨æ ¼ç”Ÿæˆå®Œæˆ');
        }

        // åŠ è½½æ”»ç•¥å†…å®¹
        async function loadGuideContent() {
            const container = document.getElementById('guideContent');

            if (!container) return;

            container.innerHTML = '<div style="text-align:center;padding:40px;">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch('/api/guide');
                const result = await response.json();

                if (result.success && result.data && result.data.content) {
                    container.innerHTML = result.data.content;

                    // æ¸…é™¤æ‰€æœ‰å†…è”æ ·å¼ï¼Œè®©CSSæ ·å¼ç”Ÿæ•ˆ
                    setTimeout(() => {
                        const allElements = container.querySelectorAll('*');
                        allElements.forEach(el => {
                            el.style.fontSize = '';
                            el.style.color = '';
                            el.style.fontFamily = '';
                            el.style.margin = '';
                            el.style.padding = '';
                        });
                    }, 50);
                } else {
                    container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">æš‚æ— æ”»ç•¥ä¿¡æ¯</div>';
                }
            } catch (error) {
                console.error('åŠ è½½æ”»ç•¥å¤±è´¥:', error);
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            }
        }

        function updateResultCount(filtered) {
            const hasFilter = currentFilters.category !== 'å…¨éƒ¨' ||
                             currentFilters.price !== 'å…¨éƒ¨' ||
                             currentFilters.day !== null ||
                             currentFilters.search;

            // æ ¹æ®å½“å‰Tabè®¡ç®—å¯¹åº”çš„æ´»åŠ¨æ€»æ•°
            let totalInTab = 0;
            switch(currentTab) {
                case 0: // å…´è¶£ç­
                    totalInTab = allActivities.filter(a => {
                        if (a.category === 'å¸‚é›†') return false;
                        if (a.flexibleTime === 'æ˜¯' || a.time === 'çµæ´»æ—¶é—´') return false;
                        return true;
                    }).length;
                    break;
                case 1: // å¸‚é›†
                    totalInTab = allActivities.filter(a => a.category === 'å¸‚é›†').length;
                    break;
                case 2: // çµæ´»æ—¶é—´
                    totalInTab = allActivities.filter(a => a.flexibleTime === 'æ˜¯' || a.time === 'çµæ´»æ—¶é—´').length;
                    break;
                case 3: // æ´»åŠ¨ç½‘ç«™
                    totalInTab = new Set(allActivities.filter(a => a.source && a.source.url).map(a => a.originalId || a.id)).size;
                    break;
                case 4: // æ”»ç•¥ä¿¡æ¯
                    totalInTab = 1; // å›ºå®šä¸º1é¡µ
                    break;
            }

            // å¦‚æœæœ‰ç­›é€‰æ¡ä»¶ï¼Œæ˜¾ç¤ºç­›é€‰åçš„æ•°é‡ï¼›å¦åˆ™æ˜¾ç¤ºå½“å‰Tabçš„æ€»æ•°
            document.getElementById('totalCount').textContent =
                hasFilter ? filtered.length : totalInTab;
        }

        function updateFilterTags() {
            const container = document.getElementById('activeFilters');
            container.innerHTML = '';

            const hasFilter = currentFilters.category !== 'å…¨éƒ¨' ||
                             currentFilters.price !== 'å…¨éƒ¨' ||
                             currentFilters.day !== null ||
                             currentFilters.search;

            if (!hasFilter) {
                container.classList.remove('show');
                return;
            }

            container.classList.add('show');

            // æ—¥æœŸæ ‡ç­¾
            if (currentFilters.day !== null) {
                container.innerHTML += `<div class="filter-tag"><span>æ—¥æœŸ: ${dayNames[currentFilters.day]}</span><button onclick="clearFilter('day')">âœ•</button></div>`;
            }

            // åˆ†ç±»æ ‡ç­¾
            if (currentFilters.category !== 'å…¨éƒ¨') {
                container.innerHTML += `<div class="filter-tag"><span>åˆ†ç±»: ${currentFilters.category}</span><button onclick="clearFilter('category')">âœ•</button></div>`;
            }

            // ä»·æ ¼æ ‡ç­¾
            if (currentFilters.price !== 'å…¨éƒ¨') {
                container.innerHTML += `<div class="filter-tag"><span>ä»·æ ¼: ${currentFilters.price}</span><button onclick="clearFilter('price')">âœ•</button></div>`;
            }

            // æœç´¢æ ‡ç­¾
            if (currentFilters.search) {
                container.innerHTML += `<div class="filter-tag"><span>æœç´¢: ${currentFilters.search}</span><button onclick="clearSearch()">âœ•</button></div>`;
            }

            // æ¸…é™¤å…¨éƒ¨æŒ‰é’®
            container.innerHTML += '<button class="clear-all-btn" onclick="clearAllFilters()">æ¸…é™¤å…¨éƒ¨</button>';
        }

        // æ›´æ–°ç§»åŠ¨ç«¯ç­›é€‰çŠ¶æ€æ¡
        function updateMobileFilterStatus() {
            if (!isMobile()) {
                document.getElementById('mobileFilterStatus').style.display = 'none';
                return;
            }

            const statusEl = document.getElementById('mobileFilterStatus');
            const categoryEl = document.getElementById('mobileCategoryStatus');
            const priceEl = document.getElementById('mobilePriceStatus');

            // æ˜¾ç¤ºæˆ–éšè—çŠ¶æ€æ¡
            const hasFilter = currentFilters.category !== 'å…¨éƒ¨' ||
                             currentFilters.price !== 'å…¨éƒ¨' ||
                             currentFilters.day !== null;

            statusEl.style.display = hasFilter ? 'flex' : 'none';

            // æ›´æ–°åˆ†ç±»
            categoryEl.textContent = currentFilters.category;
            if (currentFilters.category === 'å…¨éƒ¨') {
                categoryEl.style.color = '#999';
            } else {
                categoryEl.style.color = '#667eea';
            }

            // æ›´æ–°ä»·æ ¼
            priceEl.textContent = currentFilters.price;
            if (currentFilters.price === 'å…¨éƒ¨') {
                priceEl.style.color = '#999';
            } else {
                priceEl.style.color = '#667eea';
            }
        }

        function updateDateHighlight() {
            // æ›´æ–°æ—¥æœŸè¡¨å¤´çš„é«˜äº®çŠ¶æ€
            document.querySelectorAll('.date-cell-header').forEach(header => {
                const day = parseInt(header.getAttribute('data-day'));
                if (day === currentFilters.day) {
                    header.classList.add('selected-day');
                } else {
                    header.classList.remove('selected-day');
                }
            });

            // æ›´æ–°æ—¥å†å•å…ƒæ ¼çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.day-cell').forEach(cell => {
                const day = parseInt(cell.getAttribute('data-day'));
                if (day === currentFilters.day) {
                    cell.classList.add('selected-day');
                } else {
                    cell.classList.remove('selected-day');
                }
            });
        }

        function isDayToday(day) {
            const today = new Date().getDay();
            return today === day;
        }

        // =====================================================
        // Tab åˆ‡æ¢
        // =====================================================

        let currentTab = 0; // å½“å‰é€‰ä¸­çš„Tab

        function switchTab(index) {
            currentTab = index;

            // åˆ‡æ¢Tabæ—¶æ¸…é™¤æ‰€æœ‰ç­›é€‰æ¡ä»¶ï¼ˆé™¤äº†æœç´¢ï¼‰
            currentFilters.category = 'å…¨éƒ¨';
            currentFilters.price = 'å…¨éƒ¨';
            currentFilters.day = null;
            currentFilters.search = '';

            // æ¸…é™¤æœç´¢æ¡†
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }

            // ç§»é™¤æ‰€æœ‰ active ç±»
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });

            // æ·»åŠ  active ç±»åˆ°å½“å‰ Tab
            document.querySelectorAll('.tab-item')[index].classList.add('active');
            document.getElementById('tab-' + index).classList.add('active');

            // æ ¹æ®Tabæ›´æ–°è§†å›¾
            updateViews();
        }

        // =====================================================
        // æ¸…é™¤ç­›é€‰
        // =====================================================

        function clearFilter(filterKey) {
            if (filterKey === 'day') {
                currentFilters.day = null;
            } else if (filterKey === 'category') {
                currentFilters.category = 'å…¨éƒ¨';
                document.querySelectorAll('#categoryChips .filter-chip').forEach(chip => {
                    chip.classList.remove('active');
                    if (chip.textContent.trim() === 'å…¨éƒ¨') chip.classList.add('active');
                });
            } else if (filterKey === 'price') {
                currentFilters.price = 'å…¨éƒ¨';
                const priceGroup = document.querySelectorAll('.filter-group')[1];
                priceGroup.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.classList.remove('active');
                    if (chip.textContent.trim() === 'å…¨éƒ¨') chip.classList.add('active');
                });
            }

            updateViews();
        }

        function clearSearch() {
            currentFilters.search = '';
            document.getElementById('searchInput').value = '';
            updateViews();
        }

        function clearAllFilters() {
            currentFilters = {
                category: 'å…¨éƒ¨',
                price: 'å…¨éƒ¨',
                day: null,
                search: ''
            };

            // é‡ç½® UI
            document.querySelectorAll('#categoryChips .filter-chip').forEach(chip => {
                chip.classList.remove('active');
                if (chip.textContent.trim() === 'å…¨éƒ¨') chip.classList.add('active');
            });

            const priceGroup = document.querySelectorAll('.filter-group')[1];
            priceGroup.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
                if (chip.textContent.trim() === 'å…¨éƒ¨') chip.classList.add('active');
            });

            document.getElementById('searchInput').value = '';

            updateViews();
        }

        // =====================================================
        // å‘¨å¯¼èˆª
        // =====================================================

        // åˆ‡æ¢å‘¨ï¼ˆdirection: -1 ä¸Šä¸€å‘¨, 1 ä¸‹ä¸€å‘¨ï¼‰
        function navigateWeek(direction) {
            // æ›´æ–°å‘¨åç§»é‡
            currentWeekOffset += direction;

            // æ¸…é™¤æ—¥æœŸç­›é€‰ï¼ˆå› ä¸ºåˆ‡æ¢å‘¨åï¼Œä¹‹å‰çš„æ—¥æœŸé€‰æ‹©ä¸å†é€‚ç”¨ï¼‰
            currentFilters.day = null;

            // é‡æ–°ç”Ÿæˆæ—¥æœŸè¡¨å¤´
            updateDateHeaders('dateGridHeader');
            updateDateHeaders('dateGridHeaderMarket');

            // é‡æ–°æ¸²æŸ“è§†å›¾
            updateViews();

            // ç§»åŠ¨ç«¯ï¼šå¦‚æœæ˜¯æœ¬å‘¨ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°ä»Šå¤©
            if (window.innerWidth <= 768 && currentWeekOffset === 0) {
                setTimeout(() => {
                    const todayHeader = document.querySelector('.date-cell-header.today-header');
                    if (todayHeader) {
                        todayHeader.scrollIntoView({
                            behavior: 'smooth',
                            block: 'nearest',
                            inline: 'center'
                        });
                    }
                }, 100);
            }
        }

        // å›åˆ°æœ¬å‘¨
        function goToThisWeek() {
            // é‡ç½®å‘¨åç§»é‡
            currentWeekOffset = 0;

            // æ¸…é™¤æ—¥æœŸç­›é€‰
            currentFilters.day = null;

            // é‡æ–°ç”Ÿæˆæ—¥æœŸè¡¨å¤´
            updateDateHeaders('dateGridHeader');
            updateDateHeaders('dateGridHeaderMarket');

            // é‡æ–°æ¸²æŸ“è§†å›¾
            updateViews();

            // ç§»åŠ¨ç«¯ï¼šè‡ªåŠ¨æ»šåŠ¨åˆ°ä»Šå¤©
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    const todayHeader = document.querySelector('.date-cell-header.today-header');
                    if (todayHeader) {
                        todayHeader.scrollIntoView({
                            behavior: 'smooth',
                            block: 'nearest',
                            inline: 'center'
                        });
                    }
                }, 100);
            }
        }

        // =====================================================
        // æ´»åŠ¨è¯¦æƒ…å¼¹çª—
        // =====================================================

        function showActivityDetail(activityId) {
            const activity = allActivities.find(a => a.originalId == activityId || a.id == activityId);
            if (!activity) {
                console.warn('æ´»åŠ¨æœªæ‰¾åˆ°:', activityId);
                return;
            }

            // å®‰å…¨åœ°è·å–DOMå…ƒç´ 
            const setTitle = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text || '';
            };

            setTitle('modalTitle', activity.title);
            setTitle('modalCategory', activity.category);
            setTitle('modalLocation', activity.location);
            setTitle('modalTime', activity.time || 'çµæ´»æ—¶é—´');
            setTitle('modalPrice', activity.price || '');
            setTitle('modalFrequency', activity.frequency === 'weekly' ? 'æ¯å‘¨' : 'ä¸€æ¬¡æ€§');

            // å¤„ç†æ—¶é•¿ä¿¡æ¯
            const modalDurationItem = document.getElementById('modalDurationItem');
            const modalDuration = document.getElementById('modalDuration');
            if (modalDurationItem && modalDuration) {
                if (activity.duration && activity.duration !== 'æ—¶é—´çµæ´»ï¼Œæ— å›ºå®šæ—¶é•¿é™åˆ¶' && activity.duration !== 'æ—¶é—´çµæ´»ï¼Œæ— å›ºå®šæ—¶é•¿é™åˆ¶') {
                    modalDurationItem.style.display = 'flex';
                    modalDuration.textContent = activity.duration;
                } else {
                    modalDurationItem.style.display = 'none';
                }
            }

            // å¤„ç†é¢‘ç‡ä¿¡æ¯æ˜¾ç¤º
            const modalFrequencyRow = document.getElementById('modalFrequencyRow');
            if (modalFrequencyRow && activity.frequency) {
                modalFrequencyRow.style.display = 'flex';
            }

            // æ ¼å¼åŒ–æè¿°ä¿¡æ¯ï¼Œè¿‡æ»¤æ‰é¡¶éƒ¨å·²æ˜¾ç¤ºçš„å­—æ®µ
            const baseDescription = activity.description || 'æš‚æ— æè¿°';
            const formattedDescription = formatDescription(baseDescription, activity);

            const descEl = document.getElementById('modalDescription');
            if (descEl) descEl.innerHTML = formattedDescription;

            // å¤„ç†é“¾æ¥æŒ‰é’®
            const modalFooter = document.getElementById('modalFooter');
            const modalLinkButton = document.getElementById('modalLinkButton');

            if (modalFooter && modalLinkButton) {
                const url = activity.source?.url;
                if (url && url.trim() !== '') {
                    modalFooter.style.display = 'block';
                    modalLinkButton.href = url.trim();
                } else {
                    modalFooter.style.display = 'none';
                }
            }

            const modal = document.getElementById('activityModal');
            if (modal) modal.classList.add('active');
        }

        // æ¸…ç†æ´»åŠ¨æ ‡é¢˜ä¸­çš„é‡å¤æ ‡ç­¾
        function cleanTitle(title) {
            if (!title) return title;

            // ç§»é™¤é‡å¤çš„æ ‡ç­¾ï¼ˆä¾‹å¦‚ï¼š"æ³¨æ„äº‹é¡¹ï¼šæ³¨æ„äº‹é¡¹ï¼š" â†’ "æ³¨æ„äº‹é¡¹ï¼š"ï¼‰
            const patterns = [
                { pattern: /(é€‚åˆäººç¾¤[ï¼š:]\s*){2,}/g, replacement: '$1' },
                { pattern: /(æ´»åŠ¨ç‰¹ç‚¹[ï¼š:]\s*){2,}/g, replacement: '$1' },
                { pattern: /(æ³¨æ„äº‹é¡¹[ï¼š:]\s*){2,}/g, replacement: '$1' },
                { pattern: /(è¯¾ç¨‹å‘¨æœŸ[ï¼š:]\s*){2,}/g, replacement: '$1' },
                { pattern: /(è¯­è¨€[ï¼š:]\s*){2,}/g, replacement: '$1' },
                { pattern: /(è´¹ç”¨[ï¼š:]\s*){2,}/g, replacement: '$1' },
                { pattern: /(è”ç³»æ–¹å¼[ï¼š:]\s*){2,}/g, replacement: '$1' },
                { pattern: /(å®˜ç½‘[ï¼š:]\s*){2,}/g, replacement: '$1' },
                // ç§»é™¤æ ‡ç­¾åçš„å†—ä½™å†’å·å’Œç©ºæ ¼
                { pattern: /([ï¼š:]\s*)+[ï¼š:]/g, replacement: 'ï¼š' },
                { pattern: /\s+ï¼š/g, replacement: 'ï¼š' }
            ];

            let cleaned = title;
            patterns.forEach(({ pattern, replacement }) => {
                cleaned = cleaned.replace(pattern, replacement);
            });

            return cleaned;
        }

        // æ ¼å¼åŒ–æè¿°ä¿¡æ¯ï¼Œæ·»åŠ å›¾æ ‡å’Œç»“æ„åŒ–å±•ç¤ºï¼Œå¹¶è¿‡æ»¤é‡å¤å­—æ®µ
        function formatDescription(description, activity = null) {
            if (!description) return 'æš‚æ— æè¿°';

            let formatted = description;

            // ========== æ¸…ç†å†—ä½™ç¬¦å·å’Œæ ¼å¼ ==========
            // 1. æ¸…ç†åŒæ„Ÿå¹å·æ–‡æœ¬ç¬¦å· "!!"
            formatted = formatted.replace(/!!+/g, '!');

            // 2. æ¸…ç†å¤šé‡æ„Ÿå¹å·emojiï¼ˆå¦‚ â€¼ï¸ â—â—ï¼‰
            formatted = formatted.replace(/â€¼ï¸+/g, 'âš ï¸');
            formatted = formatted.replace(/â—â—+/g, 'âš ï¸');
            formatted = formatted.replace(/â—+/g, 'âš ï¸');

            // 3. æ¸…ç†é‡å¤çš„è­¦å‘Šç¬¦å·ï¼ˆå¤šä¸ªâš ï¸è¿åœ¨ä¸€èµ·ï¼‰
            formatted = formatted.replace(/(âš ï¸\s*){2,}/g, 'âš ï¸ ');

            // 4. æ¸…ç†é‡å¤çš„æ ‡ç‚¹ç¬¦å·
            formatted = formatted.replace(/ã€‚+/g, 'ã€‚');
            formatted = formatted.replace(/ï¼š+/g, 'ï¼š');
            formatted = formatted.replace(/ï¼Œ+/g, 'ï¼Œ');

            // 5. æ¸…ç†è¡Œé¦–è¡Œå°¾å¤šä½™ç©ºæ ¼
            formatted = formatted.replace(/^\s+|\s+$/gm, '');

            // ========== å¦‚æœæœ‰æ´»åŠ¨ä¿¡æ¯ï¼Œè¿‡æ»¤æ‰é¡¶éƒ¨å·²æ˜¾ç¤ºçš„å­—æ®µ ==========
            if (activity) {
                // è¿‡æ»¤æ—¶é—´ä¿¡æ¯
                if (activity.time && activity.time !== 'çµæ´»æ—¶é—´') {
                    formatted = formatted.replace(/[â°]?\s*æ—¶é—´[ï¼š:]\s*[^\n]*/g, '');
                }

                // è¿‡æ»¤ä»·æ ¼/è´¹ç”¨ä¿¡æ¯
                if (activity.price) {
                    formatted = formatted.replace(/[ğŸ’°]?\s*è´¹ç”¨[ï¼š:]\s*[^\n]*/g, '');
                }
            }

            // ========== å®šä¹‰å­—æ®µå’Œå¯¹åº”çš„å›¾æ ‡ï¼ˆæ³¨æ„ï¼šé¿å…é‡å çš„æ¨¡å¼ï¼‰==========
            const fieldPatterns = [
                { pattern: /é€‚åˆäººç¾¤[ï¼š:]\s*/g, icon: 'ğŸ‘¥', label: 'é€‚åˆäººç¾¤ï¼š' },
                { pattern: /æ´»åŠ¨ç‰¹ç‚¹[ï¼š:]\s*/g, icon: 'âœ¨', label: 'æ´»åŠ¨ç‰¹ç‚¹ï¼š' },
                { pattern: /è¯¾ç¨‹å‘¨æœŸ[ï¼š:]\s*/g, icon: 'ğŸ“š', label: 'è¯¾ç¨‹å‘¨æœŸï¼š' },
                { pattern: /æ ‡å‡†è¯¾ç¨‹å‘¨æœŸ[ï¼š:]\s*/g, icon: 'ğŸ“š', label: 'è¯¾ç¨‹å‘¨æœŸï¼š' },
                { pattern: /è¯­è¨€[ï¼š:]\s*/g, icon: 'ğŸŒ', label: 'è¯­è¨€ï¼š' },
                { pattern: /è´¹ç”¨[ï¼š:]\s*/g, icon: 'ğŸ’°', label: 'è´¹ç”¨ï¼š' },
                { pattern: /å®˜ç½‘[ï¼š:]\s*/g, icon: 'ğŸŒ', label: 'å®˜ç½‘ï¼š' },
                { pattern: /è”ç³»æ–¹å¼[ï¼š:]\s*/g, icon: 'ğŸ“', label: 'è”ç³»æ–¹å¼ï¼š' },
                // æ³¨æ„äº‹é¡¹ï¼šåˆå¹¶ä¸¤ä¸ªæ¨¡å¼ï¼Œé¿å…é‡å¤æ›¿æ¢
                { pattern: /(âš ï¸\s*)?æ³¨æ„äº‹é¡¹[ï¼š:]\s*/g, icon: 'âš ï¸', label: 'æ³¨æ„äº‹é¡¹ï¼š' }
            ];

            // æ›¿æ¢æ‰€æœ‰åŒ¹é…çš„å­—æ®µ
            fieldPatterns.forEach(({ pattern, icon, label }) => {
                formatted = formatted.replace(pattern, `\n<strong>${icon} ${label}</strong>`);
            });

            // æ ‡å‡†åŒ–æ¢è¡Œï¼šå¤šä¸ªè¿ç»­æ¢è¡Œæ›¿æ¢ä¸ºå•ä¸ªæ¢è¡Œ
            formatted = formatted.replace(/\n\s*\n\s*/g, '\n');

            // è½¬ä¹‰HTMLï¼Œä½†ä¿ç•™æˆ‘ä»¬æ·»åŠ çš„<strong>æ ‡ç­¾
            const lines = formatted.split('\n');
            return lines.map(line => {
                const trimmed = line.trim();
                if (!trimmed) return ''; // è·³è¿‡ç©ºè¡Œ

                // å¦‚æœæ˜¯åŒ…å«<strong>çš„è¡Œï¼Œä¿ç•™åŸæ ·
                if (trimmed.includes('<strong>')) {
                    return trimmed;
                }
                // æ™®é€šæ–‡æœ¬è¡Œï¼Œè½¬ä¹‰HTML
                const escaped = trimmed
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                return escaped;
            }).filter(line => line.length > 0).join('<br>');
        }

        function closeModal() {
            document.getElementById('activityModal').classList.remove('active');
        }

        // ç‚¹å‡»é®ç½©å…³é—­å¼¹çª—
        document.getElementById('activityModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ESC é”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // =====================================================
        // åˆå§‹åŒ–
        // =====================================================

        // ç”ŸæˆæŒ‡å®šå‘¨çš„æ—¥æœŸæ•°æ®ï¼ˆæ”¯æŒåç§»é‡ï¼‰
        function generateWeekDates(offset = 0) {
            const today = new Date();
            const currentDay = today.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ...

            // è®¡ç®—åˆ°æœ¬å‘¨ä¸€çš„å¤©æ•°å·®
            const daysToMonday = currentDay === 0 ? 6 : currentDay - 1;

            // è·å–æœ¬å‘¨ä¸€çš„æ—¥æœŸ
            const monday = new Date(today);
            monday.setDate(today.getDate() - daysToMonday + (offset * 7));

            // ç”Ÿæˆ7å¤©çš„æ—¥æœŸ
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);

                weekDates.push({
                    day: i === 6 ? 0 : i + 1, // 0=å‘¨æ—¥, 1-6=å‘¨ä¸€åˆ°å‘¨å…­
                    date: date.getDate(),
                    month: date.getMonth() + 1,
                    year: date.getFullYear(),
                    dayName: i === 6 ? 'å‘¨æ—¥' : ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][i],
                    isToday: date.getDate() === today.getDate() &&
                              date.getMonth() === today.getMonth() &&
                              date.getFullYear() === today.getFullYear()
                });
            }

            return weekDates;
        }

        // æ›´æ–°æ—¥æœŸè¡¨å¤´
        function updateDateHeaders(headerId = 'dateGridHeader') {
            weekDates = generateWeekDates(currentWeekOffset); // ä½¿ç”¨å½“å‰åç§»é‡
            const headerContainer = document.getElementById(headerId);

            if (!headerContainer) return;

            let html = '';
            weekDates.forEach(dateInfo => {
                const dateText = `${dateInfo.date} ${dateInfo.dayName}`; // æ ¼å¼: "19 å‘¨ä¸€"
                const todayClass = dateInfo.isToday ? ' today-header' : '';

                html += `
                    <div class="date-cell-header ${todayClass}"
                         data-day="${dateInfo.day}"
                         onclick="toggleDayFilter(${dateInfo.day})"
                         title="ç‚¹å‡»ç­›é€‰${dateInfo.dayName}">
                        ${dateText}
                    </div>
                `;
            });

            headerContainer.innerHTML = html;

            // æ›´æ–°å‘¨æ ‡é¢˜æ˜¾ç¤º
            updateWeekTitle();
        }

        // æ›´æ–°å‘¨æ ‡é¢˜æ˜¾ç¤º
        function updateWeekTitle() {
            const titleElement = document.getElementById('monthLabel');
            if (!titleElement) return;

            const firstDay = weekDates[0];
            const lastDay = weekDates[6];

            let title = '';
            if (currentWeekOffset === 0) {
                title = 'æœ¬å‘¨æ´»åŠ¨';
            } else if (currentWeekOffset === -1) {
                title = 'ä¸Šå‘¨æ´»åŠ¨';
            } else if (currentWeekOffset === 1) {
                title = 'ä¸‹å‘¨æ´»åŠ¨';
            } else {
                const weekNum = currentWeekOffset > 0 ? `+${currentWeekOffset}` : currentWeekOffset;
                title = `${weekNum}å‘¨æ´»åŠ¨`;
            }

            titleElement.textContent = `${title} (${firstDay.month}/${firstDay.date} - ${lastDay.month}/${lastDay.date})`;
        }

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        document.addEventListener('DOMContentLoaded', async function() {
            // æ£€æŸ¥åº”ç”¨ç‰ˆæœ¬ï¼ˆåœ¨æ‰€æœ‰åˆå§‹åŒ–ä¹‹å‰ï¼‰
            await checkAppVersion();

            // æ›´æ–°æ—¥æœŸè¡¨å¤´
            updateDateHeaders();

            // ç§»åŠ¨ç«¯ï¼šå°†ä»Šå¤©æ»šåŠ¨åˆ°è§†å›¾ä¸­å¿ƒ
            if (window.innerWidth <= 768) {
                const todayHeader = document.querySelector('.date-cell-header.today-header');
                if (todayHeader) {
                    // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
                    setTimeout(() => {
                        todayHeader.scrollIntoView({
                            behavior: 'smooth',
                            block: 'nearest',
                            inline: 'center'
                        });
                    }, 100);
                }
            }

            // è·å–æ´»åŠ¨æ•°æ®
            fetchActivities();

            // æœç´¢è¾“å…¥æ¡†å›è½¦ç›‘å¬
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        });
    </script>

    <!-- ç§»åŠ¨ç«¯ç­›é€‰åˆ‡æ¢æŒ‰é’®ï¼ˆä»…ç§»åŠ¨ç«¯æ˜¾ç¤ºï¼‰ -->
    <button class="filter-toggle-btn" id="filterToggleBtn" onclick="toggleMobileFilter()" style="display: none;">
        <span id="filterIcon">âš™ï¸</span>
    </button>

    <script>
        // =====================================================
        // ç§»åŠ¨ç«¯ç­›é€‰äº¤äº’
        // =====================================================

        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // åˆå§‹åŒ–ç§»åŠ¨ç«¯ç­›é€‰æŒ‰é’®
        function initMobileFilter() {
            const btn = document.getElementById('filterToggleBtn');
            if (isMobile()) {
                btn.style.display = 'flex';
            } else {
                btn.style.display = 'none';
            }
        }

        // åˆ‡æ¢ç­›é€‰å™¨å±•å¼€/æŠ˜å 
        function toggleMobileFilter() {
            const filterSection = document.querySelector('.filter-section');
            const btn = document.getElementById('filterToggleBtn');
            const icon = document.getElementById('filterIcon');

            filterSection.classList.toggle('expanded');
            const isExpanded = filterSection.classList.contains('expanded');

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            btn.classList.toggle('active', isExpanded);
            icon.textContent = isExpanded ? 'âœ•' : 'âš™ï¸';

            // è§¦è§‰åé¦ˆ
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }

            // æ›´æ–°æŒ‰é’®æç¤º
            btn.title = isExpanded ? 'æ”¶èµ·ç­›é€‰' : 'å±•å¼€ç­›é€‰';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initMobileFilter();

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(initMobileFilter, 250);
            });
        });
    </script>
</body>
</html>
