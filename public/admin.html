<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨ç®¡ç†åå° - Chiengmai</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            padding: 10px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #66bb6a;
            color: white;
        }

        .btn-danger {
            background: #ef5350;
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            overflow-x: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        tbody tr:hover {
            background-color: #f5f5f5;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: 700;
            padding: 20px 30px 10px 30px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-footer {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 20px 30px;
            border-top: 1px solid #e0e0e0;
            background: white;
            border-radius: 0 0 20px 20px;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        /* åˆ†ç±»æ ‡ç­¾é¢œè‰² */
        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-ç‘œä¼½ { background: #FF6B6B; color: white; }
        .badge-å†¥æƒ³ { background: #4ECDC4; color: white; }
        .badge-æˆ·å¤–æ¢é™© { background: #FFE66D; color: #333; }
        .badge-æ–‡åŒ–è‰ºæœ¯ { background: #95E1D3; color: #333; }
        .badge-ç¾é£Ÿä½“éªŒ { background: #F38181; color: white; }
        .badge-èŠ‚åº†æ´»åŠ¨ { background: #AA96DA; color: white; }
        .badge-å…¶ä»– { background: #667eea; color: white; }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending { background: #FFA726; color: white; }
        .status-ongoing { background: #66BB6A; color: white; }
        .status-suspended { background: #2196F3; color: white; }
        .status-expired { background: #EF5350; color: white; }
        .status-draft { background: #9E9E9E; color: white; }

        /* è‰ç¨¿æŒ‰é’®æ ·å¼ */
        .btn-draft {
            background: #9E9E9E;
            color: white;
            margin-right: 10px;
        }

        .btn-draft:hover {
            background: #757575;
        }

        /* æ‹–æ‹½ä¸Šä¼ æ ·å¼ */
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8eaf6;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 12px;
        }

        .image-previews {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .image-preview {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }

        .image-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .image-preview .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ef5350;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-preview:hover .delete-btn {
            opacity: 1;
        }

        .image-preview .image-order {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-progress {
            display: none;
            margin-top: 10px;
        }

        .upload-progress.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .upload-progress.active .progress-fill {
            width: 100%;
        }

        /* Tab åˆ‡æ¢æ ·å¼ */
        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button:hover {
            color: #667eea;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .weekday-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .weekday-checkbox {
            display: none;
        }

        .weekday-label {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .weekday-checkbox:checked + .weekday-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸï¸ æ´»åŠ¨ç®¡ç†åå°</h1>
        <p style="color: #666; margin-bottom: 20px;">æ¸…è¿ˆæ´»åŠ¨æŸ¥è¯¢å¹³å° - æ•°æ®ç®¡ç†</p>

        <div class="toolbar">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <a href="http://localhost:5173" target="_blank" class="btn btn-success" style="text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">
                    ğŸŒ è®¿é—®å‰ç«¯é¡µé¢
                </a>
                <a href="/ai-import.html" class="btn btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">
                    ğŸ¤– AI æ™ºèƒ½å¯¼å…¥
                </a>
                <button class="btn btn-primary" onclick="importFromExcel()" style="display: inline-flex; align-items: center; gap: 5px;">
                    ğŸ“¥ å¯¼å…¥Excel
                </button>
                <button class="btn btn-secondary" onclick="exportToExcel()" style="display: inline-flex; align-items: center; gap: 5px;">
                    ğŸ“¤ å¯¼å‡ºExcel
                </button>
                <button class="btn btn-primary" onclick="openGuideModal()" style="display: inline-flex; align-items: center; gap: 5px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    ğŸ“– æ”»ç•¥ç®¡ç†
                </button>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <select id="categoryFilter" class="btn btn-secondary">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option value="ç‘œä¼½">ç‘œä¼½</option>
                    <option value="å†¥æƒ³">å†¥æƒ³</option>
                    <option value="æˆ·å¤–æ¢é™©">æˆ·å¤–æ¢é™©</option>
                    <option value="æ–‡åŒ–è‰ºæœ¯">æ–‡åŒ–è‰ºæœ¯</option>
                    <option value="ç¾é£Ÿä½“éªŒ">ç¾é£Ÿä½“éªŒ</option>
                    <option value="èŠ‚åº†æ´»åŠ¨">èŠ‚åº†æ´»åŠ¨</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <select id="statusFilter" class="btn btn-secondary">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="draft">è‰ç¨¿</option>
                    <option value="pending">å¾…å¼€å§‹</option>
                    <option value="ongoing">è¿›è¡Œä¸­</option>
                    <option value="suspended">æš‚åœä¸­</option>
                    <option value="expired">å·²è¿‡æœŸ</option>
                </select>
                <button class="btn btn-primary" onclick="openFormModal()">
                    â• æ–°å¢æ´»åŠ¨
                </button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">åºå·</th>
                        <th style="width: 80px;">æ´»åŠ¨ç¼–å·</th>
                        <th>æ ‡é¢˜</th>
                        <th style="width: 100px;">åˆ†ç±»</th>
                        <th style="width: 150px;">æ—¥æœŸ/æ˜ŸæœŸ</th>
                        <th style="width: 100px;">æ—¶é—´</th>
                        <th style="width: 100px;">åœ°ç‚¹</th>
                        <th style="width: 100px;">ä»·æ ¼</th>
                        <th style="width: 80px;">é“¾æ¥</th>
                        <th style="width: 80px;">çŠ¶æ€</th>
                        <th style="width: 150px;">æœ€åæ›´æ–°æ—¶é—´</th>
                        <th style="width: 150px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="12" style="text-align: center; padding: 40px; color: #999;">
                            åŠ è½½ä¸­...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ç¼–è¾‘å¼¹çª— -->
    <div class="modal" id="formModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">æ–°å¢æ´»åŠ¨</div>
            <div class="modal-body">
                <form id="dataForm">
                    <input type="hidden" id="itemId">

                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <h3 style="margin: 20px 0 15px 0; color: #667eea;">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="activityNumber">æ´»åŠ¨ç¼–å·</label>
                        <input type="text" id="activityNumber" name="activityNumber" placeholder="è‡ªåŠ¨ç”Ÿæˆ" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label for="title">æ´»åŠ¨æ ‡é¢˜ *</label>
                        <input type="text" id="title" name="title" placeholder="è¯·è¾“å…¥æ´»åŠ¨æ ‡é¢˜" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="category">åˆ†ç±» *</label>
                        <select id="category" name="category" required>
                            <option value="ç‘œä¼½">ç‘œä¼½</option>
                            <option value="å†¥æƒ³">å†¥æƒ³</option>
                            <option value="æˆ·å¤–æ¢é™©">æˆ·å¤–æ¢é™©</option>
                            <option value="æ–‡åŒ–è‰ºæœ¯">æ–‡åŒ–è‰ºæœ¯</option>
                            <option value="ç¾é£Ÿä½“éªŒ">ç¾é£Ÿä½“éªŒ</option>
                            <option value="èŠ‚åº†æ´»åŠ¨">èŠ‚åº†æ´»åŠ¨</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">çŠ¶æ€</label>
                        <select id="status" name="status">
                            <option value="draft">è‰ç¨¿</option>
                            <option value="pending">å¾…å¼€å§‹</option>
                            <option value="ongoing">è¿›è¡Œä¸­</option>
                            <option value="suspended">æš‚åœä¸­</option>
                            <option value="expired">å·²è¿‡æœŸ</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">æ´»åŠ¨æè¿° *</label>
                    <textarea id="description" name="description" rows="3" placeholder="è¯·è¾“å…¥æ´»åŠ¨æè¿°" required></textarea>
                </div>

                <!-- æ—¶é—´ä¿¡æ¯ -->
                <h3 style="margin: 20px 0 15px 0; color: #667eea;">â° æ—¶é—´ä¿¡æ¯</h3>

                <!-- Tab åˆ‡æ¢ -->
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button type="button" class="tab-button active" onclick="switchTab('fixed')">ğŸ“… å›ºå®šé¢‘ç‡æ´»åŠ¨</button>
                        <button type="button" class="tab-button" onclick="switchTab('temporary')">ğŸ“ ä¸´æ—¶æ´»åŠ¨</button>
                    </div>

                    <!-- å›ºå®šé¢‘ç‡æ´»åŠ¨ -->
                    <div id="fixedTab" class="tab-content active">
                        <div class="form-group">
                            <label>é€‰æ‹©æ˜ŸæœŸï¼ˆå¯å¤šé€‰ï¼‰</label>
                            <div class="weekday-selector">
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="1">
                                    <span class="weekday-label">å‘¨ä¸€</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="2">
                                    <span class="weekday-label">å‘¨äºŒ</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="3">
                                    <span class="weekday-label">å‘¨ä¸‰</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="4">
                                    <span class="weekday-label">å‘¨å››</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="5">
                                    <span class="weekday-label">å‘¨äº”</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="6">
                                    <span class="weekday-label">å‘¨å…­</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="0">
                                    <span class="weekday-label">å‘¨æ—¥</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fixedTime">æ—¶é—´</label>
                                <input type="text" id="fixedTime" name="fixedTime" placeholder="ä¾‹å¦‚ï¼š09:00-10:30">
                            </div>
                            <div class="form-group">
                                <label for="duration">æŒç»­æ—¶é—´</label>
                                <input type="text" id="duration" name="duration" placeholder="ä¾‹å¦‚ï¼š1.5å°æ—¶">
                            </div>
                        </div>

                        <div class="form-group">
                            <label style="color: #666; font-size: 12px;">
                                ğŸ’¡ å›ºå®šé¢‘ç‡æ´»åŠ¨ï¼šæ¯å‘¨åœ¨é€‰æ‹©çš„æ˜ŸæœŸå‡ é‡å¤è¿›è¡Œ
                            </label>
                        </div>
                    </div>

                    <!-- ä¸´æ—¶æ´»åŠ¨ -->
                    <div id="temporaryTab" class="tab-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="date">å…·ä½“æ—¥æœŸ</label>
                                <input type="date" id="date" name="date">
                            </div>
                            <div class="form-group">
                                <label for="time">æ—¶é—´</label>
                                <input type="text" id="time" name="time" placeholder="ä¾‹å¦‚ï¼š09:00-10:30">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="tempDuration">æŒç»­æ—¶é—´</label>
                            <input type="text" id="tempDuration" name="tempDuration" placeholder="ä¾‹å¦‚ï¼š1.5å°æ—¶">
                        </div>

                        <div class="form-group">
                            <label style="color: #666; font-size: 12px;">
                                ğŸ’¡ ä¸´æ—¶æ´»åŠ¨ï¼šä»…åœ¨æŒ‡å®šçš„å…·ä½“æ—¥æœŸè¿›è¡Œä¸€æ¬¡
                            </label>
                        </div>
                    </div>
                </div>

                <!-- çµæ´»æ—¶é—´é€‰é¡¹ -->
                <div class="form-group" style="margin-top: 15px; padding: 12px; background: #f0f4ff; border-radius: 8px; border-left: 4px solid #667eea;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0;">
                        <input type="checkbox" id="flexibleTime" name="flexibleTime">
                        <span style="font-weight: 500;">ğŸ• çµæ´»æ—¶é—´æ´»åŠ¨</span>
                    </label>
                    <div style="color: #666; font-size: 12px; margin-top: 8px; margin-left: 24px;">
                        å‹¾é€‰æ­¤é¡¹è¡¨ç¤ºæ´»åŠ¨æ—¶é—´çµæ´»ï¼Œå‚ä¸è€…å¯ä»¥åœ¨å¼€æ”¾æ—¶é—´èŒƒå›´å†…è‡ªç”±é€‰æ‹©ï¼ˆå¦‚ï¼šå…¨å¤©å¼€æ”¾çš„å¥èº«æˆ¿ã€æ¸¸æ³³ã€åˆ’èˆ¹ç­‰ï¼‰
                    </div>
                </div>

                <!-- åœ°ç‚¹ä¿¡æ¯ -->
                <h3 style="margin: 20px 0 15px 0; color: #667eea;">ğŸ“ åœ°ç‚¹ä¿¡æ¯</h3>
                <div class="form-group">
                    <label for="location">åœ°ç‚¹åç§° *</label>
                    <input type="text" id="location" name="location" placeholder="ä¾‹å¦‚ï¼šå®æ›¼ä¸€å·ç‘œä¼½é¦†" required>
                </div>

                <div class="form-group">
                    <label for="address">è¯¦ç»†åœ°å€</label>
                    <input type="text" id="address" name="address" placeholder="è¯¦ç»†åœ°å€">
                </div>


                <!-- ä»·æ ¼ä¿¡æ¯ -->
                <h3 style="margin: 20px 0 15px 0; color: #667eea;">ğŸ’° ä»·æ ¼ä¿¡æ¯</h3>
                <div class="form-group">
                    <label for="price">ä»·æ ¼æ˜¾ç¤º</label>
                    <input type="text" id="price" name="price" placeholder="ä¾‹å¦‚ï¼šå…è´¹ã€500à¸¿">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="priceMin">æœ€ä½ä»·æ ¼</label>
                        <input type="number" id="priceMin" name="priceMin" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="priceMax">æœ€é«˜ä»·æ ¼</label>
                        <input type="number" id="priceMax" name="priceMax" placeholder="0">
                    </div>
                </div>

                <!-- å‚ä¸äººæ•° -->
                <h3 style="margin: 20px 0 15px 0; color: #667eea;">ğŸ‘¥ å‚ä¸ä¿¡æ¯</h3>
                <div class="form-group">
                    <label for="maxParticipants">æœ€å¤§äººæ•°</label>
                    <input type="number" id="maxParticipants" name="maxParticipants" placeholder="0è¡¨ç¤ºä¸é™">
                </div>

                <!-- å…¶ä»–é€‰é¡¹ -->
                <h3 style="margin: 20px 0 15px 0; color: #667eea;">âš™ï¸ å…¶ä»–é€‰é¡¹</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="requireBooking" name="requireBooking" checked>
                            éœ€è¦é¢„çº¦
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ´»åŠ¨å›¾ç‰‡</label>

                    <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">ğŸ“¸</div>
                        <div class="upload-text">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»ä¸Šä¼ </div>
                        <div class="upload-hint">æ”¯æŒ JPGã€PNGã€GIFã€WEBP æ ¼å¼ï¼Œæœ€å¤§5MB</div>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;" multiple>
                    </div>

                    <!-- ä¸Šä¼ è¿›åº¦ -->
                    <div class="upload-progress" id="uploadProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="upload-hint" id="uploadStatus">ä¸Šä¼ ä¸­...</div>
                    </div>

                    <!-- å›¾ç‰‡é¢„è§ˆ -->
                    <div class="image-previews" id="imagePreviews"></div>

                    <!-- ä¹Ÿå¯ä»¥æ‰‹åŠ¨è¾“å…¥URL -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <label style="font-size: 12px; color: #666; margin-bottom: 8px;">æˆ–æ‰‹åŠ¨è¾“å…¥å›¾ç‰‡URLï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</label>
                        <textarea id="imageUrls" rows="2" placeholder="https://example.com/image1.jpg" style="font-size: 12px;"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label for="sourceUrl">æ¥æºé“¾æ¥</label>
                    <input type="url" id="sourceUrl" name="sourceUrl" placeholder="https://...">
                </div>
            </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeFormModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-draft" onclick="submitFormAsDraft()">ğŸ“ è‰ç¨¿</button>
                <button type="submit" class="btn btn-success" form="dataForm">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ”»ç•¥ç®¡ç†å¼¹çª— -->
    <div class="modal" id="guideModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <div>ğŸ“– æ”»ç•¥ä¿¡æ¯ç®¡ç†</div>
                <button class="close-btn" onclick="closeGuideModal()">âœ•</button>
            </div>

            <div class="modal-body">
                <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å·¥å…·æ  -->
                <div style="border: 1px solid #e0e0e0; border-bottom: none; padding: 10px; background: #f5f5f5; border-radius: 8px 8px 0 0; display: flex; gap: 5px; flex-wrap: wrap; align-items: center;">
                    <button type="button" onclick="formatDoc('bold')" class="btn btn-secondary" style="padding: 6px 12px; font-weight: bold;" title="ç²—ä½“">B</button>
                    <button type="button" onclick="formatDoc('italic')" class="btn btn-secondary" style="padding: 6px 12px; font-style: italic;" title="æ–œä½“">I</button>
                    <button type="button" onclick="formatDoc('underline')" class="btn btn-secondary" style="padding: 6px 12px; text-decoration: underline;" title="ä¸‹åˆ’çº¿">U</button>
                    <div style="width: 1px; background: #ddd; margin: 0 5px;"></div>
                    <button type="button" onclick="formatDoc('justifyLeft')" class="btn btn-secondary" style="padding: 6px 12px;" title="å·¦å¯¹é½">â‡¤</button>
                    <button type="button" onclick="formatDoc('justifyCenter')" class="btn btn-secondary" style="padding: 6px 12px;" title="å±…ä¸­">â‡”</button>
                    <button type="button" onclick="formatDoc('justifyRight')" class="btn btn-secondary" style="padding: 6px 12px;" title="å³å¯¹é½">â‡¥</button>
                    <div style="width: 1px; background: #ddd; margin: 0 5px;"></div>
                    <button type="button" onclick="formatDoc('insertUnorderedList')" class="btn btn-secondary" style="padding: 6px 12px;" title="æ— åºåˆ—è¡¨">â€¢â‰¡</button>
                    <button type="button" onclick="formatDoc('insertOrderedList')" class="btn btn-secondary" style="padding: 6px 12px;" title="æœ‰åºåˆ—è¡¨">1â‰¡</button>
                    <div style="width: 1px; background: #ddd; margin: 0 5px;"></div>
                    <select onchange="formatDoc('formatBlock', this.value)" class="btn btn-secondary" style="padding: 6px;">
                        <option value="p">æ®µè½</option>
                        <option value="h1">æ ‡é¢˜1</option>
                        <option value="h2">æ ‡é¢˜2</option>
                        <option value="h3">æ ‡é¢˜3</option>
                        <option value="h4">æ ‡é¢˜4</option>
                    </select>
                    <select onchange="formatDoc('fontName', this.value)" class="btn btn-secondary" style="padding: 6px;">
                        <option value="Arial">Arial</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                    </select>
                    <select onchange="formatDoc('fontSize', this.value)" class="btn btn-secondary" style="padding: 6px;">
                        <option value="1">å°</option>
                        <option value="3">æ­£å¸¸</option>
                        <option value="5">å¤§</option>
                        <option value="7">ç‰¹å¤§</option>
                    </select>
                    <div style="width: 1px; background: #ddd; margin: 0 5px;"></div>
                    <input type="color" onchange="formatDoc('foreColor', this.value)" class="btn btn-secondary" style="padding: 2px 6px; height: 32px; width: 40px;" title="æ–‡å­—é¢œè‰²">
                    <input type="color" onchange="formatDoc('hiliteColor', this.value)" class="btn btn-secondary" style="padding: 2px 6px; height: 32px; width: 40px;" value="#ffff00" title="èƒŒæ™¯é¢œè‰²">
                    <div style="width: 1px; background: #ddd; margin: 0 5px;"></div>
                    <button type="button" onclick="cleanEditorContent()" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" title="ä¸€é”®æ¸…ç†æ ¼å¼">ğŸ§¹ æ¸…ç†æ ¼å¼</button>
                </div>

                <!-- å¯Œæ–‡æœ¬ç¼–è¾‘åŒºåŸŸ -->
                <div id="guideEditor" contenteditable="true" style="
                    border: 1px solid #e0e0e0;
                    border-radius: 0 0 8px 8px;
                    min-height: 500px;
                    max-height: 800px;
                    overflow-y: auto;
                    padding: 20px;
                    font-size: 14px;
                    line-height: 1.8;
                    background: white;
                    margin-bottom: 10px;
                "></div>

                <style>
                    /* æ”»ç•¥ç¼–è¾‘å™¨æ ·å¼ - ä¿æŒå±‚çº§æ¸…æ™° */
                    #guideEditor {
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif !important;
                        font-size: 14px !important;
                        line-height: 1.6 !important;
                        color: #333 !important;
                    }

                    /* æ ‡é¢˜å±‚çº§æ¸…æ™°æ˜¾ç¤º */
                    #guideEditor h1 {
                        display: block !important;
                        width: 100% !important;
                        margin: 30px 0 12px 0 !important;
                        padding: 8px 0 !important;
                        font-size: 18px !important;
                        font-weight: 700 !important;
                        line-height: 1.4 !important;
                        color: #222 !important;
                        border-bottom: 2px solid #667eea !important;
                        clear: both !important;
                    }
                    #guideEditor h2 {
                        font-size: 16px !important;
                        font-weight: 600 !important;
                        margin: 14px 0 6px 0 !important;
                        line-height: 1.4 !important;
                        color: #333 !important;
                    }
                    #guideEditor h3 {
                        font-size: 15px !important;
                        font-weight: 600 !important;
                        margin: 12px 0 6px 0 !important;
                        line-height: 1.4 !important;
                        color: #444 !important;
                    }
                    #guideEditor h4 {
                        font-size: 14px !important;
                        font-weight: 600 !important;
                        margin: 10px 0 6px 0 !important;
                        line-height: 1.4 !important;
                        color: #555 !important;
                    }

                    /* æ®µè½æ ·å¼ */
                    #guideEditor p {
                        margin: 8px 0 !important;
                        line-height: 1.6 !important;
                        font-size: 14px !important;
                        color: #333 !important;
                    }

                    /* åˆ—è¡¨æ ·å¼ */
                    #guideEditor ul, #guideEditor ol {
                        margin: 8px 0 !important;
                        padding-left: 24px !important;
                    }
                    #guideEditor li {
                        margin: 4px 0 !important;
                        line-height: 1.6 !important;
                        font-size: 14px !important;
                        color: #333 !important;
                    }

                    /* æ–‡æœ¬æ ¼å¼ */
                    #guideEditor strong {
                        font-weight: 600 !important;
                        color: #222 !important;
                    }
                    #guideEditor em, #guideEditor i {
                        font-style: italic !important;
                    }
                    #guideEditor u {
                        text-decoration: underline !important;
                    }

                    /* è¡¨æ ¼æ ·å¼ - ä¿æŒè¾¹æ¡†æ¸…æ™° */
                    #guideEditor table {
                        border-collapse: collapse !important;
                        width: 100% !important;
                        margin: 12px 0 !important;
                        font-size: 13px !important;
                        border: 2px solid #ddd !important;
                    }
                    #guideEditor th, #guideEditor td {
                        border: 1px solid #ddd !important;
                        padding: 8px 12px !important;
                        text-align: left !important;
                        line-height: 1.5 !important;
                        font-size: 13px !important;
                        vertical-align: top !important;
                    }
                    #guideEditor th {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                        color: white !important;
                        font-weight: 600 !important;
                        text-align: center !important;
                    }
                    #guideEditor tr:nth-child(even) {
                        background-color: #f9f9f9 !important;
                    }
                    #guideEditor tr:hover {
                        background-color: #f0f4ff !important;
                    }

                    /* é“¾æ¥æ ·å¼ */
                    #guideEditor a {
                        color: #667eea !important;
                        text-decoration: none !important;
                        border-bottom: 1px dotted #667eea !important;
                    }
                    #guideEditor a:hover {
                        color: #764ba2 !important;
                        border-bottom-style: solid !important;
                    }

                    /* æ¸…é™¤æ‰€æœ‰å…ƒç´ çš„å†…è”æ ·å¼å¹²æ‰° */
                    #guideEditor *[style*="font-size"],
                    #guideEditor *[style*="color"],
                    #guideEditor *[style*="font-family"] {
                        font-size: inherit !important;
                        color: inherit !important;
                        font-family: inherit !important;
                    }
                </style>

                <!-- æç¤ºä¿¡æ¯ -->
                <div style="color: #666; font-size: 12px; padding: 10px; background: #f0f0f0; border-radius: 6px;">
                    ğŸ’¡ æç¤ºï¼šå¯ä»¥ç²˜è´´å¯Œæ–‡æœ¬å†…å®¹ï¼Œä½¿ç”¨å·¥å…·æ æ ¼å¼åŒ–æ–‡å­—ï¼Œæˆ–ç›´æ¥è¾“å…¥å†…å®¹ã€‚ä¿å­˜åå°†æ˜¾ç¤ºåœ¨å‰ç«¯çš„"æ”»ç•¥ä¿¡æ¯"Tabä¸­ã€‚
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeGuideModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="saveGuideContent()">ğŸ’¾ ä¿å­˜æ”»ç•¥</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let items = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadItems();
        });

        // åŠ è½½æ•°æ®
        async function loadItems() {
            try {
                const response = await fetch(`${API_BASE}/items`);
                const result = await response.json();
                items = result.data || [];
                renderTable();
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="12" style="text-align: center; color: #999;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filteredItems = items;

            if (categoryFilter) {
                filteredItems = filteredItems.filter(item => item.category === categoryFilter);
            }

            if (statusFilter) {
                filteredItems = filteredItems.filter(item => item.status === statusFilter);
            }

            if (filteredItems.length === 0) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 40px; color: #999;">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            document.getElementById('tableBody').innerHTML = filteredItems.map((item, index) => {
                let activityNumber = item.activityNumber || item['æ´»åŠ¨ç¼–å·'] || '-';
                // å»æ‰#å·ï¼Œåªæ˜¾ç¤ºæ•°å­—
                activityNumber = activityNumber.replace('#', '');

                // æ˜¾ç¤ºæ—¥æœŸæˆ–æ˜ŸæœŸ
                let dateDisplay = '-';
                if (item.weekdays && Array.isArray(item.weekdays) && item.weekdays.length > 0) {
                    // å›ºå®šé¢‘ç‡æ´»åŠ¨ï¼šæ˜¾ç¤ºæ˜ŸæœŸï¼ˆæœ€å¤šæ˜¾ç¤º4ä¸ªï¼Œè¶…è¿‡æ˜¾ç¤º"ç­‰"ï¼‰
                    const displayWeekdays = item.weekdays.slice(0, 4);
                    dateDisplay = displayWeekdays.join(', ');
                    if (item.weekdays.length > 4) {
                        dateDisplay += ' ç­‰' + item.weekdays.length + 'å¤©';
                    }
                } else if (item.date) {
                    // ä¸´æ—¶æ´»åŠ¨ï¼šæ˜¾ç¤ºå…·ä½“æ—¥æœŸ
                    dateDisplay = item.date;
                }

                // æ˜¾ç¤ºæ¥æºé“¾æ¥
                let sourceLink = '-';
                if (item.source && item.source.url) {
                    sourceLink = `<a href="${item.source.url}" target="_blank" style="color: #667eea; text-decoration: none;" title="${item.source.url}">ğŸ”—</a>`;
                }

                // æ˜¾ç¤ºæœ€åæ›´æ–°æ—¶é—´
                let updatedAtDisplay = '-';
                if (item.updatedAt) {
                    try {
                        const date = new Date(item.updatedAt);
                        // æ ¼å¼åŒ–ä¸ºï¼šYYYY-MM-DD HH:mm
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        updatedAtDisplay = `${year}-${month}-${day}<br><small style="color: #999;">${hours}:${minutes}</small>`;
                    } catch (e) {
                        updatedAtDisplay = '-';
                    }
                }

                return `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${activityNumber}</strong></td>
                    <td><strong>${escapeHtml(item.title)}</strong></td>
                    <td>${item.category}</td>
                    <td style="font-size: 12px; line-height: 1.4;">${dateDisplay}</td>
                    <td>${item.time || '-'}</td>
                    <td>${escapeHtml(item.location || '-').substring(0, 15)}</td>
                    <td>${item.price || '-'}</td>
                    <td style="text-align: center;">${sourceLink}</td>
                    <td><span class="status-badge status-${item.status}">${getStatusText(item.status)}</span></td>
                    <td style="font-size: 12px; line-height: 1.4;">${updatedAtDisplay}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editItem('${item.id}')" style="padding: 6px 12px; font-size: 12px;">ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deleteItem('${item.id}')" style="padding: 6px 12px; font-size: 12px;">åˆ é™¤</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // åˆ‡æ¢ Tab
        function switchTab(tabType) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // åˆ‡æ¢å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabType + 'Tab').classList.add('active');
        }

        // ========== å›¾ç‰‡ç›¸å…³å‡½æ•°ï¼ˆéœ€è¦æå‰å®šä¹‰ï¼‰==========

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
        function displayImagePreview(imageUrl, index) {
            const previewsContainer = document.getElementById('imagePreviews');

            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-preview';
            previewDiv.dataset.index = index;
            previewDiv.dataset.url = imageUrl;

            previewDiv.innerHTML = `
                <img src="${imageUrl}" alt="é¢„è§ˆå›¾ç‰‡" loading="lazy">
                <div class="image-overlay">
                    <button class="delete-image-btn" onclick="deleteImage(${index})" title="åˆ é™¤å›¾ç‰‡">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="image-order">${index + 1}</div>
            `;

            previewsContainer.appendChild(previewDiv);
        }

        // åˆ é™¤å›¾ç‰‡
        async function deleteImage(index) {
            const previewDiv = document.querySelector(`.image-preview[data-index="${index}"]`);
            if (!previewDiv) return;

            const imageUrl = previewDiv.dataset.url;

            // å¦‚æœæ˜¯ä¸Šä¼ çš„å›¾ç‰‡ï¼Œä»æœåŠ¡å™¨åˆ é™¤
            if (imageUrl.startsWith('/uploads/')) {
                const filename = imageUrl.split('/').pop();
                try {
                    await fetch(`/api/upload/${filename}`, { method: 'DELETE' });
                } catch (error) {
                    console.error('åˆ é™¤æœåŠ¡å™¨æ–‡ä»¶å¤±è´¥:', error);
                }
            }

            // ä»æ•°ç»„ä¸­ç§»é™¤
            uploadedImages = uploadedImages.filter((url, i) => i !== index);

            // ç§»é™¤é¢„è§ˆå…ƒç´ 
            previewDiv.remove();

            // æ›´æ–°ç´¢å¼•
            updateImageIndexes();

            // æ›´æ–°textarea
            updateImagesTextarea();
        }

        // æ›´æ–°å›¾ç‰‡ç´¢å¼•
        function updateImageIndexes() {
            const previews = document.querySelectorAll('.image-preview');
            previews.forEach((preview, newIndex) => {
                preview.dataset.index = newIndex;
                const orderBadge = preview.querySelector('.image-order');
                if (orderBadge) {
                    orderBadge.textContent = newIndex + 1;
                }
                const deleteBtn = preview.querySelector('.delete-image-btn');
                if (deleteBtn) {
                    deleteBtn.onclick = () => deleteImage(newIndex);
                }
            });
        }

        // æ›´æ–°å›¾ç‰‡URLçš„textarea
        function updateImagesTextarea() {
            const textarea = document.getElementById('imageUrls');
            const imagesTextarea = document.getElementById('images');

            if (!textarea) return;

            // è·å–æ‰‹åŠ¨è¾“å…¥çš„URL
            const manualUrls = textarea.value.split('\n').filter(url => url.trim());

            // åˆå¹¶ä¸Šä¼ çš„URLå’Œæ‰‹åŠ¨è¾“å…¥çš„URL
            const allUrls = [...uploadedImages, ...manualUrls];

            // æ›´æ–°éšè—çš„imageså­—æ®µ
            if (imagesTextarea) {
                imagesTextarea.value = allUrls.join('\n');
            }
        }

        // ========== è¡¨å•æ“ä½œå‡½æ•° ==========

        // æ‰“å¼€è¡¨å•å¼¹çª—
        // å®‰å…¨è®¾ç½®å…ƒç´ å€¼çš„è¾…åŠ©å‡½æ•°
        function safeSetValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = value;
                return true;
            } else {
                console.warn(`å…ƒç´ ä¸å­˜åœ¨: ${elementId}`);
                return false;
            }
        }

        function safeSetText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
                return true;
            } else {
                console.warn(`å…ƒç´ ä¸å­˜åœ¨: ${elementId}`);
                return false;
            }
        }

        function safeChecked(elementId, checked) {
            const element = document.getElementById(elementId);
            if (element) {
                element.checked = checked;
                return true;
            } else {
                console.warn(`å…ƒç´ ä¸å­˜åœ¨: ${elementId}`);
                return false;
            }
        }

        // æ‰“å¼€è¡¨å•å¼¹çª—
        function openFormModal(item = null) {
            try {
                const form = document.getElementById('dataForm');
                if (!form) {
                    alert('é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¡¨å•');
                    return;
                }

                form.reset();
                safeSetValue('itemId', '');
                safeSetValue('activityNumber', '');
                safeSetText('modalTitle', 'æ–°å¢æ´»åŠ¨');

                // æ¸…ç©ºä¸Šä¼ çš„å›¾ç‰‡åˆ—è¡¨
                uploadedImages = [];
                const imagePreviews = document.getElementById('imagePreviews');
                if (imagePreviews) imagePreviews.innerHTML = '';

                safeSetValue('imageUrls', '');
                safeSetValue('images', '');

                // é»˜è®¤åˆ‡æ¢åˆ°ä¸´æ—¶æ´»åŠ¨Tab
                switchTabWithoutEvent('temporary');

                // æ–°å¢æ´»åŠ¨æ—¶é»˜è®¤çŠ¶æ€ä¸º"è‰ç¨¿"
                safeSetValue('status', 'draft');

                if (item) {
                    const activityNumber = (item.activityNumber || item['æ´»åŠ¨ç¼–å·'] || '').replace('#', '');
                    safeSetText('modalTitle', 'ç¼–è¾‘æ´»åŠ¨');
                    safeSetValue('activityNumber', activityNumber || '-');
                    safeSetValue('itemId', item.id || item._id);
                    safeSetValue('title', item.title || '');
                    safeSetValue('category', item.category || 'å…¶ä»–');
                    safeSetValue('status', item.status || 'draft');
                    safeSetValue('description', item.description || '');

                    // æ ¹æ®æ˜¯å¦æœ‰ weekdays åˆ¤æ–­æ´»åŠ¨ç±»å‹
                    if (item.weekdays && item.weekdays.length > 0) {
                        // å›ºå®šé¢‘ç‡æ´»åŠ¨
                        switchTabWithoutEvent('fixed');

                        // å°†å­—ç¬¦ä¸²æ˜ŸæœŸè½¬æ¢ä¸ºæ•°å­—
                        const weekdayMap = {
                            'å‘¨ä¸€': 1,
                            'å‘¨äºŒ': 2,
                            'å‘¨ä¸‰': 3,
                            'å‘¨å››': 4,
                            'å‘¨äº”': 5,
                            'å‘¨å…­': 6,
                            'å‘¨æ—¥': 0,
                            '1': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '0': 0
                        };

                        // å°†æ•°æ®ä¸­çš„æ˜ŸæœŸå­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—æ•°ç»„
                        const weekdayNumbers = item.weekdays.map(w => w in weekdayMap ? weekdayMap[w] : parseInt(w));

                        // è®¾ç½®é€‰ä¸­çš„æ˜ŸæœŸ
                        document.querySelectorAll('.weekday-checkbox').forEach(checkbox => {
                            const checkboxValue = parseInt(checkbox.value);
                            checkbox.checked = weekdayNumbers.includes(checkboxValue);
                        });
                        safeSetValue('fixedTime', item.time || '');
                        safeSetValue('duration', item.duration || '');
                    } else {
                        // ä¸´æ—¶æ´»åŠ¨
                        switchTabWithoutEvent('temporary');
                        safeSetValue('date', item.date || '');
                        safeSetValue('time', item.time || '');
                        safeSetValue('tempDuration', item.duration || '');
                    }

                    safeSetValue('location', item.location || '');
                    safeSetValue('address', item.address || '');
                    safeSetValue('price', item.price || '');
                    safeSetValue('priceMin', item.priceMin || '');
                    safeSetValue('priceMax', item.priceMax || '');
                    safeSetValue('maxParticipants', item.maxParticipants || '');
                    // ä¿®å¤ï¼šæ­£ç¡®å¤„ç†å­—ç¬¦ä¸²"æ˜¯"/"å¦"
                    safeChecked('flexibleTime', item.flexibleTime === 'æ˜¯' || item.flexibleTime === true);
                    // requireBooking å¯èƒ½æ˜¯å¸ƒå°”å€¼æˆ–å­—ç¬¦ä¸²
                    const requireBooking = item.requireBooking;
                    safeChecked('requireBooking',
                        requireBooking === true ||
                        requireBooking === 'æ˜¯' ||
                        requireBooking === undefined
                    );

                    // å¤„ç†å›¾ç‰‡
                    const images = item.images || [];
                    const imagesValue = images.join('\n');
                    safeSetValue('images', imagesValue);
                    safeSetValue('imageUrls', imagesValue);

                    // æ¸…ç©ºé¢„è§ˆå¹¶é‡æ–°åŠ è½½
                    uploadedImages = [];
                    if (imagePreviews) imagePreviews.innerHTML = '';

                    // æ˜¾ç¤ºå·²æœ‰å›¾ç‰‡é¢„è§ˆ
                    images.forEach((imageUrl, index) => {
                        uploadedImages.push(imageUrl);
                        displayImagePreview(imageUrl, index);
                    });

                    safeSetValue('sourceUrl', item.source?.url || '');
                }

                document.getElementById('formModal').classList.add('active');
            } catch (error) {
                console.error('æ‰“å¼€è¡¨å•å¤±è´¥:', error);
                alert('æ‰“å¼€è¡¨å•å¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢ Tabï¼ˆä¸è§¦å‘äº‹ä»¶ï¼‰
        function switchTabWithoutEvent(tabType) {
            document.querySelectorAll('.tab-button').forEach((btn, index) => {
                btn.classList.remove('active');
                if ((tabType === 'fixed' && index === 0) || (tabType === 'temporary' && index === 1)) {
                    btn.classList.add('active');
                }
            });

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabType + 'Tab').classList.add('active');
        }

        // å…³é—­è¡¨å•å¼¹çª—
        function closeFormModal() {
            document.getElementById('formModal').classList.remove('active');
        }

        // ç¼–è¾‘é¡¹ç›®
        function editItem(id) {
            console.log('ç¼–è¾‘é¡¹ç›®ï¼ŒID:', id, 'ç±»å‹:', typeof id);
            console.log('å½“å‰ items æ•°é‡:', items.length);

            const item = items.find(i =>
                String(i.id) === String(id) ||
                String(i._id) === String(id)
            );

            console.log('æ‰¾åˆ°çš„é¡¹ç›®:', item);

            if (item) {
                openFormModal(item);
            } else {
                alert('æœªæ‰¾åˆ°è¯¥é¡¹ç›®ï¼ŒID: ' + id);
            }
        }

        // åˆ é™¤é¡¹ç›®
        async function deleteItem(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ´»åŠ¨å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/items/${id}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    alert('åˆ é™¤æˆåŠŸ');
                    await loadItems();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // è¡¨å•æäº¤
        document.getElementById('dataForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // å¦‚æœæ˜¯ä¿å­˜è‰ç¨¿ï¼Œç¡®ä¿çŠ¶æ€ä¸º draft
            if (isSavingDraft) {
                safeSetValue('status', 'draft');
            }

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // é‡ç½®è‰ç¨¿æ ‡è®°
            isSavingDraft = false;

            // åˆ¤æ–­å½“å‰æ˜¯å“ªä¸ªTab
            const isFixedTab = document.getElementById('fixedTab').classList.contains('active');

            if (isFixedTab) {
                // å›ºå®šé¢‘ç‡æ´»åŠ¨
                const selectedWeekdays = Array.from(document.querySelectorAll('.weekday-checkbox:checked'))
                    .map(cb => parseInt(cb.value));

                if (selectedWeekdays.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ˜ŸæœŸ');
                    return;
                }

                data.weekdays = selectedWeekdays;
                data.time = document.getElementById('fixedTime').value;
                data.duration = document.getElementById('duration').value;
                data.frequency = 'weekly';

                // æ¸…é™¤ä¸´æ—¶æ´»åŠ¨å­—æ®µ
                delete data.date;
            } else {
                // ä¸´æ—¶æ´»åŠ¨
                data.date = document.getElementById('date').value;
                data.time = document.getElementById('time').value;
                data.duration = document.getElementById('tempDuration').value;
                data.frequency = 'once';

                // æ¸…é™¤å›ºå®šæ´»åŠ¨å­—æ®µ
                delete data.weekdays;
            }

            // å¤„ç†å¤é€‰æ¡† - è½¬æ¢ä¸ºå­—ç¬¦ä¸²"æ˜¯"/"å¦"
            data.flexibleTime = document.getElementById('flexibleTime').checked ? 'æ˜¯' : 'å¦';
            data.requireBooking = document.getElementById('requireBooking').checked ? 'æ˜¯' : 'å¦';

            // å¤„ç†å›¾ç‰‡æ•°ç»„
            data.images = document.getElementById('images').value.split('\n').filter(url => url.trim());

            // å¤„ç†æ¥æºä¿¡æ¯
            if (data.sourceUrl) {
                data.source = {
                    name: 'æ‰‹åŠ¨æ·»åŠ ',
                    url: data.sourceUrl,
                    type: 'manual',
                    lastUpdated: new Date()
                };
            }

            // åˆ é™¤ä¸´æ—¶å­—æ®µ
            delete data.sourceUrl;
            delete data.fixedTime;
            delete data.tempDuration;

            // æ·»åŠ æœ€åæ›´æ–°æ—¶é—´
            data.updatedAt = new Date().toISOString();

            try {
                const id = document.getElementById('itemId').value;
                const url = id ? `${API_BASE}/items/${id}` : `${API_BASE}/items`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æˆåŠŸæ¶ˆæ¯
                    const statusText = data.status === 'draft' ? 'è‰ç¨¿' : 'æ´»åŠ¨';
                    const message = id ? `âœ… ${statusText}æ›´æ–°æˆåŠŸ` : `âœ… ${statusText}åˆ›å»ºæˆåŠŸ`;

                    alert(message);
                    closeFormModal();
                    await loadItems();
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥');
            }
        });

        // ç­›é€‰äº‹ä»¶
        document.getElementById('categoryFilter').addEventListener('change', renderTable);
        document.getElementById('statusFilter').addEventListener('change', renderTable);

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('formModal').addEventListener('click', (e) => {
            if (e.target.id === 'formModal') {
                closeFormModal();
            }
        });

        // å·¥å…·å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'draft': 'è‰ç¨¿',
                'pending': 'å¾…å¼€å§‹',
                'ongoing': 'è¿›è¡Œä¸­',
                'suspended': 'æš‚åœä¸­',
                'expired': 'å·²è¿‡æœŸ',
                'active': 'æ´»è·ƒ' // å…¼å®¹æ—§æ•°æ®
            };
            return statusMap[status] || status;
        }

        // ä¿å­˜ä¸ºè‰ç¨¿æ ‡è®°
        let isSavingDraft = false;

        // ä¿å­˜ä¸ºè‰ç¨¿
        function submitFormAsDraft() {
            isSavingDraft = true; // è®¾ç½®è‰ç¨¿æ ‡è®°
            safeSetValue('status', 'draft'); // è®¾ç½®çŠ¶æ€ä¸ºè‰ç¨¿
            document.getElementById('dataForm').dispatchEvent(new Event('submit')); // è§¦å‘è¡¨å•æäº¤
        }

        // ========== å›¾ç‰‡æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½ ==========
        let uploadedImages = []; // å­˜å‚¨å·²ä¸Šä¼ çš„å›¾ç‰‡URL

        // åˆå§‹åŒ–ä¸Šä¼ åŒºåŸŸäº‹ä»¶ç›‘å¬
        function initImageUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            if (!uploadArea || !fileInput) return;

            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadArea.addEventListener('click', () => fileInput.click());

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // æ‹–æ‹½äº‹ä»¶
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleFiles(files) {
            const uploadProgress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const uploadStatus = document.getElementById('uploadStatus');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // éªŒè¯æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert(`${file.name} ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶`);
                    continue;
                }

                // éªŒè¯æ–‡ä»¶å¤§å° (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert(`${file.name} è¶…è¿‡5MBé™åˆ¶`);
                    continue;
                }

                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                uploadProgress.style.display = 'block';
                uploadStatus.textContent = `æ­£åœ¨ä¸Šä¼  ${file.name}...`;
                progressFill.style.width = '0%';

                try {
                    const imageUrl = await uploadImage(file, (percent) => {
                        progressFill.style.width = percent + '%';
                    });

                    if (imageUrl) {
                        uploadedImages.push(imageUrl);
                        displayImagePreview(imageUrl, uploadedImages.length - 1);
                        updateImagesTextarea();
                    }
                } catch (error) {
                    console.error('ä¸Šä¼ å¤±è´¥:', error);
                    alert(`${file.name} ä¸Šä¼ å¤±è´¥: ${error.message}`);
                }
            }

            // éšè—ä¸Šä¼ è¿›åº¦
            setTimeout(() => {
                uploadProgress.style.display = 'none';
                progressFill.style.width = '0%';
            }, 500);

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            document.getElementById('fileInput').value = '';
        }

        // ä¸Šä¼ å•ä¸ªå›¾ç‰‡
        async function uploadImage(file, progressCallback) {
            const formData = new FormData();
            formData.append('image', file);

            try {
                // æ¨¡æ‹Ÿè¿›åº¦
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        progressCallback(progress);
                    }
                }, 100);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressCallback(100);

                const result = await response.json();

                if (result.success) {
                    return result.data.url;
                } else {
                    throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                throw error;
            }
        }

        // ç›‘å¬æ‰‹åŠ¨è¾“å…¥çš„URLå˜åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initImageUpload();

            const textarea = document.getElementById('imageUrls');
            if (textarea) {
                textarea.addEventListener('input', updateImagesTextarea);
            }
        });

        // ========== Excelå¯¼å…¥å¯¼å‡ºåŠŸèƒ½ ==========

        // ä»Excelå¯¼å…¥æ•°æ®
        async function importFromExcel() {
            if (!confirm('ç¡®å®šè¦ä»Excelå¯¼å…¥æ•°æ®å—ï¼Ÿ\n\nè¿™å°†è¦†ç›–åå°æ•°æ®ï¼Œå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚')) {
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'â³ å¯¼å…¥ä¸­...';

            try {
                const response = await fetch('/api/import-excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert(`âœ… å¯¼å…¥æˆåŠŸï¼\n\n${result.message}\n\nè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æœ€æ–°æ•°æ®ã€‚`);
                    loadItems(); // é‡æ–°åŠ è½½æ•°æ®
                } else {
                    alert(`âŒ å¯¼å…¥å¤±è´¥\n\n${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('å¯¼å…¥é”™è¯¯:', error);
                alert('âŒ å¯¼å…¥å¤±è´¥\n\n' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // å¯¼å‡ºæ•°æ®åˆ°Excel
        async function exportToExcel() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'â³ å¯¼å‡ºä¸­...';

            try {
                const response = await fetch('/api/export-excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // ä¸‹è½½æ–‡ä»¶
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `æ¸…è¿ˆæ´»åŠ¨æ•°æ®-å¯¼å‡º-${new Date().toISOString().slice(0, 10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    alert('âœ… å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶å·²è‡ªåŠ¨ä¸‹è½½ã€‚');
                } else {
                    const result = await response.json();
                    alert(`âŒ å¯¼å‡ºå¤±è´¥\n\n${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('å¯¼å‡ºé”™è¯¯:', error);
                alert('âŒ å¯¼å‡ºå¤±è´¥\n\n' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ==================== æ”»ç•¥ç®¡ç†ç›¸å…³å‡½æ•° ====================

        /**
         * æ‰“å¼€æ”»ç•¥ç®¡ç†å¼¹çª—
         */
        async function openGuideModal() {
            const modal = document.getElementById('guideModal');
            modal.style.display = 'flex';

            // å…ˆæ¸…ç©ºç¼–è¾‘å™¨
            const editor = document.getElementById('guideEditor');
            editor.innerHTML = '';

            // åŠ è½½ç°æœ‰æ”»ç•¥å†…å®¹
            try {
                const response = await fetch(`${API_BASE}/guide`);
                const result = await response.json();

                if (result.success && result.data) {
                    // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å·²æ›´æ–°
                    setTimeout(() => {
                        let content = result.data.content || '';

                        // æ¸…é™¤æ‰€æœ‰å¯èƒ½å¹²æ‰°æ˜¾ç¤ºçš„å†…è”æ ·å¼
                        content = cleanInlineStyles(content);

                        editor.innerHTML = content;
                        console.log('âœ… æ”»ç•¥å†…å®¹å·²åŠ è½½ï¼Œé•¿åº¦:', content.length);

                        // ç¡®ä¿è¡¨æ ¼æœ‰æ­£ç¡®çš„è¾¹æ¡†å’Œæ ·å¼
                        setTimeout(() => {
                            ensureTableStyles(editor);
                            cleanElementStyles(editor);
                        }, 50);
                    }, 50);
                } else {
                    editor.innerHTML = '<p style="color:#999;text-align:center;padding:40px;">æš‚æ— æ”»ç•¥å†…å®¹ï¼Œè¯·ç²˜è´´æˆ–è¾“å…¥å†…å®¹</p>';
                }
            } catch (error) {
                console.error('åŠ è½½æ”»ç•¥å¤±è´¥:', error);
                alert('âŒ åŠ è½½æ”»ç•¥å†…å®¹å¤±è´¥\n\n' + error.message);
            }
        }

        /**
         * æ¸…é™¤å¹²æ‰°æ˜¾ç¤ºçš„å†…è”æ ·å¼
         */
        function cleanInlineStyles(html) {
            // ç§»é™¤æˆ–æ¸…ç†styleå±æ€§ä¸­çš„å­—ä½“ç›¸å…³æ ·å¼
            html = html.replace(/style="([^"]*)"/gi, (match, styleContent) => {
                // ç§»é™¤font-size, font-family, colorç­‰æ ·å¼
                let cleaned = styleContent
                    .replace(/font-size:\s*[^;]+;?/gi, '')
                    .replace(/font-family:\s*[^;]+;?/gi, '')
                    .replace(/color:\s*[^;]+;?/gi, '')
                    .replace(/line-height:\s*[^;]+;?/gi, '')
                    .replace(/background-color:\s*[^;]+;?/gi, '')
                    .replace(/;\s*;/g, ';') // ç§»é™¤é‡å¤çš„åˆ†å·
                    .replace(/^;\s*/g, '') // ç§»é™¤å¼€å¤´çš„åˆ†å·
                    .replace(/;\s*$/g, ''); // ç§»é™¤ç»“å°¾çš„åˆ†å·

                // å¦‚æœæ¸…ç†åä¸ºç©ºï¼Œç§»é™¤æ•´ä¸ªstyleå±æ€§
                return cleaned.trim() ? `style="${cleaned}"` : '';
            });

            // ç§»é™¤ç©ºçš„styleå±æ€§
            html = html.replace(/\s+style=""/gi, '');

            return html;
        }

        /**
         * æ¸…ç†DOMå…ƒç´ çš„å†…è”æ ·å¼
         */
        function cleanElementStyles(editor) {
            const allElements = editor.querySelectorAll('*');
            allElements.forEach(el => {
                // ç§»é™¤å­—ä½“ç›¸å…³çš„å†…è”æ ·å¼
                el.style.removeProperty('font-size');
                el.style.removeProperty('font-family');
                el.style.removeProperty('color');
                el.style.removeProperty('line-height');
                el.style.removeProperty('background-color');
            });
        }

        /**
         * ç¡®ä¿è¡¨æ ¼æœ‰æ­£ç¡®çš„æ ·å¼
         */
        function ensureTableStyles(editor) {
            const tables = editor.querySelectorAll('table');
            tables.forEach(table => {
                // ç¡®ä¿è¡¨æ ¼æœ‰è¾¹æ¡†
                if (!table.style.border) {
                    table.style.border = '2px solid #ddd';
                }

                const cells = table.querySelectorAll('th, td');
                cells.forEach(cell => {
                    if (!cell.style.border) {
                        cell.style.border = '1px solid #ddd';
                    }
                    if (!cell.style.padding) {
                        cell.style.padding = '8px 12px';
                    }
                    if (!cell.style.verticalAlign) {
                        cell.style.verticalAlign = 'top';
                    }
                });

                // ç¡®ä¿è¡¨å¤´æœ‰èƒŒæ™¯è‰²
                const headers = table.querySelectorAll('th');
                headers.forEach(th => {
                    if (!th.style.backgroundColor) {
                        th.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        th.style.color = 'white';
                    }
                });
            });
        }

        /**
         * å…³é—­æ”»ç•¥ç®¡ç†å¼¹çª—
         */
        function closeGuideModal() {
            document.getElementById('guideModal').style.display = 'none';
        }

        /**
         * ä¿å­˜æ”»ç•¥å†…å®¹
         */
        async function saveGuideContent() {
            const editor = document.getElementById('guideEditor');
            let content = editor.innerHTML;

            if (!content.trim() || content === '<br>') {
                alert('âš ï¸ å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }

            // æ¸…ç†å†…è”æ ·å¼åå†ä¿å­˜
            content = cleanInlineStyles(content);

            // ç¡®ä¿è¡¨æ ¼æœ‰å¿…è¦çš„æ ·å¼å±æ€§ï¼ˆä¸ä¾èµ–å¤–éƒ¨CSSï¼‰
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            ensureTableStyles(tempDiv);
            content = tempDiv.innerHTML;

            console.log('ğŸ’¾ å‡†å¤‡ä¿å­˜æ”»ç•¥ï¼Œé•¿åº¦:', content.length);
            console.log('åŒ…å«è¡¨æƒ…ç¬¦å·:', /[\u{1F300}-\u{1F9FF}]/u.test(content));

            try {
                const response = await fetch(`${API_BASE}/guide`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: JSON.stringify({ content })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('âœ… æ”»ç•¥ä¿å­˜æˆåŠŸ');
                    alert('âœ… ä¿å­˜æˆåŠŸï¼\n\næ”»ç•¥ä¿¡æ¯å·²æ›´æ–°ï¼Œå‰ç«¯é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°æ˜¾ç¤ºã€‚');
                    closeGuideModal();

                    // è§¦å‘å‰ç«¯æ•°æ®ç‰ˆæœ¬æ›´æ–°ï¼ˆå¯é€‰ï¼‰
                    setTimeout(() => {
                        console.log('ğŸ’¡ æç¤ºï¼šå¦‚æœå‰ç«¯æœªè‡ªåŠ¨æ›´æ–°ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æœ€æ–°å†…å®¹');
                    }, 1000);
                } else {
                    console.error('âŒ ä¿å­˜å¤±è´¥:', result.message);
                    alert('âŒ ä¿å­˜å¤±è´¥\n\n' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜æ”»ç•¥å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥\n\n' + error.message);
            }
        }

        /**
         * å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ ¼å¼åŒ–å‡½æ•°
         */
        function formatDoc(cmd, value = null) {
            document.execCommand(cmd, false, value);
            document.getElementById('guideEditor').focus();
        }

        /**
         * ä¸€é”®æ¸…ç†ç¼–è¾‘å™¨å†…å®¹æ ¼å¼
         */
        function cleanEditorContent() {
            const editor = document.getElementById('guideEditor');
            let content = editor.innerHTML;

            console.log('ğŸ§¹ æ¸…ç†å‰çš„å†…å®¹é•¿åº¦:', content.length);

            // æ¸…ç†å†…è”æ ·å¼
            content = cleanInlineStyles(content);

            // é‡æ–°è®¾ç½®å†…å®¹
            editor.innerHTML = content;

            // æ¸…ç†DOMå…ƒç´ çš„å†…è”æ ·å¼
            cleanElementStyles(editor);

            // ç¡®ä¿è¡¨æ ¼æ ·å¼
            ensureTableStyles(editor);

            console.log('âœ… æ¸…ç†åçš„å†…å®¹é•¿åº¦:', content.length);
            console.log('ğŸ“Š æ¸…ç†æ‰äº†', (editor.innerHTML.length - content.length), 'ä¸ªå­—ç¬¦');

            // æç¤ºç”¨æˆ·
            alert('âœ… æ ¼å¼å·²æ¸…ç†ï¼\n\nå·²ç§»é™¤å¤šä½™çš„å†…è”æ ·å¼ï¼Œè¡¨æ ¼è¾¹æ¡†å·²ä¼˜åŒ–ã€‚\nè¯·æ£€æŸ¥å†…å®¹æ˜¯å¦æ­£å¸¸ï¼Œç„¶åç‚¹å‡»ä¿å­˜ã€‚');
        }
    </script>
</body>
</html>
