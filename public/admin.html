<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨ç®¡ç†åå° - Chiengmai</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #66bb6a;
            color: white;
        }

        .btn-danger {
            background: #ef5350;
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            overflow-x: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        tbody tr:hover {
            background-color: #f5f5f5;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: 700;
            padding: 20px 30px 10px 30px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-footer {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 20px 30px;
            border-top: 1px solid #e0e0e0;
            background: white;
            border-radius: 0 0 20px 20px;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        /* åˆ†ç±»æ ‡ç­¾é¢œè‰² */
        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-ç‘œä¼½ { background: #FF6B6B; color: white; }
        .badge-å†¥æƒ³ { background: #4ECDC4; color: white; }
        .badge-æˆ·å¤–æ¢é™© { background: #FFE66D; color: #333; }
        .badge-æ–‡åŒ–è‰ºæœ¯ { background: #95E1D3; color: #333; }
        .badge-ç¾é£Ÿä½“éªŒ { background: #F38181; color: white; }
        .badge-èŠ‚åº†æ´»åŠ¨ { background: #AA96DA; color: white; }
        .badge-å…¶ä»– { background: #667eea; color: white; }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending { background: #FFA726; color: white; }
        .status-ongoing { background: #66BB6A; color: white; }
        .status-expired { background: #EF5350; color: white; }
        .status-draft { background: #9E9E9E; color: white; }

        /* è‰ç¨¿æŒ‰é’®æ ·å¼ */
        .btn-draft {
            background: #9E9E9E;
            color: white;
            margin-right: 10px;
        }

        .btn-draft:hover {
            background: #757575;
        }

        /* æ‹–æ‹½ä¸Šä¼ æ ·å¼ */
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8eaf6;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 12px;
        }

        .image-previews {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .image-preview {
            position: relative;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }

        .image-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .image-preview .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ef5350;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-preview:hover .delete-btn {
            opacity: 1;
        }

        .image-preview .image-order {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-progress {
            display: none;
            margin-top: 10px;
        }

        .upload-progress.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .upload-progress.active .progress-fill {
            width: 100%;
        }

        /* Tab åˆ‡æ¢æ ·å¼ */
        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button:hover {
            color: #667eea;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .weekday-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .weekday-checkbox {
            display: none;
        }

        .weekday-label {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .weekday-checkbox:checked + .weekday-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸï¸ æ´»åŠ¨ç®¡ç†åå°</h1>
        <p style="color: #666; margin-bottom: 20px;">æ¸…è¿ˆæ´»åŠ¨æŸ¥è¯¢å¹³å° - æ•°æ®ç®¡ç†</p>

        <div class="toolbar">
            <div style="display: flex; gap: 15px; align-items: center;">
                <select id="categoryFilter" class="btn btn-secondary">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option value="ç‘œä¼½">ç‘œä¼½</option>
                    <option value="å†¥æƒ³">å†¥æƒ³</option>
                    <option value="æˆ·å¤–æ¢é™©">æˆ·å¤–æ¢é™©</option>
                    <option value="æ–‡åŒ–è‰ºæœ¯">æ–‡åŒ–è‰ºæœ¯</option>
                    <option value="ç¾é£Ÿä½“éªŒ">ç¾é£Ÿä½“éªŒ</option>
                    <option value="èŠ‚åº†æ´»åŠ¨">èŠ‚åº†æ´»åŠ¨</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <select id="statusFilter" class="btn btn-secondary">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="draft">è‰ç¨¿</option>
                    <option value="pending">å¾…å¼€å§‹</option>
                    <option value="ongoing">è¿›è¡Œä¸­</option>
                    <option value="expired">å·²è¿‡æœŸ</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="openFormModal()">
                â• æ–°å¢æ´»åŠ¨
            </button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th>æ ‡é¢˜</th>
                        <th style="width: 100px;">åˆ†ç±»</th>
                        <th style="width: 120px;">æ—¥æœŸ</th>
                        <th style="width: 100px;">æ—¶é—´</th>
                        <th style="width: 100px;">åœ°ç‚¹</th>
                        <th style="width: 100px;">ä»·æ ¼</th>
                        <th style="width: 80px;">çŠ¶æ€</th>
                        <th style="width: 150px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                            åŠ è½½ä¸­...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ç¼–è¾‘å¼¹çª— -->
    <div class="modal" id="formModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">æ–°å¢æ´»åŠ¨</div>
            <div class="modal-body">
                <form id="dataForm">
                    <input type="hidden" id="itemId">

                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <h3 style="margin: 20px 0 15px 0; color: #667eea;">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
                <div class="form-group">
                    <label for="title">æ´»åŠ¨æ ‡é¢˜ *</label>
                    <input type="text" id="title" name="title" placeholder="è¯·è¾“å…¥æ´»åŠ¨æ ‡é¢˜" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="category">åˆ†ç±» *</label>
                        <select id="category" name="category" required>
                            <option value="ç‘œä¼½">ç‘œä¼½</option>
                            <option value="å†¥æƒ³">å†¥æƒ³</option>
                            <option value="æˆ·å¤–æ¢é™©">æˆ·å¤–æ¢é™©</option>
                            <option value="æ–‡åŒ–è‰ºæœ¯">æ–‡åŒ–è‰ºæœ¯</option>
                            <option value="ç¾é£Ÿä½“éªŒ">ç¾é£Ÿä½“éªŒ</option>
                            <option value="èŠ‚åº†æ´»åŠ¨">èŠ‚åº†æ´»åŠ¨</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">çŠ¶æ€</label>
                        <select id="status" name="status">
                            <option value="draft">è‰ç¨¿</option>
                            <option value="pending">å¾…å¼€å§‹</option>
                            <option value="ongoing">è¿›è¡Œä¸­</option>
                            <option value="expired">å·²è¿‡æœŸ</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">æ´»åŠ¨æè¿° *</label>
                    <textarea id="description" name="description" rows="3" placeholder="è¯·è¾“å…¥æ´»åŠ¨æè¿°" required></textarea>
                </div>

                <!-- æ—¶é—´ä¿¡æ¯ -->
                <h3 style="margin: 20px 0 15px 0; color: #667eea;">â° æ—¶é—´ä¿¡æ¯</h3>

                <!-- Tab åˆ‡æ¢ -->
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button type="button" class="tab-button active" onclick="switchTab('fixed')">ğŸ“… å›ºå®šé¢‘ç‡æ´»åŠ¨</button>
                        <button type="button" class="tab-button" onclick="switchTab('temporary')">ğŸ“ ä¸´æ—¶æ´»åŠ¨</button>
                    </div>

                    <!-- å›ºå®šé¢‘ç‡æ´»åŠ¨ -->
                    <div id="fixedTab" class="tab-content active">
                        <div class="form-group">
                            <label>é€‰æ‹©æ˜ŸæœŸï¼ˆå¯å¤šé€‰ï¼‰</label>
                            <div class="weekday-selector">
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="1">
                                    <span class="weekday-label">å‘¨ä¸€</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="2">
                                    <span class="weekday-label">å‘¨äºŒ</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="3">
                                    <span class="weekday-label">å‘¨ä¸‰</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="4">
                                    <span class="weekday-label">å‘¨å››</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="5">
                                    <span class="weekday-label">å‘¨äº”</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="6">
                                    <span class="weekday-label">å‘¨å…­</span>
                                </label>
                                <label>
                                    <input type="checkbox" class="weekday-checkbox" name="weekdays" value="0">
                                    <span class="weekday-label">å‘¨æ—¥</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fixedTime">æ—¶é—´</label>
                                <input type="text" id="fixedTime" name="fixedTime" placeholder="ä¾‹å¦‚ï¼š09:00-10:30">
                            </div>
                            <div class="form-group">
                                <label for="duration">æŒç»­æ—¶é—´</label>
                                <input type="text" id="duration" name="duration" placeholder="ä¾‹å¦‚ï¼š1.5å°æ—¶">
                            </div>
                        </div>

                        <div class="form-group">
                            <label style="color: #666; font-size: 12px;">
                                ğŸ’¡ å›ºå®šé¢‘ç‡æ´»åŠ¨ï¼šæ¯å‘¨åœ¨é€‰æ‹©çš„æ˜ŸæœŸå‡ é‡å¤è¿›è¡Œ
                            </label>
                        </div>
                    </div>

                    <!-- ä¸´æ—¶æ´»åŠ¨ -->
                    <div id="temporaryTab" class="tab-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="date">å…·ä½“æ—¥æœŸ</label>
                                <input type="date" id="date" name="date">
                            </div>
                            <div class="form-group">
                                <label for="time">æ—¶é—´</label>
                                <input type="text" id="time" name="time" placeholder="ä¾‹å¦‚ï¼š09:00-10:30">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="tempDuration">æŒç»­æ—¶é—´</label>
                            <input type="text" id="tempDuration" name="tempDuration" placeholder="ä¾‹å¦‚ï¼š1.5å°æ—¶">
                        </div>

                        <div class="form-group">
                            <label style="color: #666; font-size: 12px;">
                                ğŸ’¡ ä¸´æ—¶æ´»åŠ¨ï¼šä»…åœ¨æŒ‡å®šçš„å…·ä½“æ—¥æœŸè¿›è¡Œä¸€æ¬¡
                            </label>
                        </div>
                    </div>
                </div>

                <!-- åœ°ç‚¹ä¿¡æ¯ -->
                <h3 style="margin: 20px 0 15px 0; color: #667eea;">ğŸ“ åœ°ç‚¹ä¿¡æ¯</h3>
                <div class="form-group">
                    <label for="location">åœ°ç‚¹åç§° *</label>
                    <input type="text" id="location" name="location" placeholder="ä¾‹å¦‚ï¼šå®æ›¼ä¸€å·ç‘œä¼½é¦†" required>
                </div>

                <div class="form-group">
                    <label for="address">è¯¦ç»†åœ°å€</label>
                    <input type="text" id="address" name="address" placeholder="è¯¦ç»†åœ°å€">
                </div>


                <!-- ä»·æ ¼ä¿¡æ¯ -->
                <h3 style="margin: 20px 0 15px 0; color: #667eea;">ğŸ’° ä»·æ ¼ä¿¡æ¯</h3>
                <div class="form-group">
                    <label for="price">ä»·æ ¼æ˜¾ç¤º</label>
                    <input type="text" id="price" name="price" placeholder="ä¾‹å¦‚ï¼šå…è´¹ã€500à¸¿">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="priceMin">æœ€ä½ä»·æ ¼</label>
                        <input type="number" id="priceMin" name="priceMin" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="priceMax">æœ€é«˜ä»·æ ¼</label>
                        <input type="number" id="priceMax" name="priceMax" placeholder="0">
                    </div>
                </div>

                <!-- å‚ä¸äººæ•° -->
                <h3 style="margin: 20px 0 15px 0; color: #667eea;">ğŸ‘¥ å‚ä¸ä¿¡æ¯</h3>
                <div class="form-group">
                    <label for="maxParticipants">æœ€å¤§äººæ•°</label>
                    <input type="number" id="maxParticipants" name="maxParticipants" placeholder="0è¡¨ç¤ºä¸é™">
                </div>

                <!-- å…¶ä»–é€‰é¡¹ -->
                <h3 style="margin: 20px 0 15px 0; color: #667eea;">âš™ï¸ å…¶ä»–é€‰é¡¹</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="flexibleTime" name="flexibleTime">
                            çµæ´»æ—¶é—´æ´»åŠ¨
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="bookingRequired" name="bookingRequired" checked>
                            éœ€è¦é¢„çº¦
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ´»åŠ¨å›¾ç‰‡</label>

                    <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">ğŸ“¸</div>
                        <div class="upload-text">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»ä¸Šä¼ </div>
                        <div class="upload-hint">æ”¯æŒ JPGã€PNGã€GIFã€WEBP æ ¼å¼ï¼Œæœ€å¤§5MB</div>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;" multiple>
                    </div>

                    <!-- ä¸Šä¼ è¿›åº¦ -->
                    <div class="upload-progress" id="uploadProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="upload-hint" id="uploadStatus">ä¸Šä¼ ä¸­...</div>
                    </div>

                    <!-- å›¾ç‰‡é¢„è§ˆ -->
                    <div class="image-previews" id="imagePreviews"></div>

                    <!-- ä¹Ÿå¯ä»¥æ‰‹åŠ¨è¾“å…¥URL -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <label style="font-size: 12px; color: #666; margin-bottom: 8px;">æˆ–æ‰‹åŠ¨è¾“å…¥å›¾ç‰‡URLï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</label>
                        <textarea id="imageUrls" rows="2" placeholder="https://example.com/image1.jpg" style="font-size: 12px;"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label for="sourceUrl">æ¥æºé“¾æ¥</label>
                    <input type="url" id="sourceUrl" name="sourceUrl" placeholder="https://...">
                </div>
            </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeFormModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-draft" onclick="submitFormAsDraft()">ğŸ“ è‰ç¨¿</button>
                <button type="submit" class="btn btn-success" form="dataForm">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        let items = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadItems();
        });

        // åŠ è½½æ•°æ®
        async function loadItems() {
            try {
                const response = await fetch(`${API_BASE}/items`);
                const result = await response.json();
                items = result.data || [];
                renderTable();
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filteredItems = items;

            if (categoryFilter) {
                filteredItems = filteredItems.filter(item => item.category === categoryFilter);
            }

            if (statusFilter) {
                filteredItems = filteredItems.filter(item => item.status === statusFilter);
            }

            if (filteredItems.length === 0) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #999;">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            document.getElementById('tableBody').innerHTML = filteredItems.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${escapeHtml(item.title)}</strong></td>
                    <td><span class="category-badge badge-${item.category}">${item.category}</span></td>
                    <td>${item.date || '-'}</td>
                    <td>${item.time || '-'}</td>
                    <td>${escapeHtml(item.location || '-').substring(0, 15)}</td>
                    <td>${item.price || '-'}</td>
                    <td><span class="status-badge status-${item.status}">${getStatusText(item.status)}</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="editItem('${item.id}')" style="padding: 6px 12px; font-size: 12px;">ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deleteItem('${item.id}')" style="padding: 6px 12px; font-size: 12px;">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        // åˆ‡æ¢ Tab
        function switchTab(tabType) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // åˆ‡æ¢å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabType + 'Tab').classList.add('active');
        }

        // ========== å›¾ç‰‡ç›¸å…³å‡½æ•°ï¼ˆéœ€è¦æå‰å®šä¹‰ï¼‰==========

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
        function displayImagePreview(imageUrl, index) {
            const previewsContainer = document.getElementById('imagePreviews');

            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-preview';
            previewDiv.dataset.index = index;
            previewDiv.dataset.url = imageUrl;

            previewDiv.innerHTML = `
                <img src="${imageUrl}" alt="é¢„è§ˆå›¾ç‰‡" loading="lazy">
                <div class="image-overlay">
                    <button class="delete-image-btn" onclick="deleteImage(${index})" title="åˆ é™¤å›¾ç‰‡">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="image-order">${index + 1}</div>
            `;

            previewsContainer.appendChild(previewDiv);
        }

        // åˆ é™¤å›¾ç‰‡
        async function deleteImage(index) {
            const previewDiv = document.querySelector(`.image-preview[data-index="${index}"]`);
            if (!previewDiv) return;

            const imageUrl = previewDiv.dataset.url;

            // å¦‚æœæ˜¯ä¸Šä¼ çš„å›¾ç‰‡ï¼Œä»æœåŠ¡å™¨åˆ é™¤
            if (imageUrl.startsWith('/uploads/')) {
                const filename = imageUrl.split('/').pop();
                try {
                    await fetch(`/api/upload/${filename}`, { method: 'DELETE' });
                } catch (error) {
                    console.error('åˆ é™¤æœåŠ¡å™¨æ–‡ä»¶å¤±è´¥:', error);
                }
            }

            // ä»æ•°ç»„ä¸­ç§»é™¤
            uploadedImages = uploadedImages.filter((url, i) => i !== index);

            // ç§»é™¤é¢„è§ˆå…ƒç´ 
            previewDiv.remove();

            // æ›´æ–°ç´¢å¼•
            updateImageIndexes();

            // æ›´æ–°textarea
            updateImagesTextarea();
        }

        // æ›´æ–°å›¾ç‰‡ç´¢å¼•
        function updateImageIndexes() {
            const previews = document.querySelectorAll('.image-preview');
            previews.forEach((preview, newIndex) => {
                preview.dataset.index = newIndex;
                const orderBadge = preview.querySelector('.image-order');
                if (orderBadge) {
                    orderBadge.textContent = newIndex + 1;
                }
                const deleteBtn = preview.querySelector('.delete-image-btn');
                if (deleteBtn) {
                    deleteBtn.onclick = () => deleteImage(newIndex);
                }
            });
        }

        // æ›´æ–°å›¾ç‰‡URLçš„textarea
        function updateImagesTextarea() {
            const textarea = document.getElementById('imageUrls');
            const imagesTextarea = document.getElementById('images');

            if (!textarea) return;

            // è·å–æ‰‹åŠ¨è¾“å…¥çš„URL
            const manualUrls = textarea.value.split('\n').filter(url => url.trim());

            // åˆå¹¶ä¸Šä¼ çš„URLå’Œæ‰‹åŠ¨è¾“å…¥çš„URL
            const allUrls = [...uploadedImages, ...manualUrls];

            // æ›´æ–°éšè—çš„imageså­—æ®µ
            if (imagesTextarea) {
                imagesTextarea.value = allUrls.join('\n');
            }
        }

        // ========== è¡¨å•æ“ä½œå‡½æ•° ==========

        // æ‰“å¼€è¡¨å•å¼¹çª—
        function openFormModal(item = null) {
            try {
                const form = document.getElementById('dataForm');
                if (!form) {
                    alert('é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¡¨å•');
                    return;
                }

                form.reset();
                document.getElementById('itemId').value = '';
                document.getElementById('modalTitle').textContent = 'æ–°å¢æ´»åŠ¨';

                // æ¸…ç©ºä¸Šä¼ çš„å›¾ç‰‡åˆ—è¡¨
                uploadedImages = [];
                const imagePreviews = document.getElementById('imagePreviews');
                if (imagePreviews) imagePreviews.innerHTML = '';

                const imageUrls = document.getElementById('imageUrls');
                if (imageUrls) imageUrls.value = '';

                const images = document.getElementById('images');
                if (images) images.value = '';

                // é»˜è®¤åˆ‡æ¢åˆ°ä¸´æ—¶æ´»åŠ¨Tab
                switchTabWithoutEvent('temporary');

                // æ–°å¢æ´»åŠ¨æ—¶é»˜è®¤çŠ¶æ€ä¸º"è‰ç¨¿"
                const statusSelect = document.getElementById('status');
                if (statusSelect) statusSelect.value = 'draft';

                if (item) {
                    document.getElementById('modalTitle').textContent = 'ç¼–è¾‘æ´»åŠ¨';
                    document.getElementById('itemId').value = item.id || item._id;
                    document.getElementById('title').value = item.title || '';
                    document.getElementById('category').value = item.category || 'å…¶ä»–';
                    document.getElementById('status').value = item.status || 'draft';
                    document.getElementById('description').value = item.description || '';

                    // æ ¹æ®æ˜¯å¦æœ‰ weekdays åˆ¤æ–­æ´»åŠ¨ç±»å‹
                    if (item.weekdays && item.weekdays.length > 0) {
                        // å›ºå®šé¢‘ç‡æ´»åŠ¨
                        switchTabWithoutEvent('fixed');
                        // è®¾ç½®é€‰ä¸­çš„æ˜ŸæœŸ
                        document.querySelectorAll('.weekday-checkbox').forEach(checkbox => {
                            checkbox.checked = item.weekdays.includes(parseInt(checkbox.value));
                        });
                        document.getElementById('fixedTime').value = item.time || '';
                        document.getElementById('duration').value = item.duration || '';
                    } else {
                        // ä¸´æ—¶æ´»åŠ¨
                        switchTabWithoutEvent('temporary');
                        document.getElementById('date').value = item.date || '';
                        document.getElementById('time').value = item.time || '';
                        document.getElementById('tempDuration').value = item.duration || '';
                    }

                    document.getElementById('location').value = item.location || '';
                    document.getElementById('address').value = item.address || '';
                    document.getElementById('price').value = item.price || '';
                    document.getElementById('priceMin').value = item.priceMin || '';
                    document.getElementById('priceMax').value = item.priceMax || '';
                    document.getElementById('maxParticipants').value = item.maxParticipants || '';
                    document.getElementById('flexibleTime').checked = item.flexibleTime || false;
                    document.getElementById('bookingRequired').checked = item.bookingRequired !== undefined ? item.bookingRequired : true;

                    // å¤„ç†å›¾ç‰‡
                    const images = item.images || [];
                    document.getElementById('images').value = images.join('\n');
                    document.getElementById('imageUrls').value = images.join('\n');

                    // æ¸…ç©ºé¢„è§ˆå¹¶é‡æ–°åŠ è½½
                    uploadedImages = [];
                    if (imagePreviews) imagePreviews.innerHTML = '';

                    // æ˜¾ç¤ºå·²æœ‰å›¾ç‰‡é¢„è§ˆ
                    images.forEach((imageUrl, index) => {
                        uploadedImages.push(imageUrl);
                        displayImagePreview(imageUrl, index);
                    });

                    document.getElementById('sourceUrl').value = item.source?.url || '';
                }

                document.getElementById('formModal').classList.add('active');
            } catch (error) {
                console.error('æ‰“å¼€è¡¨å•å¤±è´¥:', error);
                alert('æ‰“å¼€è¡¨å•å¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢ Tabï¼ˆä¸è§¦å‘äº‹ä»¶ï¼‰
        function switchTabWithoutEvent(tabType) {
            document.querySelectorAll('.tab-button').forEach((btn, index) => {
                btn.classList.remove('active');
                if ((tabType === 'fixed' && index === 0) || (tabType === 'temporary' && index === 1)) {
                    btn.classList.add('active');
                }
            });

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabType + 'Tab').classList.add('active');
        }

        // å…³é—­è¡¨å•å¼¹çª—
        function closeFormModal() {
            document.getElementById('formModal').classList.remove('active');
        }

        // ç¼–è¾‘é¡¹ç›®
        function editItem(id) {
            const item = items.find(i => (i.id === id || i._id === id));
            if (item) {
                openFormModal(item);
            }
        }

        // åˆ é™¤é¡¹ç›®
        async function deleteItem(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ´»åŠ¨å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/items/${id}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    alert('åˆ é™¤æˆåŠŸ');
                    await loadItems();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // è¡¨å•æäº¤
        document.getElementById('dataForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // å¦‚æœæ˜¯ä¿å­˜è‰ç¨¿ï¼Œç¡®ä¿çŠ¶æ€ä¸º draft
            if (isSavingDraft) {
                document.getElementById('status').value = 'draft';
            }

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            // é‡ç½®è‰ç¨¿æ ‡è®°
            isSavingDraft = false;

            // åˆ¤æ–­å½“å‰æ˜¯å“ªä¸ªTab
            const isFixedTab = document.getElementById('fixedTab').classList.contains('active');

            if (isFixedTab) {
                // å›ºå®šé¢‘ç‡æ´»åŠ¨
                const selectedWeekdays = Array.from(document.querySelectorAll('.weekday-checkbox:checked'))
                    .map(cb => parseInt(cb.value));

                if (selectedWeekdays.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ˜ŸæœŸ');
                    return;
                }

                data.weekdays = selectedWeekdays;
                data.time = document.getElementById('fixedTime').value;
                data.duration = document.getElementById('duration').value;
                data.frequency = 'weekly';

                // æ¸…é™¤ä¸´æ—¶æ´»åŠ¨å­—æ®µ
                delete data.date;
            } else {
                // ä¸´æ—¶æ´»åŠ¨
                data.date = document.getElementById('date').value;
                data.time = document.getElementById('time').value;
                data.duration = document.getElementById('tempDuration').value;
                data.frequency = 'once';

                // æ¸…é™¤å›ºå®šæ´»åŠ¨å­—æ®µ
                delete data.weekdays;
            }

            // å¤„ç†å¤é€‰æ¡†
            data.flexibleTime = document.getElementById('flexibleTime').checked;
            data.bookingRequired = document.getElementById('bookingRequired').checked;

            // å¤„ç†å›¾ç‰‡æ•°ç»„
            data.images = document.getElementById('images').value.split('\n').filter(url => url.trim());

            // å¤„ç†æ¥æºä¿¡æ¯
            if (data.sourceUrl) {
                data.source = {
                    name: 'æ‰‹åŠ¨æ·»åŠ ',
                    url: data.sourceUrl,
                    type: 'manual',
                    lastUpdated: new Date()
                };
            }

            // åˆ é™¤ä¸´æ—¶å­—æ®µ
            delete data.sourceUrl;
            delete data.fixedTime;
            delete data.tempDuration;

            try {
                const id = document.getElementById('itemId').value;
                const url = id ? `${API_BASE}/items/${id}` : `${API_BASE}/items`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æˆåŠŸæ¶ˆæ¯
                    const statusText = data.status === 'draft' ? 'è‰ç¨¿' : 'æ´»åŠ¨';
                    const message = id ? `âœ… ${statusText}æ›´æ–°æˆåŠŸ` : `âœ… ${statusText}åˆ›å»ºæˆåŠŸ`;

                    alert(message);
                    closeFormModal();
                    await loadItems();
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼š' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥');
            }
        });

        // ç­›é€‰äº‹ä»¶
        document.getElementById('categoryFilter').addEventListener('change', renderTable);
        document.getElementById('statusFilter').addEventListener('change', renderTable);

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('formModal').addEventListener('click', (e) => {
            if (e.target.id === 'formModal') {
                closeFormModal();
            }
        });

        // å·¥å…·å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'draft': 'è‰ç¨¿',
                'pending': 'å¾…å¼€å§‹',
                'ongoing': 'è¿›è¡Œä¸­',
                'expired': 'å·²è¿‡æœŸ',
                'active': 'æ´»è·ƒ' // å…¼å®¹æ—§æ•°æ®
            };
            return statusMap[status] || status;
        }

        // ä¿å­˜ä¸ºè‰ç¨¿æ ‡è®°
        let isSavingDraft = false;

        // ä¿å­˜ä¸ºè‰ç¨¿
        function submitFormAsDraft() {
            isSavingDraft = true; // è®¾ç½®è‰ç¨¿æ ‡è®°
            document.getElementById('status').value = 'draft'; // è®¾ç½®çŠ¶æ€ä¸ºè‰ç¨¿
            document.getElementById('dataForm').dispatchEvent(new Event('submit')); // è§¦å‘è¡¨å•æäº¤
        }

        // ========== å›¾ç‰‡æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½ ==========
        let uploadedImages = []; // å­˜å‚¨å·²ä¸Šä¼ çš„å›¾ç‰‡URL

        // åˆå§‹åŒ–ä¸Šä¼ åŒºåŸŸäº‹ä»¶ç›‘å¬
        function initImageUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            if (!uploadArea || !fileInput) return;

            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadArea.addEventListener('click', () => fileInput.click());

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // æ‹–æ‹½äº‹ä»¶
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleFiles(files) {
            const uploadProgress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const uploadStatus = document.getElementById('uploadStatus');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // éªŒè¯æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert(`${file.name} ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶`);
                    continue;
                }

                // éªŒè¯æ–‡ä»¶å¤§å° (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert(`${file.name} è¶…è¿‡5MBé™åˆ¶`);
                    continue;
                }

                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                uploadProgress.style.display = 'block';
                uploadStatus.textContent = `æ­£åœ¨ä¸Šä¼  ${file.name}...`;
                progressFill.style.width = '0%';

                try {
                    const imageUrl = await uploadImage(file, (percent) => {
                        progressFill.style.width = percent + '%';
                    });

                    if (imageUrl) {
                        uploadedImages.push(imageUrl);
                        displayImagePreview(imageUrl, uploadedImages.length - 1);
                        updateImagesTextarea();
                    }
                } catch (error) {
                    console.error('ä¸Šä¼ å¤±è´¥:', error);
                    alert(`${file.name} ä¸Šä¼ å¤±è´¥: ${error.message}`);
                }
            }

            // éšè—ä¸Šä¼ è¿›åº¦
            setTimeout(() => {
                uploadProgress.style.display = 'none';
                progressFill.style.width = '0%';
            }, 500);

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            document.getElementById('fileInput').value = '';
        }

        // ä¸Šä¼ å•ä¸ªå›¾ç‰‡
        async function uploadImage(file, progressCallback) {
            const formData = new FormData();
            formData.append('image', file);

            try {
                // æ¨¡æ‹Ÿè¿›åº¦
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        progressCallback(progress);
                    }
                }, 100);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressCallback(100);

                const result = await response.json();

                if (result.success) {
                    return result.data.url;
                } else {
                    throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                throw error;
            }
        }

        // ç›‘å¬æ‰‹åŠ¨è¾“å…¥çš„URLå˜åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initImageUpload();

            const textarea = document.getElementById('imageUrls');
            if (textarea) {
                textarea.addEventListener('input', updateImagesTextarea);
            }
        });
    </script>
</body>
</html>
