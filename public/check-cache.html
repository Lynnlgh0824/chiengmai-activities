<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼“å­˜é—®é¢˜è¯Šæ–­</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status-ok {
            color: #48bb78;
            font-weight: 600;
        }
        .status-error {
            color: #f56565;
            font-weight: 600;
        }
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ç¼“å­˜é—®é¢˜è¯Šæ–­</h1>

    <div class="card">
        <h2>é—®é¢˜è¯Šæ–­</h2>
        <button onclick="diagnose()">å¼€å§‹è¯Šæ–­</button>
        <div id="diagnosisResult"></div>
    </div>

    <div class="card">
        <h2>è§£å†³æ–¹æ¡ˆ</h2>
        <div id="solutions"></div>
    </div>

    <script>
        async function diagnose() {
            const resultDiv = document.getElementById('diagnosisResult');
            resultDiv.innerHTML = '<p>æ­£åœ¨æ£€æŸ¥...</p>';

            // 1. æ£€æŸ¥ä¸»é¡µé¢
            const response = await fetch('/index.html');
            const html = await response.text();

            // 2. æ£€æŸ¥æ˜¯å¦æœ‰é˜²å¾¡æ€§ä»£ç 
            const hasDefensiveCode = html.includes('allActivitiesä¸ºç©ºï¼Œ100msåé‡è¯•');

            // 3. æ£€æŸ¥åˆ†ç±»ç­›é€‰
            const categoryMatch = html.match(/<div class="filter-chips" id="categoryChips">([\s\S]*?)<\/div>/);
            let categoryCount = 0;
            if (categoryMatch) {
                categoryCount = (categoryMatch[1].match(/filter-chip/g) || []).length;
            }

            // ç”ŸæˆæŠ¥å‘Š
            let htmlOutput = '<h3>è¯Šæ–­ç»“æœ:</h3>';

            if (hasDefensiveCode) {
                htmlOutput += '<p>âœ… <span class="status-ok">æœåŠ¡å™¨ä»£ç æ˜¯æœ€æ–°çš„</span> - åŒ…å«é˜²å¾¡æ€§æ£€æŸ¥</p>';
            } else {
                htmlOutput += '<p>âŒ <span class="status-error">æœåŠ¡å™¨ä»£ç æ˜¯æ—§çš„</span> - éœ€è¦é‡æ–°éƒ¨ç½²</p>';
            }

            if (categoryCount > 1) {
                htmlOutput += `<p>âœ… <span class="status-ok">æœåŠ¡å™¨è¿”å›çš„åˆ†ç±»ç­›é€‰æ­£å¸¸</span> - å…±${categoryCount}ä¸ªé€‰é¡¹</p>`;
            } else {
                htmlOutput += `<p>âŒ <span class="status-error">æœåŠ¡å™¨è¿”å›çš„åˆ†ç±»ç­›é€‰å¼‚å¸¸</span> - åªæœ‰${categoryCount}ä¸ªé€‰é¡¹</p>`;
            }

            htmlOutput += '<hr style="margin: 15px 0;">';
            htmlOutput += '<h3>ç»“è®º:</h3>';

            if (hasDefensiveCode && categoryCount === 1) {
                htmlOutput += '<p><strong>è¿™æ˜¯æµè§ˆå™¨ç¼“å­˜é—®é¢˜ï¼</strong></p>';
                htmlOutput += '<p>æœåŠ¡å™¨ä»£ç æ˜¯æœ€æ–°çš„ï¼Œä½†æ‚¨çš„æµè§ˆå™¨æ˜¾ç¤ºçš„æ˜¯æ—§ç‰ˆæœ¬ã€‚</p>';
            } else if (!hasDefensiveCode) {
                htmlOutput += '<p><strong>æœåŠ¡å™¨ä»£ç éœ€è¦æ›´æ–°ï¼</strong></p>';
            } else {
                htmlOutput += '<p><strong>ç³»ç»Ÿæ­£å¸¸ï¼</strong></p>';
            }

            resultDiv.innerHTML = htmlOutput;

            // æ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ
            showSolutions(hasDefensiveCode && categoryCount === 1);
        }

        function showSolutions(isCacheProblem) {
            const solutionsDiv = document.getElementById('solutions');

            if (isCacheProblem) {
                solutionsDiv.innerHTML = `
                    <h3>âœ¨ å¿«é€Ÿè§£å†³æ–¹æ¡ˆ:</h3>
                    <p><strong>æ–¹æ³•1: å¼ºåˆ¶åˆ·æ–° (æ¨è)</strong></p>
                    <p>Mac: æŒ‰ <code>Cmd + Shift + R</code></p>
                    <p>Windows: æŒ‰ <code>Ctrl + Shift + R</code></p>
                    <p><strong>æ–¹æ³•2: æ¸…é™¤ç¼“å­˜</strong></p>
                    <p>1. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·</p>
                    <p>2. å³é”®ç‚¹å‡»åˆ·æ–°æŒ‰é’®</p>
                    <p>3. é€‰æ‹©"æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"</p>
                    <button onclick="window.location.href='/index.html?v=' + Date.now()">æ‰“å¼€å¸¦æ—¶é—´æˆ³çš„é¡µé¢</button>
                `;
            } else {
                solutionsDiv.innerHTML = `
                    <p>å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒã€‚</p>
                `;
            }
        }

        // è‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', () => {
            setTimeout(diagnose, 500);
        });
    </script>
</body>
</html>
