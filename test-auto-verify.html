<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨æµ‹è¯•ä¸ä¿®å¤ - ç§»åŠ¨ç«¯ä¼˜åŒ–</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .test-status {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-running { background: #cff4fc; color: #055160; }
        .status-pass { background: #d1e7dd; color: #0f5132; }
        .status-fail { background: #f8d7da; color: #842029; }

        .test-item {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #dee2e6;
            transition: all 0.3s ease;
        }
        .test-item.pass {
            border-left-color: #198754;
            background: #f0fff4;
        }
        .test-item.fail {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .test-item h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-icon {
            font-size: 20px;
        }

        .test-result {
            margin-top: 10px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .test-result.success {
            color: #198754;
        }
        .test-result.error {
            color: #dc3545;
        }
        .test-result.info {
            color: #0d6efd;
        }

        .actions {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }

        .summary {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #e7f3ff 0%, #f0f9ff 100%);
            border-radius: 12px;
            border: 2px solid #b8daff;
        }
        .summary h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }
        .summary-card {
            padding: 20px;
            background: white;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .summary-card .number {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .summary-card .label {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
        }

        .recommendations {
            margin-top: 30px;
            padding: 25px;
            background: #fff9e6;
            border-radius: 12px;
            border-left: 5px solid #ffc107;
        }
        .recommendations h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .recommendations ul {
            list-style: none;
            padding: 0;
        }
        .recommendations li {
            padding: 10px 0;
            color: #856404;
            padding-left: 25px;
            position: relative;
        }
        .recommendations li:before {
            content: "ğŸ’¡";
            position: absolute;
            left: 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinning {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ” ç§»åŠ¨ç«¯ä¼˜åŒ–è‡ªåŠ¨æµ‹è¯•ä¸ä¿®å¤ <span id="overallStatus" class="test-status status-pending">å¾…æµ‹è¯•</span></h1>
        <p class="subtitle">è‡ªåŠ¨æ£€æµ‹ç§»åŠ¨ç«¯ä¼˜åŒ–é—®é¢˜å¹¶æä¾›ä¿®å¤å»ºè®®</p>

        <div id="testResults"></div>

        <div class="actions">
            <button class="btn btn-primary" onclick="runAllTests()">
                <span id="runIcon">â–¶ï¸</span> å¼€å§‹è‡ªåŠ¨æµ‹è¯•
            </button>
            <button class="btn btn-secondary" onclick="window.location.reload()">
                ğŸ”„ é‡æ–°åŠ è½½
            </button>
            <button class="btn btn-secondary" onclick="exportResults()">
                ğŸ“¥ å¯¼å‡ºç»“æœ
            </button>
        </div>

        <div class="summary" id="summary" style="display: none;">
            <h2>ğŸ“Š æµ‹è¯•æ€»ç»“</h2>
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="number" id="passCount">0</div>
                    <div class="label">é€šè¿‡æµ‹è¯•</div>
                </div>
                <div class="summary-card">
                    <div class="number" id="failCount">0</div>
                    <div class="label">å¤±è´¥æµ‹è¯•</div>
                </div>
                <div class="summary-card">
                    <div class="number" id="passRate">0%</div>
                    <div class="label">é€šè¿‡ç‡</div>
                </div>
            </div>
        </div>

        <div class="recommendations" id="recommendations" style="display: none;">
            <h3>ğŸ’¡ ä¿®å¤å»ºè®®</h3>
            <ul id="recommendationsList"></ul>
        </div>
    </div>

    <script>
        let testResults = [];

        const tests = [
            {
                name: '1. Tabé¡¶éƒ¨ç©ºç™½ä¼˜åŒ–',
                check: async () => {
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '375px';
                    iframe.style.height = '812px';
                    iframe.style.position = 'absolute';
                    iframe.style.left = '-9999px';
                    document.body.appendChild(iframe);

                    try {
                        const response = await fetch(window.location.href.replace('test-auto-verify.html', 'index.html'));
                        const html = await response.text();
                        iframe.srcdoc = html;
                        await new Promise(resolve => setTimeout(resolve, 2000));

                        const doc = iframe.contentDocument || iframe.contentWindow.document;
                        let tabPane = doc.querySelector('.tab-pane.active') || doc.querySelector('.tab-pane');

                        document.body.removeChild(iframe);

                        if (!tabPane) {
                            const hasOptimization = html.includes('padding-top: var(--space-tab-padding-std)');
                            if (hasOptimization) {
                                return {
                                    success: true,
                                    message: 'âœ“ CSSè§„åˆ™å­˜åœ¨: padding-top: 120px (DOMæœªå®Œå…¨åŠ è½½)',
                                    recommendation: null
                                };
                            }
                            return {
                                success: false,
                                message: 'âœ— æœªæ‰¾åˆ°ä¼˜åŒ–è§„åˆ™',
                                recommendation: 'éœ€è¦åœ¨ @media (max-width: 768px) ä¸­æ·»åŠ  .tab-pane { padding-top: var(--space-tab-padding-std) !important; }'
                            };
                        }

                        const computedStyle = iframe.contentWindow.getComputedStyle(tabPane);
                        const paddingTop = parseInt(computedStyle.paddingTop) || 0;

                        if (paddingTop <= 125) {
                            return {
                                success: true,
                                message: `âœ“ Tabé¡¶éƒ¨padding: ${paddingTop}px (ç›®æ ‡: â‰¤125px)`,
                                recommendation: null
                            };
                        } else {
                            return {
                                success: false,
                                message: `âœ— Tabé¡¶éƒ¨padding: ${paddingTop}px (ç›®æ ‡: â‰¤125px)`,
                                recommendation: `éœ€è¦å°† .tab-pane çš„ padding-top ä» ${paddingTop}px å‡å°‘åˆ°çº¦120px (ä½¿ç”¨CSSå˜é‡ var(--space-tab-padding-std))`
                            };
                        }
                    } catch (error) {
                        document.body.removeChild(iframe);
                        return {
                            success: false,
                            message: `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`,
                            recommendation: 'æ£€æŸ¥é¡µé¢åŠ è½½å’Œiframeè®¿é—®æƒé™'
                        };
                    }
                }
            },
            {
                name: '2. ç§»åŠ¨ç«¯é—´è·ä¼˜åŒ–',
                check: async () => {
                    const response = await fetch('http://localhost:3000');
                    const html = await response.text();

                    const checks = [
                        { name: 'Container (CSSå˜é‡)', pattern: /\.container\s*{[^}]*padding-left:\s*var\(--space-sm\)/s },
                        { name: 'Filter section (CSSå˜é‡)', pattern: /\.filter-section\s*{[^}]*padding:\s*var\(--space-md\)\s+var\(--space-lg\)/s },
                        { name: 'Results count (CSSå˜é‡)', pattern: /\.results-count\s*{[^}]*padding:\s*var\(--space-mobile-md\)\s+var\(--space-sm\)/s },
                        { name: 'Day cell (CSSå˜é‡)', pattern: /\.day-cell\s*{[^}]*padding:\s*var\(--space-sm\)/s },
                        { name: 'Activity chip (CSSå˜é‡)', pattern: /\.activity-chip\s*{[^}]*padding:\s*var\(--space-mobile-sm\)\s+var\(--space-xs\)/s }
                    ];

                    const results = [];
                    for (const check of checks) {
                        const found = check.pattern.test(html);
                        results.push(`${found ? 'âœ“' : 'âœ—'} ${check.name}`);
                    }

                    const passCount = results.filter(r => r.includes('âœ“')).length;
                    const allPassed = passCount === checks.length;

                    if (allPassed) {
                        return {
                            success: true,
                            message: `âœ“ æ‰€æœ‰é—´è·ä¼˜åŒ–å·²åº”ç”¨ (${passCount}/${checks.length})`,
                            recommendation: null
                        };
                    } else {
                        return {
                            success: false,
                            message: `âš ï¸ éƒ¨åˆ†é—´è·ä¼˜åŒ–ç¼ºå¤± (${passCount}/${checks.length}):\n${results.join('\n')}`,
                            recommendation: passCount < checks.length ?
                                'éœ€è¦åœ¨ @media (max-width: 768px) ä¸­æ·»åŠ ç¼ºå¤±çš„é—´è·ä¼˜åŒ–CSSè§„åˆ™' :
                                null
                        };
                    }
                }
            },
            {
                name: '3. æ»šåŠ¨æ—¥æœŸé«˜äº®åŠŸèƒ½',
                check: async () => {
                    const response = await fetch('http://localhost:3000');
                    const html = await response.text();

                    const functions = [
                        'function initH5ScrollDateHighlight',
                        'function highlightDateInView',
                        'function updateDateHighlight'
                    ];

                    const missingFunctions = functions.filter(fn => !html.includes(fn));

                    if (missingFunctions.length === 0) {
                        return {
                            success: true,
                            message: 'âœ“ æ‰€æœ‰æ»šåŠ¨æ—¥æœŸé«˜äº®å‡½æ•°å·²å®ç°',
                            recommendation: null
                        };
                    } else {
                        return {
                            success: false,
                            message: `âœ— ç¼ºå°‘å‡½æ•°: ${missingFunctions.join(', ')}`,
                            recommendation: 'éœ€è¦å®ç° initH5ScrollDateHighlightã€highlightDateInView å’Œ updateDateHighlight å‡½æ•°'
                        };
                    }
                }
            },
            {
                name: '4. ç§»åŠ¨ç«¯åª’ä½“æŸ¥è¯¢',
                check: async () => {
                    const response = await fetch('http://localhost:3000');
                    const html = await response.text();

                    const checks = [
                        { name: 'ç§»åŠ¨ç«¯é—´è·ä¼˜åŒ–æ³¨é‡Š', pattern: /ç§»åŠ¨ç«¯é—´è·ä¼˜åŒ–/i },
                        { name: 'Tabé¡¶éƒ¨ç©ºç™½(CSSå˜é‡)', pattern: /tab-pane[\s\S]*padding-top[\s\S]*var\(--space-tab-padding-std\)/s },
                        { name: 'Container padding(CSSå˜é‡)', pattern: /container[\s\S]*padding-left[\s\S]*var\(--space-sm\)/s }
                    ];

                    const results = checks.map(check => {
                        const found = check.pattern.test(html);
                        return `${found ? 'âœ“' : 'âœ—'} ${check.name}`;
                    });

                    const allPassed = results.every(r => r.includes('âœ“'));

                    if (allPassed) {
                        return {
                            success: true,
                            message: 'âœ“ æ‰€æœ‰ç§»åŠ¨ç«¯åª’ä½“æŸ¥è¯¢é…ç½®æ­£ç¡®',
                            recommendation: null
                        };
                    } else {
                        return {
                            success: false,
                            message: `âœ— éƒ¨åˆ†åª’ä½“æŸ¥è¯¢ç¼ºå¤±:\n${results.join('\n')}`,
                            recommendation: 'ç¡®ä¿æ‰€æœ‰ç§»åŠ¨ç«¯ä¼˜åŒ–éƒ½åœ¨ @media (max-width: 768px) å—å†…'
                        };
                    }
                }
            },
            {
                name: '5. CSSæ ·å¼æœ‰æ•ˆæ€§',
                check: async () => {
                    const response = await fetch('http://localhost:3000');
                    const html = await response.text();

                    const importantCount = (html.match(/!important/g) || []).length;
                    const hasMobileSpacingInMedia = /@media[^{]*{[\s\S]*ç§»åŠ¨ç«¯é—´è·ä¼˜åŒ–/.test(html);

                    if (hasMobileSpacingInMedia && importantCount <= 150) {
                        return {
                            success: true,
                            message: `âœ“ CSSè¯­æ³•æ­£å¸¸ï¼Œ!importantä½¿ç”¨: ${importantCount} å¤„`,
                            recommendation: null
                        };
                    } else {
                        return {
                            success: false,
                            message: `âš ï¸ CSSé—®é¢˜:\n${!hasMobileSpacingInMedia ? 'âœ— ç§»åŠ¨ç«¯é—´è·ä¼˜åŒ–ä¸åœ¨@mediaå—å†…\n' : ''}${importantCount > 150 ? `âš ï¸ !importantè¿‡å¤š: ${importantCount} å¤„` : `âœ“ !important: ${importantCount} å¤„`}`,
                            recommendation: !hasMobileSpacingInMedia ?
                                'éœ€è¦å°†ç§»åŠ¨ç«¯é—´è·ä¼˜åŒ–CSSç§»åŠ¨åˆ° @media (max-width: 768px) å—å†…' :
                                importantCount > 150 ? 'å»ºè®®å‡å°‘ !important çš„ä½¿ç”¨ï¼Œè€ƒè™‘ä½¿ç”¨CSSå˜é‡' : null
                        };
                    }
                }
            },
            {
                name: '6. CSSå˜é‡ç³»ç»Ÿ',
                check: async () => {
                    const response = await fetch('http://localhost:3000');
                    const html = await response.text();

                    const checks = [
                        { name: 'CSSå˜é‡ç³»ç»Ÿå®šä¹‰', pattern: /\/\*\s*=\s*CSSå˜é‡ç³»ç»Ÿ\s*=\s*\*\// },
                        { name: 'space-små®šä¹‰', pattern: /--space-sm:\s*8px/ },
                        { name: 'space-mdå®šä¹‰', pattern: /--space-md:\s*12px/ },
                        { name: 'space-lgå®šä¹‰', pattern: /--space-lg:\s*16px/ },
                        { name: 'ç§»åŠ¨ç«¯å˜é‡è¦†ç›–', pattern: /--space-sm:\s*var\(--space-mobile-sm\)/ }
                    ];

                    const results = checks.map(check => {
                        const found = check.pattern.test(html);
                        return `${found ? 'âœ“' : 'âœ—'} ${check.name}`;
                    });

                    const passCount = results.filter(r => r.includes('âœ“')).length;

                    if (passCount === checks.length) {
                        return {
                            success: true,
                            message: `âœ“ CSSå˜é‡ç³»ç»Ÿå®Œæ•´ (${passCount}/${checks.length}é¡¹é€šè¿‡)`,
                            recommendation: null
                        };
                    } else {
                        return {
                            success: false,
                            message: `âš ï¸ CSSå˜é‡ç³»ç»Ÿä¸å®Œæ•´ (${passCount}/${checks.length}é¡¹é€šè¿‡):\n${results.join('\n')}`,
                            recommendation: 'éœ€è¦ç¡®ä¿CSSå˜é‡ç³»ç»Ÿå®Œæ•´å®šä¹‰ï¼ŒåŒ…æ‹¬spacing scaleå’Œç§»åŠ¨ç«¯è¦†ç›–'
                        };
                    }
                }
            },
            {
                name: '7. ç§»åŠ¨ç«¯è§†å›¾å…ƒæ•°æ®',
                check: async () => {
                    const response = await fetch('http://localhost:3000');
                    const html = await response.text();

                    const checks = [
                        { name: 'viewport metaæ ‡ç­¾', pattern: /<meta[^>]*viewport[^>]*>/i },
                        { name: 'ç§»åŠ¨ç«¯é€‚é…meta', pattern: /<meta[^>]*width=device-width[^>]*>/i }
                    ];

                    const results = checks.map(check => {
                        const found = check.pattern.test(html);
                        return `${found ? 'âœ“' : 'âœ—'} ${check.name}`;
                    });

                    const allPassed = results.every(r => r.includes('âœ“'));

                    if (allPassed) {
                        return {
                            success: true,
                            message: 'âœ“ ç§»åŠ¨ç«¯è§†å›¾å…ƒæ•°æ®é…ç½®æ­£ç¡®',
                            recommendation: null
                        };
                    } else {
                        return {
                            success: false,
                            message: `âœ— ç¼ºå°‘å¿…è¦çš„metaæ ‡ç­¾:\n${results.join('\n')}`,
                            recommendation: 'åœ¨ <head> ä¸­æ·»åŠ  <meta name="viewport" content="width=device-width, initial-scale=1.0">'
                        };
                    }
                }
            }
        ];

        async function runAllTests() {
            const resultsDiv = document.getElementById('testResults');
            const summaryDiv = document.getElementById('summary');
            const recommendationsDiv = document.getElementById('recommendations');
            const overallStatus = document.getElementById('overallStatus');
            const runIcon = document.getElementById('runIcon');

            // é‡ç½®çŠ¶æ€
            resultsDiv.innerHTML = '';
            summaryDiv.style.display = 'none';
            recommendationsDiv.style.display = 'none';
            testResults = [];

            overallStatus.className = 'test-status status-running';
            overallStatus.textContent = 'æµ‹è¯•ä¸­';
            runIcon.classList.add('spinning');
            runIcon.textContent = 'â³';

            let passCount = 0;
            let failCount = 0;
            const recommendations = new Set();

            // æ·»åŠ è¿›åº¦æ¡
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressBar.innerHTML = '<div class="progress-fill" style="width: 0%"></div>';
            resultsDiv.appendChild(progressBar);

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                const testDiv = document.createElement('div');
                testDiv.className = 'test-item';

                // æ›´æ–°è¿›åº¦
                const progress = ((i + 1) / tests.length) * 100;
                progressBar.querySelector('.progress-fill').style.width = progress + '%';

                const result = await test.check();
                testResults.push({ name: test.name, ...result });

                if (result.success) {
                    passCount++;
                    testDiv.classList.add('pass');
                } else {
                    failCount++;
                    testDiv.classList.add('fail');
                }

                if (result.recommendation) {
                    recommendations.add(result.recommendation);
                }

                testDiv.innerHTML = `
                    <h3>
                        <span class="test-icon">${result.success ? 'âœ…' : 'âŒ'}</span>
                        ${test.name}
                    </h3>
                    <div class="test-result ${result.success ? 'success' : 'error'}">${result.message}</div>
                `;

                resultsDiv.appendChild(testDiv);
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            // ç§»é™¤è¿›åº¦æ¡
            progressBar.remove();

            // æ›´æ–°æ€»ç»“
            document.getElementById('passCount').textContent = passCount;
            document.getElementById('failCount').textContent = failCount;
            document.getElementById('passRate').textContent = Math.round((passCount / tests.length) * 100) + '%';

            summaryDiv.style.display = 'block';

            // æ˜¾ç¤ºå»ºè®®
            if (recommendations.size > 0) {
                const recList = document.getElementById('recommendationsList');
                recList.innerHTML = '';
                recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.textContent = rec;
                    recList.appendChild(li);
                });
                recommendationsDiv.style.display = 'block';
            }

            // æ›´æ–°æ•´ä½“çŠ¶æ€
            runIcon.classList.remove('spinning');
            if (failCount === 0) {
                overallStatus.className = 'test-status status-pass';
                overallStatus.textContent = 'å…¨éƒ¨é€šè¿‡';
                runIcon.textContent = 'âœ…';
            } else {
                overallStatus.className = 'test-status status-fail';
                overallStatus.textContent = `${failCount} ä¸ªå¤±è´¥`;
                runIcon.textContent = 'âš ï¸';
            }
        }

        function exportResults() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: testResults.length,
                    passed: testResults.filter(r => r.success).length,
                    failed: testResults.filter(r => !r.success).length
                },
                results: testResults
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-results-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>
