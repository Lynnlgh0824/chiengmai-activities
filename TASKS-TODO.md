# Chiengmai 项目待办清单

## 📅 创建时间：2026-01-26

---

## 🎯 任务1: Excel与后台数据同步功能

**状态**: ❌ **已取消 - 不需要优化**

> 用户确认：Excel导出功能不用优化（2026-01-28）

### 📋 原待办事项（已取消）

#### ~~1.1 后台 → Excel 导出功能~~
- [ ] **创建导出脚本** `scripts/export-json-to-excel.mjs`
  - [ ] 读取 `data/items.json` 数据
  - [ ] 按活动编号排序
  - [ ] 定义18列的标准格式
  - [ ] 处理星期数组转换为逗号分隔字符串
  - [ ] 设置合适的列宽
  - [ ] 保存为Excel文件
  - [ ] 添加时间戳避免文件覆盖

- [ ] **添加npm脚本**
  ```json
  "export-json-to-excel": "node scripts/export-json-to-excel.mjs"
  ```

- [ ] **测试验证**
  - [ ] 导出19个活动
  - [ ] 验证所有列格式正确
  - [ ] 验证中文显示正常
  - [ ] 验证ID不显示为科学计数法
  - [ ] 验证星期字段格式

#### 1.2 数据验证框架
- [ ] **创建验证模块** `scripts/lib/validator.mjs`
  - [ ] 定义必填字段规则（title, category）
  - [ ] 定义分类枚举值
  - [ ] 定义价格格式验证
  - [ ] 定义时间格式验证
  - [ ] 实现验证函数

- [ ] **集成到导出流程**
  - [ ] 导入前验证Excel数据
  - [ ] 输出验证错误报告
  - [ ] 跳过无效数据或使用默认值

- [ ] **测试验证**
  - [ ] 测试缺少title的数据
  - [ ] 测试无效分类
  - [ ] 测试错误的价格格式
  - [ ] 测试所有边界情况

#### 1.3 冲突检测与解决
- [ ] **实现时间戳比较**
  - [ ] 在数据中添加 `updatedAt` 字段
  - [ ] 比较Excel和后台的修改时间
  - [ ] 自动选择最新版本

- [ ] **实现字段级别合并**
  - [ ] 比较每个字段的差异
  - [ ] 合并非冲突字段
  - [ ] 标记冲突字段

- [ ] **创建冲突报告**
  - [ ] 记录所有冲突项
  - [ ] 显示Excel和后台的值
  - [ ] 保存到日志文件

- [ ] **测试场景**
  - [ ] 同一活动同时修改不同字段
  - [ ] 同一活动同时修改相同字段
  - [ ] Excel新增活动，后台已删除
  - [ ] Excel删除活动，后台已修改

#### 1.4 活动编号自动管理
- [ ] **实现自动编号功能**
  - [ ] 检测最大活动编号
  - [ ] 自动分配新编号
  - [ ] 处理编号冲突

- [ ] **创建重新编号脚本** `scripts/renumber-activities.mjs`
  - [ ] 扫描所有活动
  - [ ] 按sortOrder重新编号
  - [ ] 更新Excel和JSON

- [ ] **测试**
  - [ ] 新增活动自动编号
  - [ ] 删除中间编号后重新编号
  - [ ] 批量导入时编号冲突

#### 1.5 变更日志系统
- [ ] **创建日志模块** `scripts/lib/change-logger.mjs`
  - [ ] 记录每次导入操作
  - [ ] 记录新增活动
  - [ ] 记录修改字段
  - [ ] 记录删除活动
  - [ ] 生成对比报告

- [ ] **日志文件管理**
  - [ ] 按日期命名日志文件
  - [ ] 保留最近30天日志
  - [ ] 提供日志查询功能

#### 1.6 文件监听自动化
- [ ] **安装依赖**
  ```bash
  npm install --save-dev chokidar
  ```

- [ ] **创建监听脚本** `scripts/watch-excel.mjs`
  - [ ] 监听Excel文件变化
  - [ ] 延迟触发导入（避免频繁触发）
  - [ ] 显示导入进度
  - [ ] 错误处理和重试

- [ ] **添加npm脚本**
  ```json
  "watch": "node scripts/watch-excel.mjs"
  ```

#### 1.7 Web界面集成（可选）
- [ ] **在admin.html添加导入导出按钮**
  - [ ] "导出为Excel" 按钮
  - [ ] "从Excel导入" 按钮
  - [ ] 进度显示
  - [ ] 错误提示

- [ ] **后台API支持**
  - [ ] POST `/api/export-excel` - 导出Excel
  - [ ] POST `/api/import-excel` - 导入Excel
  - [ ] GET `/api/import-status` - 查询导入状态

---

## 🚀 任务2: 部署到免费环境

### 📋 待办事项

#### 2.1 环境调研与选择
- [ ] **调研免费部署平台**
  - [ ] **Vercel** (推荐)
    - 优点：自动HTTPS、全球CDN、零配置
    - 限制：Serverless函数限制、构建时间限制
    - 适合：前端静态站点

  - [ ] **Netlify** (备选)
    - 优点：拖拽部署、Form处理
    - 限制：带宽限制、构建分钟限制
    - 适合：静态网站

  - [ ] **Render** (推荐)
    - 优点：免费托管Node.js、PostgreSQL
    - 限制：休眠15分钟、512MB内存
    - 适合：后端API服务

  - [ ] **Railway** (备选)
    - 优点：简单配置、自动部署
    - 限制：$5免费额度
    - 适合：全栈应用

  - [ ] **Fly.io** (备选)
    - 优点：全球部署、Docker支持
    - 限制：3个小型VM
    - 适合：容器化应用

- [ ] **确定部署方案**
  - [ ] 方案A: Vercel (前端) + Render (后端)
  - [ ] 方案B: Netlify (前端) + Railway (后端)
  - [ ] 方案C: Vercel (前后端一体化)

#### 2.2 项目准备
- [ ] **代码检查**
  - [ ] 移除硬编码的本地路径
  - [ ] 确保环境变量使用正确
  - [ ] 检查所有API路径
  - [ ] 验证静态资源路径

- [ ] **配置文件创建**
  - [ ] 创建 `.env.example` 文件
  - [ ] 创建 `vercel.json` 配置
  - [ ] 创建 `render.yaml` 或 `Dockerfile`

- [ ] **依赖优化**
  - [ ] 移除开发依赖（如果不需要）
  - [ ] 检查包大小
  - [ ] 优化启动脚本

#### 2.3 Vercel部署（前端）
- [ ] **安装Vercel CLI**
  ```bash
  npm install -g vercel
  ```

- [ ] **创建vercel.json配置**
  ```json
  {
    "version": 2,
    "builds": [
      {
        "src": "public/**/*",
        "use": "@vercel/static"
      }
    ],
    "routes": [
      {
        "src": "/(.*)",
        "dest": "/public/$1"
      }
    ]
  }
  ```

- [ ] **部署流程**
  - [ ] 登录Vercel账号
  - [ ] 连接GitHub仓库
  - [ ] 配置构建命令
  - [ ] 配置输出目录
  - [ ] 首次部署
  - [ ] 配置自定义域名（可选）

- [ ] **环境变量配置**
  - [ ] API_BASE_URL
  - [ ] 其他配置项

#### 2.4 Render部署（后端）
- [ ] **准备部署文件**
  - [ ] 创建 `render.yaml`
    ```yaml
    services:
      - type: web
        name: chiengmai-backend
        env: node
        buildCommand: npm install
        startCommand: npm start
        envVars:
          - key: NODE_ENV
            value: production
          - key: PORT
            value: 3000
    ```

- [ ] **部署流程**
  - [ ] 注册Render账号
  - [ ] 连接GitHub仓库
  - [ ] 选择 "Web Service"
  - [ ] 配置构建和启动命令
  - [ ] 配置环境变量
  - [ ] 部署
  - [ ] 获取后端URL

- [ ] **配置数据库（如果需要）**
  - [ ] 创建PostgreSQL实例
  - [ ] 获取连接字符串
  - [ ] 更新环境变量

#### 2.5 CORS和安全配置
- [ ] **配置CORS**
  - [ ] 允许前端域名
  - [ ] 配置允许的HTTP方法
  - [ ] 配置请求头

- [ ] **安全加固**
  - [ ] 添加Helmet中间件
  - [ ] 配置速率限制
  - [ ] 添加CSRF保护
  - [ ] 配置HTTPS强制

#### 2.6 数据持久化
- [ ] **选择存储方案**
  - [ ] 方案A: Render PostgreSQL（推荐）
  - [ ] 方案B: MongoDB Atlas免费层
  - [ ] 方案C: 文件存储 + 定期备份

- [ ] **数据库迁移**
  - [ ] 创建数据库连接模块
  - [ ] 编写迁移脚本
  - [ ] 导入现有数据
  - [ ] 验证数据完整性

- [ ] **备份策略**
  - [ ] 自动每日备份
  - [ ] 备份到云存储
  - [ ] 测试恢复流程

#### 2.7 测试与验证
- [ ] **功能测试**
  - [ ] 测试API端点
  - [ ] 测试前端页面加载
  - [ ] 测试跨域请求
  - [ ] 测试文件上传（如果有）

- [ ] **性能测试**
  - [ ] 测试页面加载速度
  - [ ] 测试API响应时间
  - [ ] 测试并发请求
  - [ ] 优化慢查询

- [ ] **监控配置**
  - [ ] 配置日志收集
  - [ ] 配置错误追踪（Sentry）
  - [ ] 配置性能监控
  - [ ] 配置健康检查

#### 2.8 域名和HTTPS
- [ ] **域名配置（可选）**
  - [ ] 购买域名
  - [ ] 配置DNS记录
  - [ ] 配置子域名
  - [ ] 验证域名所有权

- [ ] **SSL证书**
  - [ ] Vercel自动HTTPS（已包含）
  - [ ] Render自动HTTPS（已包含）
  - [ ] 验证证书有效

#### 2.9 文档和运维
- [ ] **编写部署文档**
  - [ ] 部署步骤说明
  - [ ] 环境变量说明
  - [ ] 更新部署流程
  - [ ] 回滚流程

- [ ] **创建运维脚本**
  - [ ] 数据库备份脚本
  - [ ] 日志清理脚本
  - [ ] 健康检查脚本

---

## 📊 任务优先级

### 🔴 高优先级（本周完成）
1. 后台 → Excel 导出功能
2. 数据验证框架
3. Vercel部署前端
4. Render部署后端
5. CORS配置

### 🟡 中优先级（下周完成）
6. 冲突检测与解决
7. 活动编号自动管理
8. 变更日志系统
9. 数据库迁移
10. 性能测试和优化

### 🟢 低优先级（后续完成）
11. 文件监听自动化
12. Web界面集成
13. 监控和告警
14. 域名配置
15. 备份自动化

---

## 📝 学习清单

### Excel同步相关
- [ ] XLSX库高级用法
- [ ] 文件系统API（fs.promises）
- [ ] 文件监听（chokidar）
- [ ] 数据验证最佳实践
- [ ] 冲突解决策略

### 部署相关
- [ ] Vercel平台文档
- [ ] Render平台文档
- [ ] Docker基础（如果需要）
- [ ] PostgreSQL基础（如果使用）
- [ ] CORS配置
- [ ] 环境变量管理
- [ ] CI/CD基础

### 安全相关
- [ ] Helmet.js安全头
- [ ] 速率限制
- [ ] CSRF防护
- [ ] SQL注入防护
- [ ] XSS防护

---

## 🎯 本周目标

### 必须完成
- [x] Excel格式规范化
- [x] 备份管理优化
- [ ] 后台 → Excel导出功能
- [ ] 前端部署到Vercel
- [ ] 后端部署到Render
- [ ] 基础测试通过

### 争取完成
- [ ] 数据验证框架
- [ ] 冲突检测功能
- [ ] 域名配置
- [ ] 监控配置

---

## 📚 参考资源

### 官方文档
- [Vercel文档](https://vercel.com/docs)
- [Render文档](https://render.com/docs)
- [SheetJS (XLSX)文档](https://docs.sheetjs.com/)
- [Express.js文档](https://expressjs.com/)

### 学习资源
- [免费部署平台对比](https://www.freecodecamp.org/news/free-hosting-for-developers/)
- [Node.js最佳实践](https://github.com/goldbergyoni/nodebestpractices)
- [环境变量管理](https://dotenv.org/)

---

## 💡 注意事项

1. **备份优先**
   - 每次操作前备份数据
   - 保留最近3个版本

2. **渐进式部署**
   - 先本地测试通过
   - 再部署到测试环境
   - 最后部署到生产环境

3. **文档同步**
   - 边开发边写文档
   - 记录遇到的问题
   - 总结解决方案

4. **代码质量**
   - 添加错误处理
   - 添加日志记录
   - 添加代码注释

---

## ✅ 完成记录

### 2026-01-26
- [x] Excel格式规范化（18列）
- [x] 统一备份文件管理
- [x] 删除活动0002
- [x] 更新字段映射
- [x] 创建Excel同步分析文档
- [x] 创建待办清单

---

*最后更新：2026-01-26*
